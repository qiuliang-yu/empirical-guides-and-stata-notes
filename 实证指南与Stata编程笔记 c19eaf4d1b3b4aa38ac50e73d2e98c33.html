<html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><title>实证指南与Stata编程笔记</title><style>
/* cspell:disable-file */
/* webkit printing magic: print all background colors */
html {
	-webkit-print-color-adjust: exact;
}
* {
	box-sizing: border-box;
	-webkit-print-color-adjust: exact;
}

html,
body {
	margin: 0;
	padding: 0;
}
@media only screen {
	body {
		margin: 2em auto;
		max-width: 900px;
		color: rgb(55, 53, 47);
	}
}

body {
	line-height: 1.5;
	white-space: pre-wrap;
}

a,
a.visited {
	color: inherit;
	text-decoration: underline;
}

.pdf-relative-link-path {
	font-size: 80%;
	color: #444;
}

h1,
h2,
h3 {
	letter-spacing: -0.01em;
	line-height: 1.2;
	font-weight: 600;
	margin-bottom: 0;
}

.page-title {
	font-size: 2.5rem;
	font-weight: 700;
	margin-top: 0;
	margin-bottom: 0.75em;
}

h1 {
	font-size: 1.875rem;
	margin-top: 1.875rem;
}

h2 {
	font-size: 1.5rem;
	margin-top: 1.5rem;
}

h3 {
	font-size: 1.25rem;
	margin-top: 1.25rem;
}

.source {
	border: 1px solid #ddd;
	border-radius: 3px;
	padding: 1.5em;
	word-break: break-all;
}

.callout {
	border-radius: 3px;
	padding: 1rem;
}

figure {
	margin: 1.25em 0;
	page-break-inside: avoid;
}

figcaption {
	opacity: 0.5;
	font-size: 85%;
	margin-top: 0.5em;
}

mark {
	background-color: transparent;
}

.indented {
	padding-left: 1.5em;
}

hr {
	background: transparent;
	display: block;
	width: 100%;
	height: 1px;
	visibility: visible;
	border: none;
	border-bottom: 1px solid rgba(55, 53, 47, 0.09);
}

img {
	max-width: 100%;
}

@media only print {
	img {
		max-height: 100vh;
		object-fit: contain;
	}
}

@page {
	margin: 1in;
}

.collection-content {
	font-size: 0.875rem;
}

.column-list {
	display: flex;
	justify-content: space-between;
}

.column {
	padding: 0 1em;
}

.column:first-child {
	padding-left: 0;
}

.column:last-child {
	padding-right: 0;
}

.table_of_contents-item {
	display: block;
	font-size: 0.875rem;
	line-height: 1.3;
	padding: 0.125rem;
}

.table_of_contents-indent-1 {
	margin-left: 1.5rem;
}

.table_of_contents-indent-2 {
	margin-left: 3rem;
}

.table_of_contents-indent-3 {
	margin-left: 4.5rem;
}

.table_of_contents-link {
	text-decoration: none;
	opacity: 0.7;
	border-bottom: 1px solid rgba(55, 53, 47, 0.18);
}

table,
th,
td {
	border: 1px solid rgba(55, 53, 47, 0.09);
	border-collapse: collapse;
}

table {
	border-left: none;
	border-right: none;
}

th,
td {
	font-weight: normal;
	padding: 0.25em 0.5em;
	line-height: 1.5;
	min-height: 1.5em;
	text-align: left;
}

th {
	color: rgba(55, 53, 47, 0.6);
}

ol,
ul {
	margin: 0;
	margin-block-start: 0.6em;
	margin-block-end: 0.6em;
}

li > ol:first-child,
li > ul:first-child {
	margin-block-start: 0.6em;
}

ul > li {
	list-style: disc;
}

ul.to-do-list {
	padding-inline-start: 0;
}

ul.to-do-list > li {
	list-style: none;
}

.to-do-children-checked {
	text-decoration: line-through;
	opacity: 0.375;
}

ul.toggle > li {
	list-style: none;
}

ul {
	padding-inline-start: 1.7em;
}

ul > li {
	padding-left: 0.1em;
}

ol {
	padding-inline-start: 1.6em;
}

ol > li {
	padding-left: 0.2em;
}

.mono ol {
	padding-inline-start: 2em;
}

.mono ol > li {
	text-indent: -0.4em;
}

.toggle {
	padding-inline-start: 0em;
	list-style-type: none;
}

/* Indent toggle children */
.toggle > li > details {
	padding-left: 1.7em;
}

.toggle > li > details > summary {
	margin-left: -1.1em;
}

.selected-value {
	display: inline-block;
	padding: 0 0.5em;
	background: rgba(206, 205, 202, 0.5);
	border-radius: 3px;
	margin-right: 0.5em;
	margin-top: 0.3em;
	margin-bottom: 0.3em;
	white-space: nowrap;
}

.collection-title {
	display: inline-block;
	margin-right: 1em;
}

.page-description {
    margin-bottom: 2em;
}

.simple-table {
	margin-top: 1em;
	font-size: 0.875rem;
	empty-cells: show;
}
.simple-table td {
	height: 29px;
	min-width: 120px;
}

.simple-table th {
	height: 29px;
	min-width: 120px;
}

.simple-table-header-color {
	background: rgb(247, 246, 243);
	color: black;
}
.simple-table-header {
	font-weight: 500;
}

time {
	opacity: 0.5;
}

.icon {
	display: inline-block;
	max-width: 1.2em;
	max-height: 1.2em;
	text-decoration: none;
	vertical-align: text-bottom;
	margin-right: 0.5em;
}

img.icon {
	border-radius: 3px;
}

.user-icon {
	width: 1.5em;
	height: 1.5em;
	border-radius: 100%;
	margin-right: 0.5rem;
}

.user-icon-inner {
	font-size: 0.8em;
}

.text-icon {
	border: 1px solid #000;
	text-align: center;
}

.page-cover-image {
	display: block;
	object-fit: cover;
	width: 100%;
	max-height: 30vh;
}

.page-header-icon {
	font-size: 3rem;
	margin-bottom: 1rem;
}

.page-header-icon-with-cover {
	margin-top: -0.72em;
	margin-left: 0.07em;
}

.page-header-icon img {
	border-radius: 3px;
}

.link-to-page {
	margin: 1em 0;
	padding: 0;
	border: none;
	font-weight: 500;
}

p > .user {
	opacity: 0.5;
}

td > .user,
td > time {
	white-space: nowrap;
}

input[type="checkbox"] {
	transform: scale(1.5);
	margin-right: 0.6em;
	vertical-align: middle;
}

p {
	margin-top: 0.5em;
	margin-bottom: 0.5em;
}

.image {
	border: none;
	margin: 1.5em 0;
	padding: 0;
	border-radius: 0;
	text-align: center;
}

.code,
code {
	background: rgba(135, 131, 120, 0.15);
	border-radius: 3px;
	padding: 0.2em 0.4em;
	border-radius: 3px;
	font-size: 85%;
	tab-size: 2;
}

code {
	color: #eb5757;
}

.code {
	padding: 1.5em 1em;
}

.code-wrap {
	white-space: pre-wrap;
	word-break: break-all;
}

.code > code {
	background: none;
	padding: 0;
	font-size: 100%;
	color: inherit;
}

blockquote {
	font-size: 1.25em;
	margin: 1em 0;
	padding-left: 1em;
	border-left: 3px solid rgb(55, 53, 47);
}

.bookmark {
	text-decoration: none;
	max-height: 8em;
	padding: 0;
	display: flex;
	width: 100%;
	align-items: stretch;
}

.bookmark-title {
	font-size: 0.85em;
	overflow: hidden;
	text-overflow: ellipsis;
	height: 1.75em;
	white-space: nowrap;
}

.bookmark-text {
	display: flex;
	flex-direction: column;
}

.bookmark-info {
	flex: 4 1 180px;
	padding: 12px 14px 14px;
	display: flex;
	flex-direction: column;
	justify-content: space-between;
}

.bookmark-image {
	width: 33%;
	flex: 1 1 180px;
	display: block;
	position: relative;
	object-fit: cover;
	border-radius: 1px;
}

.bookmark-description {
	color: rgba(55, 53, 47, 0.6);
	font-size: 0.75em;
	overflow: hidden;
	max-height: 4.5em;
	word-break: break-word;
}

.bookmark-href {
	font-size: 0.75em;
	margin-top: 0.25em;
}

.sans { font-family: ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI Variable Display", "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol"; }
.code { font-family: "SFMono-Regular", Menlo, Consolas, "PT Mono", "Liberation Mono", Courier, monospace; }
.serif { font-family: Lyon-Text, Georgia, ui-serif, serif; }
.mono { font-family: iawriter-mono, Nitti, Menlo, Courier, monospace; }
.pdf .sans { font-family: Inter, ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI Variable Display", "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol", 'Twemoji', 'Noto Color Emoji', 'Noto Sans CJK JP'; }
.pdf:lang(zh-CN) .sans { font-family: Inter, ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI Variable Display", "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol", 'Twemoji', 'Noto Color Emoji', 'Noto Sans CJK SC'; }
.pdf:lang(zh-TW) .sans { font-family: Inter, ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI Variable Display", "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol", 'Twemoji', 'Noto Color Emoji', 'Noto Sans CJK TC'; }
.pdf:lang(ko-KR) .sans { font-family: Inter, ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI Variable Display", "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol", 'Twemoji', 'Noto Color Emoji', 'Noto Sans CJK KR'; }
.pdf .code { font-family: Source Code Pro, "SFMono-Regular", Menlo, Consolas, "PT Mono", "Liberation Mono", Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK JP'; }
.pdf:lang(zh-CN) .code { font-family: Source Code Pro, "SFMono-Regular", Menlo, Consolas, "PT Mono", "Liberation Mono", Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK SC'; }
.pdf:lang(zh-TW) .code { font-family: Source Code Pro, "SFMono-Regular", Menlo, Consolas, "PT Mono", "Liberation Mono", Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK TC'; }
.pdf:lang(ko-KR) .code { font-family: Source Code Pro, "SFMono-Regular", Menlo, Consolas, "PT Mono", "Liberation Mono", Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK KR'; }
.pdf .serif { font-family: PT Serif, Lyon-Text, Georgia, ui-serif, serif, 'Twemoji', 'Noto Color Emoji', 'Noto Serif CJK JP'; }
.pdf:lang(zh-CN) .serif { font-family: PT Serif, Lyon-Text, Georgia, ui-serif, serif, 'Twemoji', 'Noto Color Emoji', 'Noto Serif CJK SC'; }
.pdf:lang(zh-TW) .serif { font-family: PT Serif, Lyon-Text, Georgia, ui-serif, serif, 'Twemoji', 'Noto Color Emoji', 'Noto Serif CJK TC'; }
.pdf:lang(ko-KR) .serif { font-family: PT Serif, Lyon-Text, Georgia, ui-serif, serif, 'Twemoji', 'Noto Color Emoji', 'Noto Serif CJK KR'; }
.pdf .mono { font-family: PT Mono, iawriter-mono, Nitti, Menlo, Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK JP'; }
.pdf:lang(zh-CN) .mono { font-family: PT Mono, iawriter-mono, Nitti, Menlo, Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK SC'; }
.pdf:lang(zh-TW) .mono { font-family: PT Mono, iawriter-mono, Nitti, Menlo, Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK TC'; }
.pdf:lang(ko-KR) .mono { font-family: PT Mono, iawriter-mono, Nitti, Menlo, Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK KR'; }
.highlight-default {
	color: rgba(55, 53, 47, 1);
}
.highlight-gray {
	color: rgba(120, 119, 116, 1);
	fill: rgba(120, 119, 116, 1);
}
.highlight-brown {
	color: rgba(159, 107, 83, 1);
	fill: rgba(159, 107, 83, 1);
}
.highlight-orange {
	color: rgba(217, 115, 13, 1);
	fill: rgba(217, 115, 13, 1);
}
.highlight-yellow {
	color: rgba(203, 145, 47, 1);
	fill: rgba(203, 145, 47, 1);
}
.highlight-teal {
	color: rgba(68, 131, 97, 1);
	fill: rgba(68, 131, 97, 1);
}
.highlight-blue {
	color: rgba(51, 126, 169, 1);
	fill: rgba(51, 126, 169, 1);
}
.highlight-purple {
	color: rgba(144, 101, 176, 1);
	fill: rgba(144, 101, 176, 1);
}
.highlight-pink {
	color: rgba(193, 76, 138, 1);
	fill: rgba(193, 76, 138, 1);
}
.highlight-red {
	color: rgba(212, 76, 71, 1);
	fill: rgba(212, 76, 71, 1);
}
.highlight-default_background {
	color: rgba(55, 53, 47, 1);
}
.highlight-gray_background {
	background: rgba(241, 241, 239, 1);
}
.highlight-brown_background {
	background: rgba(244, 238, 238, 1);
}
.highlight-orange_background {
	background: rgba(251, 236, 221, 1);
}
.highlight-yellow_background {
	background: rgba(251, 243, 219, 1);
}
.highlight-teal_background {
	background: rgba(237, 243, 236, 1);
}
.highlight-blue_background {
	background: rgba(231, 243, 248, 1);
}
.highlight-purple_background {
	background: rgba(244, 240, 247, 0.8);
}
.highlight-pink_background {
	background: rgba(249, 238, 243, 0.8);
}
.highlight-red_background {
	background: rgba(253, 235, 236, 1);
}
.block-color-default {
	color: inherit;
	fill: inherit;
}
.block-color-gray {
	color: rgba(120, 119, 116, 1);
	fill: rgba(120, 119, 116, 1);
}
.block-color-brown {
	color: rgba(159, 107, 83, 1);
	fill: rgba(159, 107, 83, 1);
}
.block-color-orange {
	color: rgba(217, 115, 13, 1);
	fill: rgba(217, 115, 13, 1);
}
.block-color-yellow {
	color: rgba(203, 145, 47, 1);
	fill: rgba(203, 145, 47, 1);
}
.block-color-teal {
	color: rgba(68, 131, 97, 1);
	fill: rgba(68, 131, 97, 1);
}
.block-color-blue {
	color: rgba(51, 126, 169, 1);
	fill: rgba(51, 126, 169, 1);
}
.block-color-purple {
	color: rgba(144, 101, 176, 1);
	fill: rgba(144, 101, 176, 1);
}
.block-color-pink {
	color: rgba(193, 76, 138, 1);
	fill: rgba(193, 76, 138, 1);
}
.block-color-red {
	color: rgba(212, 76, 71, 1);
	fill: rgba(212, 76, 71, 1);
}
.block-color-default_background {
	color: inherit;
	fill: inherit;
}
.block-color-gray_background {
	background: rgba(241, 241, 239, 1);
}
.block-color-brown_background {
	background: rgba(244, 238, 238, 1);
}
.block-color-orange_background {
	background: rgba(251, 236, 221, 1);
}
.block-color-yellow_background {
	background: rgba(251, 243, 219, 1);
}
.block-color-teal_background {
	background: rgba(237, 243, 236, 1);
}
.block-color-blue_background {
	background: rgba(231, 243, 248, 1);
}
.block-color-purple_background {
	background: rgba(244, 240, 247, 0.8);
}
.block-color-pink_background {
	background: rgba(249, 238, 243, 0.8);
}
.block-color-red_background {
	background: rgba(253, 235, 236, 1);
}
.select-value-color-uiBlue { background-color: rgba(35, 131, 226, .07); }
.select-value-color-pink { background-color: rgba(245, 224, 233, 1); }
.select-value-color-purple { background-color: rgba(232, 222, 238, 1); }
.select-value-color-green { background-color: rgba(219, 237, 219, 1); }
.select-value-color-gray { background-color: rgba(227, 226, 224, 1); }
.select-value-color-transparentGray { background-color: rgba(227, 226, 224, 0); }
.select-value-color-translucentGray { background-color: rgba(0, 0, 0, 0.06); }
.select-value-color-orange { background-color: rgba(250, 222, 201, 1); }
.select-value-color-brown { background-color: rgba(238, 224, 218, 1); }
.select-value-color-red { background-color: rgba(255, 226, 221, 1); }
.select-value-color-yellow { background-color: rgba(253, 236, 200, 1); }
.select-value-color-blue { background-color: rgba(211, 229, 239, 1); }
.select-value-color-pageGlass { background-color: undefined; }
.select-value-color-washGlass { background-color: undefined; }

.checkbox {
	display: inline-flex;
	vertical-align: text-bottom;
	width: 16;
	height: 16;
	background-size: 16px;
	margin-left: 2px;
	margin-right: 5px;
}

.checkbox-on {
	background-image: url("data:image/svg+xml;charset=UTF-8,%3Csvg%20width%3D%2216%22%20height%3D%2216%22%20viewBox%3D%220%200%2016%2016%22%20fill%3D%22none%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%3E%0A%3Crect%20width%3D%2216%22%20height%3D%2216%22%20fill%3D%22%2358A9D7%22%2F%3E%0A%3Cpath%20d%3D%22M6.71429%2012.2852L14%204.9995L12.7143%203.71436L6.71429%209.71378L3.28571%206.2831L2%207.57092L6.71429%2012.2852Z%22%20fill%3D%22white%22%2F%3E%0A%3C%2Fsvg%3E");
}

.checkbox-off {
	background-image: url("data:image/svg+xml;charset=UTF-8,%3Csvg%20width%3D%2216%22%20height%3D%2216%22%20viewBox%3D%220%200%2016%2016%22%20fill%3D%22none%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%3E%0A%3Crect%20x%3D%220.75%22%20y%3D%220.75%22%20width%3D%2214.5%22%20height%3D%2214.5%22%20fill%3D%22white%22%20stroke%3D%22%2336352F%22%20stroke-width%3D%221.5%22%2F%3E%0A%3C%2Fsvg%3E");
}
	
</style></head><body><article id="c19eaf4d-1b3b-4aa3-8ac5-0e73d2e98c33" class="page serif"><header><img class="page-cover-image" src="https://www.notion.so/images/page-cover/gradients_8.png" style="object-position:center 70%"/><div class="page-header-icon page-header-icon-with-cover"><span class="icon">✍️</span></div><h1 class="page-title">实证指南与Stata编程笔记</h1><p class="page-description"></p></header><div class="page-body"><blockquote id="61e0f849-9ac8-4754-8207-02b32c283830" class="">Qiuliang YU (<em>qiuliang_yu@126.com</em>)<p id="10c3806e-5f6a-4c50-a154-ae5f0902bf39" class="">Updated in Apr 2024</p></blockquote><h1 id="688d35c5-61ee-42fb-b728-52c9f66556ef" class=""><span style="border-bottom:0.05em solid">0 序言</span></h1><ul id="343b2e28-37f1-4783-95f8-cdaf6e2a2ad7" class="bulleted-list"><li style="list-style-type:disc">个人介绍<ul id="b988b480-e968-48a3-84a1-2d1a89c105ec" class="bulleted-list"><li style="list-style-type:circle">俞秋亮，同济大学经济与管理学院在读博士（job market candidate for 2028）<a href="https://sites.google.com/view/qiuliangyu/home">[personal page]</a></li></ul></li></ul><ul id="1fd38f76-97a8-4a6f-880f-f52d8aa62cbc" class="bulleted-list"><li style="list-style-type:disc">这份笔记主要收录自己在实证研究过程中编写和使用的 Stata code。主要目的是帮助形成一份实证的checklist，同时传递一些前沿计量文献中提出的方法，在许多常见数据处理和分析的问题上提供解决思路。次要目的是提供 Stata 命令使用和编程的方法，因此并不适合初学者作为入门资料，一些命令的语法和使用我分享其他团队或个人整理的教学，这些也是我学习的材料。</li></ul><ul id="fda7542e-a399-46f9-9a60-1b01180a3345" class="bulleted-list"><li style="list-style-type:disc">目前的版本还有待完善，不足之处请多多包涵！<ul id="5aca72c5-6018-4574-931f-65ed095abf63" class="bulleted-list"><li style="list-style-type:circle">当前版本更新于2024年4月</li></ul><ul id="75f9153d-0b6f-4ffc-ad67-ffec82938d35" class="bulleted-list"><li style="list-style-type:circle">在线版本 <a href="https://www.notion.so/Stata-c19eaf4d1b3b4aa38ac50e73d2e98c33?pvs=21">[online link]</a><ul id="ee085cd9-8b37-49fa-9107-d731b89b6088" class="bulleted-list"><li style="list-style-type:square">在浏览器中安装 notion boost 插件 <a href="https://chromewebstore.google.com/detail/notion-boost/eciepnnimnjaojlkcpdpcgbfkpcagahd">[install here]</a>，可以在网页右侧获取大纲视图</li></ul></li></ul><ul id="58e9c2ca-5909-4c20-8220-fa7e28f0c7a4" class="bulleted-list"><li style="list-style-type:circle">如有任何建议和错误可以与我联系（mail: <em>qiuliang_yu@126.com</em>）</li></ul></li></ul><ul id="fe69d438-3a1f-4c0c-98c9-306655862f09" class="bulleted-list"><li style="list-style-type:disc">致谢<ul id="bda16689-9ebe-472f-a58f-8459b7674718" class="bulleted-list"><li style="list-style-type:circle">感谢雷耀煌帮助整理这份笔记。</li></ul></li></ul><p id="a0841df1-eef0-42c2-bae1-bb960cd83cb7" class="">
</p><hr id="c4ca301f-c13b-406f-b033-6cc081be1acc"/><div id="26c2cd04-0f60-4460-9877-4cc289d69665" class="column-list"><div id="08ec2472-80e3-432a-b6f1-8ceb4156c1b2" style="width:6.25%" class="column"><p id="2de6ae5d-6b1c-4698-945d-f11a62cdbce8" class=""><strong>目<br/>录<br/></strong></p><p id="44fa606f-6667-433b-b79c-b4649f9d1ab9" class="">
</p></div><div id="ae87e6b1-b977-4ab7-b35b-935108713ba9" style="width:93.75%" class="column"><nav id="403e74ce-e0ae-492f-b069-3d9032769b64" class="block-color-default table_of_contents"><div class="table_of_contents-item table_of_contents-indent-0"><a class="table_of_contents-link" href="#688d35c5-61ee-42fb-b728-52c9f66556ef"><span style="border-bottom:0.05em solid">0 序言</span></a></div><div class="table_of_contents-item table_of_contents-indent-0"><a class="table_of_contents-link" href="#8820ca9e-0362-4309-ba29-862603a3fb8c"><span style="border-bottom:0.05em solid">1 Stata操作</span></a></div><div class="table_of_contents-item table_of_contents-indent-1"><a class="table_of_contents-link" href="#d51669cd-5eb4-4a83-8b00-9c9a56521c7c">外部命令安装</a></div><div class="table_of_contents-item table_of_contents-indent-1"><a class="table_of_contents-link" href="#f7fea9d8-fc57-4f38-9f57-950e7a6e2c35">Stata extension</a></div><div class="table_of_contents-item table_of_contents-indent-0"><a class="table_of_contents-link" href="#962d75b7-df40-4d02-8f61-b5d9339d7ded"><span style="border-bottom:0.05em solid">2 数据处理</span></a></div><div class="table_of_contents-item table_of_contents-indent-1"><a class="table_of_contents-link" href="#6d2a630e-b815-45f3-8a3d-bd458c2b3b9b">数据集管理</a></div><div class="table_of_contents-item table_of_contents-indent-2"><a class="table_of_contents-link" href="#2472660d-15b6-4f48-8b50-aeffbc66fe2d">数据导入</a></div><div class="table_of_contents-item table_of_contents-indent-2"><a class="table_of_contents-link" href="#84c98ffb-774f-4d9d-9657-dbc69e1e06e5">数据保存</a></div><div class="table_of_contents-item table_of_contents-indent-2"><a class="table_of_contents-link" href="#9a93f139-3d72-4768-9c17-876af0be93ab">数据导出</a></div><div class="table_of_contents-item table_of_contents-indent-2"><a class="table_of_contents-link" href="#77ace333-bb0e-4568-8cc9-4eb14a4e075a">标签管理</a></div><div class="table_of_contents-item table_of_contents-indent-1"><a class="table_of_contents-link" href="#03afea09-2f06-4122-9925-821a123a3e14">多个数据集的管理</a></div><div class="table_of_contents-item table_of_contents-indent-2"><a class="table_of_contents-link" href="#2dfe775f-d8b5-4b3c-b363-8e7519b2e64d">合并两个数据集</a></div><div class="table_of_contents-item table_of_contents-indent-2"><a class="table_of_contents-link" href="#67cabe03-83fd-465a-a325-d7d5b8c9ec54">在不同数据集间切换</a></div><div class="table_of_contents-item table_of_contents-indent-1"><a class="table_of_contents-link" href="#0599ca65-0944-4046-9375-256c23002823">变量处理</a></div><div class="table_of_contents-item table_of_contents-indent-2"><a class="table_of_contents-link" href="#f2f4e570-5c11-4f76-a3e4-cecb54836886">变量生成</a></div><div class="table_of_contents-item table_of_contents-indent-2"><a class="table_of_contents-link" href="#660e1100-aa73-4ec8-9c57-698238055239">字符与数值变量的转换</a></div><div class="table_of_contents-item table_of_contents-indent-2"><a class="table_of_contents-link" href="#7d51ea9b-58a4-4f96-810b-7f2df855950f"><mark class="highlight-default">字符变量的处理</mark></a></div><div class="table_of_contents-item table_of_contents-indent-2"><a class="table_of_contents-link" href="#14295a44-7fb7-470f-9153-9992d67801e5">时间变量的处理</a></div><div class="table_of_contents-item table_of_contents-indent-2"><a class="table_of_contents-link" href="#959f5a30-f638-4df2-9352-658bf745c44a">量纲与单位变化</a></div><div class="table_of_contents-item table_of_contents-indent-2"><a class="table_of_contents-link" href="#609039cb-e621-4662-a1b5-4d85ba8ef17b">特殊变量生成与常用程序</a></div><div class="table_of_contents-item table_of_contents-indent-1"><a class="table_of_contents-link" href="#e4661d17-d014-4ae3-a1e3-26a1b9acba0d">变量管理</a></div><div class="table_of_contents-item table_of_contents-indent-2"><a class="table_of_contents-link" href="#926f6d72-afb0-4c1d-837d-a4c777e95eaf">批量重命名</a></div><div class="table_of_contents-item table_of_contents-indent-2"><a class="table_of_contents-link" href="#e455ece9-83cf-4003-afb8-8b95d4c5cdfc">按类型筛选变量</a></div><div class="table_of_contents-item table_of_contents-indent-2"><a class="table_of_contents-link" href="#bf62b23c-ef34-4844-8202-f1d889643cf3">整理变量顺序</a></div><div class="table_of_contents-item table_of_contents-indent-1"><a class="table_of_contents-link" href="#fbbef346-ba88-4dda-b2ce-249896b77e24">样本处理</a></div><div class="table_of_contents-item table_of_contents-indent-2"><a class="table_of_contents-link" href="#05203b83-f0d0-439c-86f3-80af22de1e0c">样本缺失的处理</a></div><div class="table_of_contents-item table_of_contents-indent-2"><a class="table_of_contents-link" href="#e09c1bc9-b4b2-427d-a568-2076aff751b9">异常样本的识别和处理</a></div><div class="table_of_contents-item table_of_contents-indent-2"><a class="table_of_contents-link" href="#1e458546-40f3-48f3-b2d7-23fb24a60f82">重复值的识别和处理</a></div><div class="table_of_contents-item table_of_contents-indent-2"><a class="table_of_contents-link" href="#88ee2904-fae3-4b2b-9744-24b36ee3b0af">样本排序</a></div><div class="table_of_contents-item table_of_contents-indent-1"><a class="table_of_contents-link" href="#fbe45015-37fc-4a95-9899-3c9ed96b6ad7">样本管理</a></div><div class="table_of_contents-item table_of_contents-indent-2"><a class="table_of_contents-link" href="#09bcd51d-6ab4-4873-a9d4-d8601b21070d">样本标签</a></div><div class="table_of_contents-item table_of_contents-indent-1"><a class="table_of_contents-link" href="#d1232a94-aa89-41b1-a926-95f0b60c6933">文件管理</a></div><div class="table_of_contents-item table_of_contents-indent-2"><a class="table_of_contents-link" href="#9572cb48-9fb4-434d-b068-275c99a9face">创建和删除文件夹</a></div><div class="table_of_contents-item table_of_contents-indent-2"><a class="table_of_contents-link" href="#e36a99d1-01fc-4eee-b4cc-ce2ff6dd4da6">删除文件</a></div><div class="table_of_contents-item table_of_contents-indent-0"><a class="table_of_contents-link" href="#f772634d-5036-4c80-aa62-eb12ce3b8968"><span style="border-bottom:0.05em solid">3 初步分析</span></a></div><div class="table_of_contents-item table_of_contents-indent-1"><a class="table_of_contents-link" href="#1a8cdfe7-8d6e-472e-9a3f-ce9cc77c41c2">描述性统计</a></div><div class="table_of_contents-item table_of_contents-indent-1"><a class="table_of_contents-link" href="#fa3dacc3-69c6-443a-ae38-35104366a08b">相关性分析</a></div><div class="table_of_contents-item table_of_contents-indent-1"><a class="table_of_contents-link" href="#3dfab92e-052a-474c-b95f-65b0c3ca3f48">一重差分</a></div><div class="table_of_contents-item table_of_contents-indent-0"><a class="table_of_contents-link" href="#3204c97d-a488-45b9-ab36-5c6e2a82248f"><span style="border-bottom:0.05em solid">4 回归分析</span></a></div><div class="table_of_contents-item table_of_contents-indent-1"><a class="table_of_contents-link" href="#0711f17a-37c7-4755-9827-3a6e70ae61f1">基准回归</a></div><div class="table_of_contents-item table_of_contents-indent-2"><a class="table_of_contents-link" href="#6a0dcc7c-ba3e-4c6b-b506-abe3cbcd02f3">OLS</a></div><div class="table_of_contents-item table_of_contents-indent-2"><a class="table_of_contents-link" href="#6f1fbbc0-82fe-4b6a-a03d-f72f5bd6434a">控制变量</a></div><div class="table_of_contents-item table_of_contents-indent-2"><a class="table_of_contents-link" href="#a8471794-0f61-438c-8c39-e43a2c605ed3">固定效应</a></div><div class="table_of_contents-item table_of_contents-indent-2"><a class="table_of_contents-link" href="#e4a58541-c3ac-40d3-bd2f-d3db4413843c">导出结果</a></div><div class="table_of_contents-item table_of_contents-indent-2"><a class="table_of_contents-link" href="#17acf529-41e2-44db-9a0b-940b5f3ebd27">调用参数估计结果</a></div><div class="table_of_contents-item table_of_contents-indent-1"><a class="table_of_contents-link" href="#52fd3815-b648-4496-b72d-986c0ccd94e0">内生性考虑</a></div><div class="table_of_contents-item table_of_contents-indent-2"><a class="table_of_contents-link" href="#ce61233d-3894-40bc-827c-6a7c167437c2">工具变量法</a></div><div class="table_of_contents-item table_of_contents-indent-2"><a class="table_of_contents-link" href="#bef31a9d-5f64-40ae-97b0-b08a0750a613">遗漏变量问题</a></div><div class="table_of_contents-item table_of_contents-indent-2"><a class="table_of_contents-link" href="#b19a4c68-aa5a-4e28-bb1f-93543b5b3a4c">样本偏差问题</a></div><div class="table_of_contents-item table_of_contents-indent-2"><a class="table_of_contents-link" href="#b7d50c9d-b1ad-45dc-be4d-91ab0ee4e490">测量误差问题</a></div><div class="table_of_contents-item table_of_contents-indent-2"><a class="table_of_contents-link" href="#faba0abd-f7ba-41e5-95c5-6f46a8bc3bfa">互为因果问题</a></div><div class="table_of_contents-item table_of_contents-indent-1"><a class="table_of_contents-link" href="#637bf549-e38a-4b4e-aecb-8d60430689c1">稳健性检验</a></div><div class="table_of_contents-item table_of_contents-indent-2"><a class="table_of_contents-link" href="#fa216049-478b-4dae-86a1-1c79b0895a1e">改变标准误</a></div><div class="table_of_contents-item table_of_contents-indent-2"><a class="table_of_contents-link" href="#658c314b-df70-431c-8624-edda111a63d5">样本控制</a></div><div class="table_of_contents-item table_of_contents-indent-2"><a class="table_of_contents-link" href="#c2551022-96a2-4507-a1be-82a9c26b26ba">改变模型</a></div><div class="table_of_contents-item table_of_contents-indent-2"><a class="table_of_contents-link" href="#2315481a-4128-48ac-9082-31a4b4b1d4c0">改变数据</a></div><div class="table_of_contents-item table_of_contents-indent-2"><a class="table_of_contents-link" href="#f3f853df-a2e2-4e47-974a-e58f9cc63859">改变参数估计方式</a></div><div class="table_of_contents-item table_of_contents-indent-1"><a class="table_of_contents-link" href="#ae2a22ea-673d-449d-abfd-0eff809d2116"><strong>异质性分析</strong></a></div><div class="table_of_contents-item table_of_contents-indent-2"><a class="table_of_contents-link" href="#8b45f558-d6ca-4b87-bade-d8f5b076589e">什么是好的异质性分析？</a></div><div class="table_of_contents-item table_of_contents-indent-2"><a class="table_of_contents-link" href="#d91e19ee-297b-43b8-bc9e-32ebff0c0361">引入交互项</a></div><div class="table_of_contents-item table_of_contents-indent-2"><a class="table_of_contents-link" href="#30ebafd3-7024-4187-90f5-ff67b3d28fbb">分样本回归</a></div><div class="table_of_contents-item table_of_contents-indent-2"><a class="table_of_contents-link" href="#9b3c01ca-573c-4ee7-9f51-ab1541e9222d">可视化异质性分析</a></div><div class="table_of_contents-item table_of_contents-indent-2"><a class="table_of_contents-link" href="#3ec4fa0b-5f6c-4902-8245-55782c3497d7">柱状图</a></div><div class="table_of_contents-item table_of_contents-indent-1"><a class="table_of_contents-link" href="#03884d84-e41d-433e-a4bc-0180b5bdd68a"><strong>关于</strong><em><strong><strong>p</strong></strong></em><strong><strong>-Hacking</strong></strong></a></div><div class="table_of_contents-item table_of_contents-indent-0"><a class="table_of_contents-link" href="#07782a90-c632-45d6-9537-7d9fe2396ede"><span style="border-bottom:0.05em solid">5 双重差分</span></a></div><div class="table_of_contents-item table_of_contents-indent-1"><a class="table_of_contents-link" href="#3ed41671-6114-46e3-ac13-31ce0497a954">初步分析</a></div><div class="table_of_contents-item table_of_contents-indent-2"><a class="table_of_contents-link" href="#85f26f31-245c-40a4-8dd2-ef759c1c42f5">展示面板数据的构造</a></div><div class="table_of_contents-item table_of_contents-indent-1"><a class="table_of_contents-link" href="#326cd099-a14a-46b1-942d-e358dfcffd7d">经典DiD</a></div><div class="table_of_contents-item table_of_contents-indent-2"><a class="table_of_contents-link" href="#d06ca1f9-b418-4b49-a72d-bde30f3a9121">处理组的定义与政策变量的生成</a></div><div class="table_of_contents-item table_of_contents-indent-2"><a class="table_of_contents-link" href="#008e166f-325f-46f6-92cb-286a72f7accf">平均处理效应</a></div><div class="table_of_contents-item table_of_contents-indent-2"><a class="table_of_contents-link" href="#056930b8-e343-41c8-a183-45112d98e9b3">平行趋势检验</a></div><div class="table_of_contents-item table_of_contents-indent-2"><a class="table_of_contents-link" href="#ccacf487-6381-4ee9-9ab1-6054a85cf5a3"><strong>平行趋势的敏感性检验</strong></a></div><div class="table_of_contents-item table_of_contents-indent-2"><a class="table_of_contents-link" href="#7a96267f-79e5-4722-ab43-80b375ad403d">安慰剂检验</a></div><div class="table_of_contents-item table_of_contents-indent-1"><a class="table_of_contents-link" href="#9839e6a2-5cec-4bf5-9f8c-e09916f4ed29">交叠/多时点DiD</a></div><div class="table_of_contents-item table_of_contents-indent-2"><a class="table_of_contents-link" href="#c9917729-1918-4919-916f-70070c7fe4ab">处理组的定义与政策变量的生成</a></div><div class="table_of_contents-item table_of_contents-indent-2"><a class="table_of_contents-link" href="#a56df706-908f-4529-abea-8b8fd5238e4b">平均处理效应</a></div><div class="table_of_contents-item table_of_contents-indent-2"><a class="table_of_contents-link" href="#9ab5d60d-3900-4408-80e0-e411c9b144fe">交叠/多时点DiD的前沿识别策略</a></div><div class="table_of_contents-item table_of_contents-indent-2"><a class="table_of_contents-link" href="#66bd7f30-0a53-4084-88aa-6debe4062323">交叠/多时点DiD的平行趋势检验</a></div><div class="table_of_contents-item table_of_contents-indent-2"><a class="table_of_contents-link" href="#bab6048c-9b61-4fa0-a563-8709bd2d4ab5"><strong>平行趋势的敏感性检验</strong></a></div><div class="table_of_contents-item table_of_contents-indent-2"><a class="table_of_contents-link" href="#5a77ab58-5077-4c8b-822a-c7f54f924e5c">安慰剂检验</a></div><div class="table_of_contents-item table_of_contents-indent-1"><a class="table_of_contents-link" href="#fab6f6f1-b940-41d2-a752-2312ba8f3747">倾向得分匹配PSM</a></div><div class="table_of_contents-item table_of_contents-indent-0"><a class="table_of_contents-link" href="#61e6ad1f-1328-4724-9c41-2fb22272aa75"><span style="border-bottom:0.05em solid">6 Stata绘图</span></a></div><div class="table_of_contents-item table_of_contents-indent-1"><a class="table_of_contents-link" href="#b50fccf8-ebc7-40b7-926d-30974a8f9ab1">个性化设置</a></div><div class="table_of_contents-item table_of_contents-indent-1"><a class="table_of_contents-link" href="#15c377ab-0c77-4335-8949-980f31d60d99">案例</a></div><div class="table_of_contents-item table_of_contents-indent-2"><a class="table_of_contents-link" href="#74f87bde-6ec1-429d-962d-da65d9ef1bf6">核密度图与折线图合并</a></div><div class="table_of_contents-item table_of_contents-indent-2"><a class="table_of_contents-link" href="#11d8af90-2577-80dc-93cf-e5caf087d095">折线图—添加文字</a></div><div class="table_of_contents-item table_of_contents-indent-2"><a class="table_of_contents-link" href="#11d8af90-2577-805a-ae7b-ef6a25f52e09">散点图—添加点标签</a></div><div class="table_of_contents-item table_of_contents-indent-2"><a class="table_of_contents-link" href="#11d8af90-2577-807c-a306-fa60cfeef8c8">散点图—添加拟合线</a></div><div class="table_of_contents-item table_of_contents-indent-0"><a class="table_of_contents-link" href="#266ceb25-3fbe-4c14-a008-3302c2e09d27">Inference in network model</a></div></nav></div></div><hr id="362dfcdc-e0c6-4562-87e5-557db2cc8af8"/><h1 id="8820ca9e-0362-4309-ba29-862603a3fb8c" class=""><span style="border-bottom:0.05em solid">1 Stata操作</span></h1><h2 id="d51669cd-5eb4-4a83-8b00-9c9a56521c7c" class="">外部命令安装</h2><ul id="65d23185-bf3f-4efb-aefc-3a355fbe1471" class="toggle"><li><details open=""><summary>Stata外部命令下载</summary><p id="efcd717f-9175-4588-8877-0af7bda7e2cd" class="">一般情况下，可以通过 <code>ssc install [commandname]</code> 来安装外部命令</p><p id="7d7b2924-e8f7-4647-88d9-9c2433f7319d" class="">如果因特殊原因 Stata 无法联网，可以从网站 <a href="http://fmwww.bc.edu/RePEc/bocode/">http://fmwww.bc.edu/RePEc/bocode/</a> 中自主下载外部命令，这些命令通常是 ado、pkg、sthlp等后缀的文件</p><p id="c9e8d609-3df2-4bd7-8226-85bf331a45c0" class="">下载后，安装到 Stata 安装目录下的 ado 文件夹中的 plus 子文件夹内，在Stata的命令窗口中输入<code>sysdir</code> ，就能看到本地 plus 文件路径</p></details></li></ul><ul id="6dcd5208-1d22-478d-aef7-e72f5dfa9a28" class="toggle"><li><details open=""><summary>常见外部命令</summary><ol type="1" id="9dbb8815-a9c1-40e4-ba94-4b4a945b9609" class="numbered-list" start="1"><li><code>reghdfe</code>：这是一个用于高维固定效应回归的命令。它可以高效地处理包含大量固定效应的回归模型，从而节省计算时间和内存。</li></ol><ol type="1" id="76fa9990-60db-41e7-b352-f0fcb5eadb5d" class="numbered-list" start="2"><li><code>ftools</code>：提供了一系列高效的数据处理工具，特别是在大数据集上表现优异。是<code>reghdfe</code>所依赖的必要外部命令。</li></ol><ol type="1" id="e3b0e80a-1715-4526-8abe-477d7470e40e" class="numbered-list" start="3"><li><code>winsor2</code>：这个命令用于对数据进行缩尾处理，即将极端值替换为指定分位数的值，以减少极端值对分析结果的影响。</li></ol><ol type="1" id="b41e7709-86a4-44ac-a51e-d23cc58a01cd" class="numbered-list" start="4"><li><code>outreg2 </code>和 <code>estout</code>：这两个命令都用于将回归分析结果输出到外部文档中。它们提供了多种输出格式和选项，使用户能够根据需要定制输出内容。</li></ol><ol type="1" id="e12a2c43-d743-4357-8c2b-c2bc4fc07392" class="numbered-list" start="5"><li><code>coefplot</code>：这个命令用于绘制回归系数的图形表示，帮助用户更直观地理解和比较不同模型的回归系数。常用于事件研究法绘制平行趋势检验图，或者异质性分析中分组回归系数的比较。</li></ol><ol type="1" id="c0aafb48-bfbd-4fbd-95e3-8647460b7908" class="numbered-list" start="6"><li><code>psmatch2</code>：这是一个用于倾向得分匹配（Propensity Score Matching）的命令。倾向得分匹配是一种用于处理观察性研究中的选择偏差的统计方法。</li></ol><p id="8c2a3ce0-6dc9-4c3d-851a-49e2c7bda7b5" class="">通过循环语句，安装上述外部命令的代码：</p><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="285bd25f-d349-4c7c-999e-62cd934b3c51" class="code"><code class="language-Plain Text">foreach command in reghdfe ftools winsor2 outreg2 estout coefplot psmatch2 {
	ssc install `command&#x27;, replace
}</code></pre></details></li></ul><h2 id="f7fea9d8-fc57-4f38-9f57-950e7a6e2c35" class="">Stata extension</h2><ul id="9bb83790-8e6d-494e-a095-ee428609a3f4" class="toggle"><li><details open=""><summary>Python</summary><ul id="6d8b305d-9c7c-4d67-868a-33789f951ec0" class="bulleted-list"><li style="list-style-type:disc"><a href="https://www.lianxh.cn/news/285493e301c8a.html">Stata-Python交互-1：二者配合的基本设定</a></li></ul></details></li></ul><ul id="6171cbaa-9416-48ac-8b52-be579626330c" class="toggle"><li><details open=""><summary>Mata</summary><ul id="ece1c692-b334-4cd6-9930-a8d807000218" class="bulleted-list"><li style="list-style-type:disc"><a href="https://www.lianxh.cn/news/e23df70afde87.html">Stata - Mata系列 (一)：Mata 入门</a></li></ul></details></li></ul><ul id="3b51b2d4-3dc9-47a1-a833-2ffebc97292b" class="toggle"><li><details open=""><summary>Vscode</summary><ul id="d3e72c73-8414-41c5-8574-cebd930c6892" class="bulleted-list"><li style="list-style-type:disc"><a href="https://www.lianxh.cn/news/40a28448f42f4.html">VScode +Stata：在 VScode 中编辑和运行Stata命令</a></li></ul></details></li></ul><p id="c9bcf9f4-7991-47c2-8680-51c6c2f325ff" class="">
</p><hr id="43b43520-073d-4fa1-80ce-46cb6554c885"/><h1 id="962d75b7-df40-4d02-8f61-b5d9339d7ded" class=""><span style="border-bottom:0.05em solid">2 数据处理</span></h1><h2 id="6d2a630e-b815-45f3-8a3d-bd458c2b3b9b" class="">数据集管理</h2><h3 id="2472660d-15b6-4f48-8b50-aeffbc66fe2d" class="">数据导入</h3><ul id="b79fa538-bf7e-4d5b-9993-0dd6e44c5cf8" class="toggle"><li><details open=""><summary>导入Excel 文件</summary><ul id="ed10ecf2-bc01-45f5-9da6-88d2d4cb966c" class="bulleted-list"><li style="list-style-type:disc">Excel 表格可以通过 Stata 主界面 “文件-导入-Excel电子表格” 模块导入，或者</li></ul><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="d8796f59-086a-4487-8362-a7b9158073ed" class="code"><code class="language-Plain Text">clear all
global fpath &quot;C:/Users/Desktop&quot;
cd &quot;$fpath&quot;
import excel &quot;工作簿1.xlsx&quot;, sheet(&quot;Sheet1&quot;) firstrow clear</code></pre><ul id="67173d72-5404-4375-91d5-5c672a98df53" class="toggle"><li><details open=""><summary>WIND 数据导入</summary><figure id="9b733fc7-ae8e-4aa2-a67d-4c13ef6c3fdb"><a href="https://bbs.pinggu.org/thread-6818506-1-1.html" class="bookmark source"><div class="bookmark-info"><div class="bookmark-text"><div class="bookmark-title">wind数据转为国泰安数据  stata命令 - Stata专版 - 经管之家(原人大经济论坛)</div><div class="bookmark-description">wind数据转为国泰安数据  stata命令,WIND数据库下载下来的数据通常是下面这种格式：但是我们stata回归分析一般是需要下面这种：在stata中reshape命令可以处理，下面是简单例子：（大家可以help reshape一下，里面也有例子）1.先将wind下载的excel数据处理成下面这种格式，code是公司代码，x是第一个变量，y是第二个变量，2003——2009是年份。2.将excel数据导入stata，如下导入后stata显示数据如下：3.用reshape命令：reshape long x y,i(code) j(year)具体reshape大家可以help一下，里面有例子。运行完结果,经管之家(原人大经济论坛)</div></div><div class="bookmark-href"><img src="https://bbs.pinggu.org/favicon.ico" class="icon bookmark-icon"/>https://bbs.pinggu.org/thread-6818506-1-1.html</div></div></a></figure></details></li></ul></details></li></ul><ul id="f71ead18-146a-457c-afe2-faee62e0496f" class="toggle"><li><details open=""><summary>导入CSV文件</summary><ul id="d0808725-e814-42a3-bdb9-1959230f602f" class="bulleted-list"><li style="list-style-type:disc">CSV文件可以通过 Stata 主界面 “文件-导入-文本数据” 模块导入，或者</li></ul><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="d20547f1-e35e-4bc8-ad41-b67fa0db75cf" class="code"><code class="language-Plain Text">clear all
global fpath &quot;C:/Users/Desktop&quot;
cd &quot;$fpath&quot;
import delimited &quot;工作簿1.csv&quot;, clear</code></pre></details></li></ul><h3 id="84c98ffb-774f-4d9d-9657-dbc69e1e06e5" class="">数据保存</h3><ul id="cc867d07-4582-46ed-ab2a-d9a6e44cda0d" class="toggle"><li><details open=""><summary>数据保存</summary><ul id="926c1984-3967-4424-8115-9e4de9cd37fa" class="bulleted-list"><li style="list-style-type:disc">保存数据前可以用 <code>compress</code> 压缩一下内存</li></ul><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="9d64ffa1-b4f7-46ec-9416-8680b9a6ab34" class="code"><code class="language-Plain Text">compress
save &quot;maindata.dta&quot;, replace</code></pre></details></li></ul><h3 id="9a93f139-3d72-4768-9c17-876af0be93ab" class="">数据导出</h3><ul id="7f385de6-9f61-45bc-b7ff-4ec879e4f87e" class="toggle"><li><details open=""><summary>导出为Excel 文件</summary><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="73117ca3-d592-4afe-a361-700acfaf5007" class="code"><code class="language-Plain Text">export excel using &quot;.\导出数据.xls&quot;, firstrow(variables) replace</code></pre></details></li></ul><h3 id="77ace333-bb0e-4568-8cc9-4eb14a4e075a" class="">标签管理</h3><ul id="834136ff-5da4-4fe4-b271-0b86674b5678" class="toggle"><li><details open=""><summary>给变量添加标签</summary><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="b37304f9-3548-4575-b080-ccf8f7e72add" class="code"><code class="language-Plain Text">lab var gdp &quot;国内生产总值（元）&quot;</code></pre><ul id="41a04b4f-ab46-46b9-a21f-88d219c6befb" class="bulleted-list"><li style="list-style-type:disc">批量编辑原标签</li></ul><ul id="2c08d97c-8385-4300-ab15-e6632b9042e5" class="bulleted-list"><li style="list-style-type:disc">以取对数为例</li></ul><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="ad0c0699-d85c-4375-86dc-9ab9f9fe472f" class="code"><code class="language-Plain Text">foreach x of varlist gdp {
	gen ln`x&#x27; = ln(`x&#x27;)
	local `x&#x27;_lab: var lab `x&#x27; // 储存原变量的标签字符
	lab var ln`x&#x27; &quot;``x&#x27;_lab&#x27;对数&quot; // 给新生成的对数变量贴上标签
}</code></pre></details></li></ul><ul id="d1d81b99-4900-4369-ac86-6ff2f7b4294f" class="toggle"><li><details open=""><summary>给数据添加标签</summary><ul id="c67629ca-12bf-4bc9-b65a-c26811d4c340" class="bulleted-list"><li style="list-style-type:disc">这一功能通常用于剔除第三方来源数据库的标签</li></ul><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="b23c848f-0c4e-43fe-98a5-5ff486414352" class="code"><code class="language-Plain Text">lab data &quot;&quot;</code></pre></details></li></ul><h2 id="03afea09-2f06-4122-9925-821a123a3e14" class="">多个数据集的管理</h2><h3 id="2dfe775f-d8b5-4b3c-b363-8e7519b2e64d" class="">合并两个数据集</h3><ul id="5ded0946-fbfc-47c4-bf35-e80086739e23" class="toggle"><li><details open=""><summary>横向合并 <code>merge</code></summary><figure id="8b1161f3-35d1-4138-a55c-50b3d066c25b"><a href="https://www.bilibili.com/video/BV1x7411w7ru/?spm_id_from=333.1007.top_right_bar_window_history.content.click&amp;vd_source=15c36b942af8ac201fc9a4d87db9d7cf" class="bookmark source"><div class="bookmark-info"><div class="bookmark-text"><div class="bookmark-title">Stata入门——合并数据(merge)_哔哩哔哩_bilibili</div><div class="bookmark-description">stata入门往期视频： https://www.bilibili.com/medialist/detail/ml855419742?type=1, 视频播放量 373540、弹幕量 869、点赞数 8405、投硬币枚数 6576、收藏人数 11355、转发人数 3989, 视频作者 silencedream, 作者简介 兴趣使然（视频目录：http://silencedream.gitee.io/），相关视频：Stata入门——导入数据，Stata入门——纵向合并数据(append)，stata的数据合并：merge和append，整理数据之--如何将下载的数据快速整理成panel data（面板数据），Stata 小白入门篇---merge合并多表格数据，Stata应用：数据转换，1.数据预处理 数据清洗stata，Stata入门——Wind(万得)数据转化为面板格式，如何用stata合并两张表（数据整理之merge），Stata入门——分组计算</div></div><div class="bookmark-href"><img src="https://i0.hdslb.com/bfs/archive/740f6b52211f52fac8af7d1e44a3ff239d101e87.jpg@100w_100h_1c.png@57w_57h_1c.png" class="icon bookmark-icon"/>https://www.bilibili.com/video/BV1x7411w7ru/?spm_id_from=333.1007.top_right_bar_window_history.content.click&amp;vd_source=15c36b942af8ac201fc9a4d87db9d7cf</div></div><img src="https://i0.hdslb.com/bfs/archive/740f6b52211f52fac8af7d1e44a3ff239d101e87.jpg@100w_100h_1c.png" class="bookmark-image"/></a></figure><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="fac25874-87c2-4865-a990-6f250a7ad0e7" class="code"><code class="language-Plain Text">// 1:1 横向合并
merge 1:1 id year use &quot;data.dta&quot;
drop if _merge == 2
drop _merge</code></pre><ul id="208b7883-5949-41a6-be4b-c8c6a49b7214" class="bulleted-list"><li style="list-style-type:disc">在多次横向合并数据的时候，每次 merge 后都要 drop 两次，因此我定义了 <code>aftermerge</code> 程序，节约编写时间</li></ul><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="4b0258b0-a322-4f05-ba67-8a05cd8d699f" class="code"><code class="language-Plain Text">// merge数据集后根据_merge修剪样本
cap program drop aftermerge
program define aftermerge
	syntax , [KEEP(numlist) DROP(numlist)]
	// only one of keep or drop can be specified here
	if (&quot;`keep&#x27;&quot;==&quot;&quot; &amp; &quot;`drop&#x27;&quot;==&quot;&quot;) | (&quot;`keep&#x27;&quot;!=&quot;&quot; &amp; &quot;`drop&#x27;&quot;!=&quot;&quot;) {
		di &quot;Only one of keep or drop can be specified here.&quot;
		exit
	}
	if &quot;`keep&#x27;&quot;!=&quot;&quot; keep if regexm(&quot;`keep&#x27;&quot;, string(_merge))
	if &quot;`drop&#x27;&quot;!=&quot;&quot; drop if regexm(&quot;`drop&#x27;&quot;, string(_merge))
	drop _merge
end

// 1:1 横向合并
merge 1:1 id year use &quot;data.dta&quot;
aftermerge, drop(2)</code></pre></details></li></ul><ul id="cc1b836e-5be3-4e5b-8717-2667fe588092" class="toggle"><li><details open=""><summary>纵向合并<code>append</code></summary><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="c69fdfe0-39da-4574-86ad-f83127066145" class="code"><code class="language-Plain Text">use &quot;maindata.dta&quot;, clear
append using &quot;usingdata.dta&quot;</code></pre></details></li></ul><ul id="699e92bd-69c6-43da-a5d1-dee533ffdb84" class="toggle"><li><details open=""><summary>交叉合并<code>cross</code></summary><ul id="719006d3-2f56-4f74-8452-54cf644b8965" class="bulleted-list"><li style="list-style-type:disc"><code>cross</code> 十分适合将一份数据整理为 strong balance panel structure，例如</li></ul><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="45004006-01d0-4e9b-8117-bfe5e5e35359" class="code"><code class="language-Plain Text">use &quot;maindata.dta&quot;, clear
xtset id t

// keep id
preserve
keep id
duplicates drop all
save &quot;data_id.dta&quot;, replace
restore

// keep t
preserve
keep t
duplicates drop all
save &quot;data_t.dta&quot;, replace
restore

// strong balance panel structure
use &quot;data_id.dta&quot;, clear
cross using &quot;data_t.dta&quot;

// erase temporary data
cap erase &quot;data_id.dta&quot;
cap erase &quot;data_t.dta&quot;</code></pre></details></li></ul><h3 id="67cabe03-83fd-465a-a325-d7d5b8c9ec54" class="">在不同数据集间切换</h3><ul id="0263f771-6122-4797-ae95-138ba1f160e4" class="toggle"><li><details open=""><summary><code>preserve</code>与 <code>restore</code></summary><ul id="34b73c22-9ece-49b8-abd8-faee2339abed" class="bulleted-list"><li style="list-style-type:disc">语法简单，但不能嵌套使用，无法适用于高级编程</li></ul><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="c494adb4-75b8-4958-8dc6-b5a6de26d5fa" class="code"><code class="language-Plain Text">preserve // 暂存数据
* ...
restore // 恢复数据</code></pre></details></li></ul><ul id="4d18b1c2-0c04-473b-a03c-830478b65db2" class="toggle"><li><details open=""><summary><code>snapshot</code>功能</summary><ul id="644e0aa3-d616-4eff-9023-dbfcd37d05c0" class="bulleted-list"><li style="list-style-type:disc">语法比较简单，适合“树状”的编程结构</li></ul><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="3054dc73-6a5c-400e-89b6-0c5b4b33c0bc" class="code"><code class="language-Plain Text">regress y d x1 x2 x3
eststo, p(re_)

// temporarily save
snapshot erase _all
snapshot save

// try 1:1 psm
snapshot restore 1
psmatch2 d x1 x2 x3, out(y) neighbor(1) common caliper(0.05)
keep if _nn!=.
regress y d x1 x2 x3
eststo, p(re_)

// try 1:5 psm addtionally
snapshot restore 1
psmatch2 d x1 x2 x3, out(y) neighbor(5) common caliper(0.05)
keep if _nn!=.
regress y d x1 x2 x3
eststo, p(re_)

// display
esttab re_*, star(* 0.1 ** 0.05 *** 0.01)
eststo clear</code></pre></details></li></ul><ul id="809dd335-8bec-48b6-9abd-cc867c01e4e0" class="toggle"><li><details open=""><summary><code>dataframe</code>功能</summary><ul id="e112d271-8bdb-4b91-86c9-8b873cf1562a" class="bulleted-list"><li style="list-style-type:disc">语法比较复杂</li></ul><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="d37d8b95-3522-41ae-8abd-33a51b10f446" class="code"><code class="language-Plain Text">frame create new //创建新的数据框
frame dir //查询内存中的所有数据框
frame change new
cwf new //数据框的切换，效果同上
frame pwf 
pwf // 查询当前数据框，同上</code></pre></details></li></ul><h2 id="0599ca65-0944-4046-9375-256c23002823" class="">变量处理</h2><h3 id="f2f4e570-5c11-4f76-a3e4-cecb54836886" class="">变量生成</h3><ul id="aa7291d6-9b7e-4c07-9887-1792e4363fd9" class="toggle"><li><details open=""><summary><code>gen</code> 与 <code>egen</code></summary><ul id="f3af49a2-6373-4090-a693-9b51855fefd9" class="bulleted-list"><li style="list-style-type:disc"><a href="https://www.sohu.com/a/167307279_697896">论egen的花样用法</a></li></ul></details></li></ul><ul id="ac651fb3-cd8f-4ab1-99a4-14cef46a3ccf" class="toggle"><li><details open=""><summary>特殊情况提醒</summary><ul id="8d02f0d1-7d4a-4aa5-aac8-91e7dc7f5d57" class="toggle"><li><details open=""><summary>函数 <code>sum()</code> </summary><ul id="eaf98e51-680c-4d83-9810-525d9bf33cf4" class="bulleted-list"><li style="list-style-type:disc">如要生成一个新的变量是原变量的所有数值之和，请用 <code>egen</code> 而不是 <code>gen</code></li></ul><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="a2ea8fd8-32d5-4a48-9830-de5b5049ef76" class="code"><code class="language-Plain Text">clear all
set obs 5
gen a = _n
gen gensuma = sum(a)
egen egensuma = sum(a)
egen egentotala = total(a)</code></pre><ul id="7256e546-1701-4918-b63e-a6060923f4e7" class="bulleted-list"><li style="list-style-type:disc">上面这个例子的运行结果</li></ul><table id="88348b8e-2d88-484b-9824-712afa218d4b" class="simple-table"><thead class="simple-table-header"><tr id="25bb8248-e107-4308-a6ed-263386001374"><th id="AyWw" class="simple-table-header-color simple-table-header" style="width:158.5px">a</th><th id="ho&gt;g" class="simple-table-header-color simple-table-header" style="width:158.5px">gensuma</th><th id="QPV:" class="simple-table-header-color simple-table-header" style="width:158.5px">egensuma</th><th id="Gbwc" class="simple-table-header-color simple-table-header" style="width:158.5px">egentotala</th></tr></thead><tbody><tr id="ba8dae8b-447b-4778-bf6f-d94bb594dfb7"><td id="AyWw" class="" style="width:158.5px">1</td><td id="ho&gt;g" class="" style="width:158.5px">1</td><td id="QPV:" class="" style="width:158.5px">15</td><td id="Gbwc" class="" style="width:158.5px">15</td></tr><tr id="8de98a20-94f0-4f46-94bc-fef03776bb58"><td id="AyWw" class="" style="width:158.5px">2</td><td id="ho&gt;g" class="" style="width:158.5px">3</td><td id="QPV:" class="" style="width:158.5px">15</td><td id="Gbwc" class="" style="width:158.5px">15</td></tr><tr id="1b5c1ec4-2dea-49cb-b1cc-dead863a28d5"><td id="AyWw" class="" style="width:158.5px">3</td><td id="ho&gt;g" class="" style="width:158.5px">6</td><td id="QPV:" class="" style="width:158.5px">15</td><td id="Gbwc" class="" style="width:158.5px">15</td></tr><tr id="6d0c472a-b0e9-42d7-aca2-a542a078be5f"><td id="AyWw" class="" style="width:158.5px">4</td><td id="ho&gt;g" class="" style="width:158.5px">10</td><td id="QPV:" class="" style="width:158.5px">15</td><td id="Gbwc" class="" style="width:158.5px">15</td></tr><tr id="5fe7014f-78ef-456d-9653-0189337abbe0"><td id="AyWw" class="" style="width:158.5px">5</td><td id="ho&gt;g" class="" style="width:158.5px">15</td><td id="QPV:" class="" style="width:158.5px">15</td><td id="Gbwc" class="" style="width:158.5px">15</td></tr></tbody></table><ul id="68544dfd-897d-4cc6-a29d-1140c3eaba75" class="bulleted-list"><li style="list-style-type:disc">可以看到 <code>gen newvarname = sum(varname)</code> 是进行了累计求和， <code>egen newvarname = sum(varname)</code> 或者  <code>egen newvarname = total(varname)</code> 才是对所有数值求和</li></ul></details></li></ul></details></li></ul><h3 id="660e1100-aa73-4ec8-9c57-698238055239" class="">字符与数值变量的转换</h3><h3 id="7d51ea9b-58a4-4f96-810b-7f2df855950f" class=""><mark class="highlight-default">字符变量的处理</mark></h3><ul id="84650962-37f9-46cf-ab9b-910d4de730d2" class="toggle"><li><details open=""><summary>与数值型变量相互转换</summary><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="abcad3d0-fabd-4829-916e-3839a5723906" class="code"><code class="language-Plain Text">destring citycode, replace
* 字符-&gt;数值

tostring citycode, replace
* 数值-&gt;字符</code></pre></details></li></ul><h3 id="14295a44-7fb7-470f-9153-9992d67801e5" class="">时间变量的处理</h3><ul id="9955c5a4-a460-44de-802d-d8c90bd095fa" class="toggle"><li><details open=""><summary>有月份和年份两个变量，合并为一个时间变量</summary><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="113bc057-d002-47ce-992e-819734832700" class="code"><code class="language-Plain Text">// generate time variable
gen calendar = string(year)+&quot;-&quot;+string(month)
gen date = date(calendar,&quot;YM&quot;)
format %tdCCYY-NN date
tsset date
drop calendar</code></pre></details></li></ul><ul id="10a8af90-2577-80fa-8276-e9d40c140cf4" class="toggle"><li><details open=""><summary>日期字符串变量，提取年、月和日</summary><ul id="a05b37df-fb28-4d16-810d-e940f43b3ec1" class="bulleted-list"><li style="list-style-type:disc">日期变量calendar以字符串格式储存，如“2010/1/5”，生成年份 year、月份 month和日 day变量</li></ul><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="10a8af90-2577-8046-b662-fbb91ce75e07" class="code"><code class="language-Plain Text">gen date = date(calendar,&quot;YMD&quot;)
format %tdCCYY-NN date
gen year = year(date)
gen month = month(date)
gen day = day(date)</code></pre></details></li></ul><h3 id="959f5a30-f638-4df2-9352-658bf745c44a" class="">量纲与单位变化</h3><ul id="30dfa96d-ba1d-4fa5-b035-0ff2c150c4bf" class="toggle"><li><details open=""><summary>标准化</summary><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="794251ad-e38b-4123-9fad-0fe7f1c80918" class="code"><code class="language-Plain Text">// standization
foreach x in x1 x2 x3 {
	qui su `x&#x27;
	replace `x&#x27; = (`x&#x27;-r(mean))/r(sd)
}</code></pre></details></li></ul><ul id="9d27dd54-3e73-42e9-9d4b-62284546b3b3" class="toggle"><li><details open=""><summary>归一化</summary><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="42da7f5a-233d-4a40-a9b6-4b0bc0799ce5" class="code"><code class="language-Plain Text">// 归一化
foreach x in x1 x2 x3 {
	qui su `x&#x27;
	replace `x&#x27; = (`x&#x27;-r(min))/(r(max)-r(min))
}</code></pre></details></li></ul><h3 id="609039cb-e621-4662-a1b5-4d85ba8ef17b" class="">特殊变量生成与常用程序</h3><ul id="91ae4681-7173-4108-83ab-27761ca3621a" class="toggle"><li><details open=""><summary>区县名称调整</summary><ul id="6d2e1825-6427-41c0-a79d-6b5a31586a94" class="bulleted-list"><li style="list-style-type:disc">去掉“省”或“市”的后缀</li></ul><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="ea8f237e-a45c-40c9-af3e-ac7c1b6fcd18" class="code"><code class="language-Plain Text">// 去掉“省”或“市”的后缀
replace city=ustrregexra(city,&quot;市&quot;,&quot;&quot;)
replace province=ustrregexra(province,&quot;省&quot;,&quot;&quot;)</code></pre></details></li></ul><ul id="bc09210b-7574-4fa5-b372-3a5955dbf51c" class="toggle"><li><details open=""><summary>上市公司的证券代码（数值型）代码为六位字符串（字符型）</summary><ul id="49f9f56b-a594-4065-9f68-e6b84cb92528" class="bulleted-list"><li style="list-style-type:disc">定义一个新的Stata程序（或函数）名为<code>TransfScode</code> ，程序接受一个可选的字符串参数<code>scodevar</code>，该参数表示包含证券代码的变量的名称。</li></ul><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="2b782046-e2e6-42bb-bec7-52bbac82b9a8" class="code"><code class="language-Plain Text">// 定义函数 - 转换证券代码为六位字符串
program define TransfScode
	syntax [,scodevar(string)]
	if &quot;`scodevar&#x27;&quot;!=&quot;&quot; local scodevar `scodevar&#x27; 
	else local scodevar stkcd 
	qui tostring `scodevar&#x27;,replace
	tempvar tempvar1 tempvar2
	gen `tempvar1&#x27; = strlen(`scodevar&#x27;)
	gen `tempvar2&#x27; = &quot;0&quot;*(6-`tempvar1&#x27;)
	replace `scodevar&#x27; = `tempvar2&#x27; + `scodevar&#x27;
	cap drop `tempvar1&#x27; `tempvar2&#x27;
end</code></pre><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="7c3e0f03-cf36-4b16-8de0-1d6d395ad4a9" class="code"><code class="language-Plain Text">TransfScode, scodevar(stkcd) 
* scodevar省略时，默认证券代码的变量是stkcd</code></pre></details></li></ul><ul id="23df0a02-abe5-448b-bdae-35f890bfb6f6" class="toggle"><li><details open=""><summary>分类变量中剔除特定组别，如剔除特定行业和特定企业</summary><ul id="dcec2fdc-25f9-4278-81fe-6b3ae4bae2a3" class="bulleted-list"><li style="list-style-type:disc">方法一：使用 <code>inlist()</code> 函数</li></ul><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="6a474f19-1704-4707-bdf7-b46e5edfbad6" class="code"><code class="language-Plain Text">drop if inlist(industryname, &quot;货币金融服务&quot;, &quot;保险业&quot;, &quot;资本市场服务&quot;) // 剔除房地产、金融行业
keep if inlist(listingstate, &quot;正常上市&quot;) // 剔除ST企业</code></pre><ul id="c25454c9-db5d-4500-be69-e0e587d7c647" class="bulleted-list"><li style="list-style-type:disc">注意， <code>inlist()</code> 内最多包含10个参数</li></ul><ul id="133b67c7-b69a-479a-9297-2aa919e22ff4" class="bulleted-list"><li style="list-style-type:disc">方法二：使用 <code>regexm()</code> 函数</li></ul><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="b782b241-e862-450a-adf8-d09d1ae4f2df" class="code"><code class="language-Plain Text">drop if regexm(&quot;货币金融服务、保险业和资本市场服务&quot;, industryname) // 剔除房地产、金融行业
keep if regexm(&quot;正常上市&quot;, listingstate) // 剔除ST企业</code></pre><ul id="969714ed-4a11-492a-b28a-1169c5470429" class="bulleted-list"><li style="list-style-type:disc"><code>regexm()</code> 函数在Stata中用于检测正则表达式匹配，并返回一个逻辑值（匹配时为1，不匹配时为0）<br/>这意味着，如果 <br/><code>industryname==&quot;金融服务&quot;</code> 同样会被匹配并剔除。在某些情况下，这简化了我们的代码和程序，但需要警惕可能会误删原本想要保留的观测值</li></ul></details></li></ul><ul id="c6eed382-4e21-4101-bf70-f15d3a8a6a08" class="toggle"><li><details open=""><summary>按照省份名称，定义东中西部城市</summary><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="813d123f-ff57-41b6-9495-5f0316bd3466" class="code"><code class="language-Plain Text">local prov_varname province // 记录省份名称的变量

gen region = .  
replace region = 1 if regexm(&quot;海南省, 浙江省, 山东省, 福建省, 河北省, 辽宁省, 广东省, 上海市, 天津市, 北京市, 江苏省&quot;, `prov_varname&#x27;)  
replace region = 2 if regexm(&quot;安徽省, 湖北省, 黑龙江省, 吉林省, 山西省, 江西省, 河南省, 湖南省&quot;, `prov_varname&#x27;)  
replace region = 3 if regexm(&quot;云南省, 西藏自治区, 陕西省, 广西壮族自治区, 四川省, 新疆维吾尔自治区, 宁夏回族自治区, 重庆市, 甘肃省, 贵州省, 青海省, 内蒙古自治区&quot;, `prov_varname&#x27;)  
  
* 贴值标签  
label define regiontype 1 东部 2 中部 3 西部  
label values region regiontype</code></pre><ul id="355a1414-554a-4aa7-a13b-d7046fa0ef62" class="bulleted-list"><li style="list-style-type:disc"><code>regexm()</code> 函数在Stata中用于检测正则表达式匹配，并返回一个逻辑值（匹配时为1，不匹配时为0）<br/>这意味着，如果<br/><code>province==&quot;海南&quot;</code> 同样会被<code>replace region = 1</code>，因此上述代码同样适用于省份名称简写的数据集</li></ul></details></li></ul><ul id="f8d13440-4db0-4379-a9a0-dc1b8a490b07" class="toggle"><li><details open=""><summary>在Stata中计算距离某地的直线距离</summary><ul id="a98e363f-72e9-4971-a9cc-812ad6b2cf37" class="bulleted-list"><li style="list-style-type:disc">本例适用于，已有两个变量记录样本的经纬度，要计算到某一位置的直线距离（坐标已知，下方以故宫为例），最终将这个距离存储在一个新变量<code>dist</code>中</li></ul><ul id="6a56ea3d-7e40-4ce3-b894-4bb8ab28b68a" class="bulleted-list"><li style="list-style-type:disc">直线距离计算基于 Haversine公式</li></ul><ul id="626ccdef-898d-42b2-b4bf-8b275823ff15" class="bulleted-list"><li style="list-style-type:disc">坐标来自于<a href="https://api.map.baidu.com/lbsapi/getpoint/index.html">Baidu地图拾取坐标系统</a> </li></ul><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="e998d7cd-38fb-4fd9-bdcb-4abc8120c6e1" class="code"><code class="language-Plain Text">// 假设为企业样本，经纬度坐标分别记录在*经度*和*纬度*这两个变量里
ren (经度 纬度) (longitude latitude)

// 想要知道距离*故宫博物馆*的距离
scalar tour_lo = 116.403414
scalar tour_la = 39.924091
* 坐标拾取来源: https://api.map.baidu.com/lbsapi/getpoint/index.html

// Haversine Formula
scalar radius=6371 // radius of the earth(km)
scalar mu=`=c(pi)&#x27;/180
* Set the latitude and longitude of two coordinate points
local lat1  &quot;`=tour_la&#x27;&quot;
local long1 &quot;`=tour_lo&#x27;&quot;
local lat2  &quot;latitude&quot;
local long2 &quot;longitude&quot;
* Convert angles to radians
local deg2rad &quot;c(pi) / 180&quot;
local lat1_rad &quot;`lat1&#x27; * `deg2rad&#x27;&quot;
local long1_rad &quot;`long1&#x27; * `deg2rad&#x27;&quot;
local lat2_rad &quot;`lat2&#x27; * `deg2rad&#x27;&quot;
local long2_rad &quot;`long2&#x27; * `deg2rad&#x27;&quot;
* Calculate the spherical distance
local dlat &quot;(`lat2_rad&#x27;) - (`lat1_rad&#x27;)&quot;
local dlong &quot;(`long2_rad&#x27;) - (`long1_rad&#x27;)&quot;
local a &quot;sin((`dlat&#x27;) / 2)^2 + cos(`lat1_rad&#x27;) * cos(`lat2_rad&#x27;) * sin( (`dlong&#x27;) / 2)^2&quot;
local c &quot;2 * atan2(sqrt(`a&#x27;), sqrt(1 - (`a&#x27;)))&quot;
gen dist = `=radius&#x27; * `c&#x27;  

// number of firms within range
su dist // km
lab var dist &quot;距离（km）&quot;</code></pre></details></li></ul><h2 id="e4661d17-d014-4ae3-a1e3-26a1b9acba0d" class="">变量管理</h2><h3 id="926f6d72-afb0-4c1d-837d-a4c777e95eaf" class="">批量重命名</h3><ul id="0be9a7fa-bf4b-486d-96d4-3e144c6ca8c1" class="toggle"><li><details open=""><summary>批量重命名<code>rename</code></summary><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="6de9bd0a-aad4-4ffc-8d14-737fccea6487" class="code"><code class="language-Plain Text"> rename (old1 old2 ...) (new1 new2 ...)</code></pre><ul id="23b91b15-0cf1-43a5-8695-82fd552bea5e" class="bulleted-list"><li style="list-style-type:disc">批量重命名还可以帮助我们批量更改变量名称为小写，添加数字编号后缀，详见帮助文档<code>help rename group</code></li></ul></details></li></ul><h3 id="e455ece9-83cf-4003-afb8-8b95d4c5cdfc" class="">按类型筛选变量</h3><ul id="934808bb-f63e-410a-9d8a-9b23a958df39" class="toggle"><li><details open=""><summary>筛选 <code>ds</code></summary><ul id="1bbb9358-d923-40b6-8f6e-ee0271ba263a" class="bulleted-list"><li style="list-style-type:disc">例如，筛选所有var_为前缀的数值型变量，并将它们转为字符型</li></ul><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="2332be02-446d-4c00-8994-38cbf296383c" class="code"><code class="language-Plain Text">ds var_*, has(type numeric)
foreach vv of varlist r(varlist) {
	tostring `vv&#x27;, replace
}</code></pre><p id="98acb952-eca3-4e78-a687-0a226893a082" class="">
</p></details></li></ul><h3 id="bf62b23c-ef34-4844-8202-f1d889643cf3" class="">整理变量顺序</h3><ul id="db55982b-f1a2-4a2f-b044-2cbbe618a28c" class="toggle"><li><details open=""><summary>排序  <code>order</code></summary><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="f0a4eee4-0e62-48e5-ba23-00eb6f2a0749" class="code"><code class="language-Plain Text">order y x1 x2</code></pre><ul id="155e084b-0745-4916-bc7c-54cb0d11c06c" class="bulleted-list"><li style="list-style-type:disc">根据<code>varname</code>生成的变量<code>newvar</code>置于其后</li></ul><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="79c6c081-c242-4f19-b390-319c1e8e2fdc" class="code"><code class="language-Plain Text">gen newvar = varname^2
order newvar, after(varname)</code></pre></details></li></ul><h2 id="fbbef346-ba88-4dda-b2ce-249896b77e24" class="">样本处理</h2><h3 id="05203b83-f0d0-439c-86f3-80af22de1e0c" class="">样本缺失的处理</h3><ul id="22da35bc-8c85-476b-87ce-5c5ae3c88da6" class="toggle"><li><details open=""><summary>样本缺失在何时应当重视？以及如何处理？</summary><ul id="82678f07-f09a-448f-a60a-6ec18ac50061" class="bulleted-list"><li style="list-style-type:disc">An introduction to modern missing data analyses  (<a href="https://pubmed.ncbi.nlm.nih.gov/20006986/">Baraldi and Enders, 2011</a>)</li></ul><ul id="be548284-3e31-4964-832a-45888d237c93" class="bulleted-list"><li style="list-style-type:disc"><a href="https://academic.oup.com/biomet/article-abstract/63/3/581/270932">Rubin (1976)</a> and colleagues (<a href="https://onlinelibrary.wiley.com/doi/book/10.1002/9781119482260">Little &amp; Rubin, 2019</a>) came up with the classification system that is in use today: missing completely at random (MCAR), missing at random (MAR), and missing not at random (MNAR).</li></ul><ul id="68b2d0f1-d3f6-45f5-9076-d43f40793166" class="bulleted-list"><li style="list-style-type:disc">MCAR不会对统计推断产生影响，因此几乎没有处理的必要</li></ul><ul id="39d51013-65f6-472b-a609-5aaa6b40f4a6" class="bulleted-list"><li style="list-style-type:disc">MAR需要应用有效的统计学方法认真应对</li></ul><ul id="e020852e-7051-439c-b22a-73934c859e01" class="bulleted-list"><li style="list-style-type:disc">MNAR的处理应当具有economic concern</li></ul></details></li></ul><ul id="9c91dd60-5f60-4174-834e-3473f0bedc01" class="toggle"><li><details open=""><summary>统计缺失值</summary><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="b90a29c5-c9ab-42d3-893e-fe79d4747003" class="code"><code class="language-Plain Text">count // 报告全部样本数量
count if !missing(X) // X的有效值数量
di `r(N)&#x27;/`=_N&#x27; // 报告X的有效值占比</code></pre><ul id="1e48b9d6-f08b-4a6d-9828-27b3fafe25ba" class="bulleted-list"><li style="list-style-type:disc">或者</li></ul><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="4b04a7e5-eb9b-4ddb-9cd1-aa9a1b9c059c" class="code"><code class="language-Plain Text">gen missing_X = missing(X) // 取1为缺失值，取0为有效值
tab missing_X // 汇总缺失值标记变量
cap drop missing_X </code></pre><ul id="bd48d5e5-95b6-4081-a7e7-6bc452279324" class="bulleted-list"><li style="list-style-type:disc">如果 <code>X</code> 是离散变量，可以直接使用 <code>tab X, m</code></li></ul><ul id="fa1f631f-e644-40fc-8a91-f43aa7debd92" class="bulleted-list"><li style="list-style-type:disc">注意，在一些微观调查数据或者外部导入的非Stata创建的数据中，缺失值可能以其他数值形式储存，请检查数据来源的相关说明文档。</li></ul></details></li></ul><ul id="153cfe0f-85d9-4cba-b71c-dbf915f79f3c" class="toggle"><li><details open=""><summary>（同类）均值插补法</summary><ul id="83595df2-67ed-4af8-8bbb-8684c586fd28" class="bulleted-list"><li style="list-style-type:disc">均值插补（mean imputation）<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="1e0a0c77-25be-4560-81c5-27b26e19e4ae" class="code"><code class="language-Plain Text">foreach var of varlist var_* {
	qui sum `var&#x27;
	qui replace `var&#x27;=r(mean) if `var&#x27;==.
}</code></pre></li></ul></details></li></ul><ul id="ec2b3f51-d560-416e-b886-b2f896214566" class="toggle"><li><details open=""><summary>线性插值法</summary><ul id="03e4b771-5819-4317-9921-8488c483ca38" class="bulleted-list"><li style="list-style-type:disc">线性插值法是一种常用的填补缺失值的方法，它基于已知数据点之间的线性关系来估计缺失值。这种方法假设数据点之间的变化是线性的，即数据点之间的变化速率是恒定的。</li></ul><ul id="a81e9229-a8dd-4cdd-a443-ccd31271f4df" class="bulleted-list"><li style="list-style-type:disc">具体来说，线性插值法通过找到缺失值相邻的两个已知数据点，然后根据这两个点之间的线性关系来计算缺失值。这种方法的核心在于计算两个已知数据点之间的斜率和截距，然后根据这些参数来估计缺失值。</li></ul><ul id="e22192b0-6c64-42d7-aa22-b4b183d2e5ee" class="bulleted-list"><li style="list-style-type:disc">在Stata中可以使用<code>mipolate</code>命令来进行线性插值。</li></ul><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="f735599b-baf8-4f8b-ba0f-89f6ae94accd" class="code"><code class="language-Plain Text">bys group: mipolate varname year, gen(varname_new) linear // 线性插值法补齐数据</code></pre><ul id="84fdb058-fffe-4522-a817-a2fb40f7268d" class="bulleted-list"><li style="list-style-type:disc">或者</li></ul><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="ad199786-af57-42e4-9baf-e7eb53ffc720" class="code"><code class="language-Plain Text">bys group: mipolate varname year, gen(varname_new) linear epolate // 外推数据进行处理</code></pre><ul id="ad8ab305-6ac1-4b27-b1a4-ed2a4311c1db" class="bulleted-list"><li style="list-style-type:disc"><code>bys group</code>: 这个前缀意味着接下来的命令会按照 <code>group</code> 变量的不同值分组执行插值。</li></ul><ul id="02d443f2-8b2c-40b5-a585-d6f01a502d20" class="bulleted-list"><li style="list-style-type:disc"><code>mipolate varname year</code>: 这部分调用了一个名为 <code>mipolate</code> 的命令，并传递了两个参数：<code>varname</code> 和 <code>year</code>。<code>varname</code> 是我们希望进行插值的变量，而 <code>year</code> 用来确定插值顺序或作为插值基础的变量，通常是时间或者年份变量。</li></ul><ul id="e39ea315-fecc-4f33-aa49-1b882b832845" class="bulleted-list"><li style="list-style-type:disc"><code>, gen(varname_new)</code>: 这个选项指示 <code>mipolate</code> 命令生成一个新的变量 <code>varname_new</code>，该变量将包含插值后的结果。原始变量 <code>varname</code> 中的缺失值将在这个新变量中被估算的值替换。</li></ul><ul id="ba0a5c86-a355-47d8-985a-7d8c30317321" class="bulleted-list"><li style="list-style-type:disc"><code>linear</code>: 这个选项表明应该使用线性插值方法。线性插值是一种估算缺失值的方法，它通过在已知数据点之间绘制直线来估算缺失值。</li></ul><ul id="e0a37dd2-ac33-405b-8c1f-549928959e94" class="bulleted-list"><li style="list-style-type:disc"><code>epolate</code>: 默认情况下，如果不指定 <code>epolate</code>，某些插值方法（如线性、立方和样条插值）可能只会进行插值，而不会对外推数据进行处理。<br/>对变量列表 <br/><code>x1</code> <code>x2</code> <code>x3</code> 中的每一个变量执行线性插值（在原变量中替换）：</li></ul><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="0df4dace-901e-479f-a9f0-3a77ab50c671" class="code"><code class="language-Plain Text">// 线性插值法补齐数据
foreach x of varlist x1 x2 x3 {
	bys group: mipolate `x&#x27; year, gen(tmp) linear epolate 
	replace `x&#x27; = tmp
	drop tmp
}</code></pre></details></li></ul><ul id="690f4340-a529-4aa7-af9a-9b3f7ea2e65c" class="toggle"><li><details open=""><summary>多重插补</summary><ul id="8e1009ad-c718-4b0e-9cf4-e12dbee24a1f" class="bulleted-list"><li style="list-style-type:disc">待补充</li></ul></details></li></ul><ul id="ae7e995c-b378-4de3-aeff-4a2f8697d674" class="toggle"><li><details open=""><summary>删除缺失值太多的变量</summary><ul id="dc236635-cc75-4c6b-94ce-86b6015802ad" class="bulleted-list"><li style="list-style-type:disc">我定义了 <code>droptoomanymissingval</code> 程序来删除缺失值太多的变量</li></ul><ul id="5def27d8-8cf2-46f7-a2e7-4b88f6409cf9" class="bulleted-list"><li style="list-style-type:disc">选项 <code>threshold()</code>  内为非缺失值至少要占据的比例，<code>count</code> 指定后 <code>threshold()</code>  内应为非缺失值至少要占据的数量</li></ul><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="0cc14877-a929-4318-a6f9-1ef84e983ac6" class="code"><code class="language-Plain Text">// 删除缺失值太多的变量
cap program drop droptoomanymissingval
program define droptoomanymissingval
	syntax varlist(min=1), [Threshold(real .5) COUNT]
	* threshold &lt;- the proportion of valid values that at least one variable should possess.
	* count &lt;- if prescribed, threshold option denotes the least number of valid values.
	if &quot;`count&#x27;&quot;!=&quot;&quot; local threshold = `threshold&#x27;/`=_N&#x27;
	foreach var of varlist `varlist&#x27; {
		qui su `var&#x27;
		local nonmissingrate = `r(N)&#x27; / `=_N&#x27;
		if (`nonmissingrate&#x27; &gt; `threshold&#x27;) {
			drop `var&#x27;
		}
	} 
end</code></pre></details></li></ul><h3 id="e09c1bc9-b4b2-427d-a568-2076aff751b9" class="">异常样本的识别和处理</h3><ul id="d0a8f0f9-2cdd-42ae-9a53-826d24171b20" class="toggle"><li><details open=""><summary>异常样本的识别</summary><ul id="ebb19cb7-e8cd-4dea-867c-6860db1c47ff" class="toggle"><li><details open=""><summary>对连续变量，直接观察样本的统计特征</summary><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="69d5ca84-accb-4257-935a-6546c5f06b57" class="code"><code class="language-Plain Text">sum X, detail // 使用detai选项可能还会显示更多的百分位数（percentiles）
histogram X // 生成变量 X 的直方图，统计每个区间内的观测值数量</code></pre></details></li></ul><ul id="5503227e-7eb5-4775-94a8-2b3f904f34d9" class="toggle"><li><details open=""><summary>对离散变量，统计每个观测值的数量和频率</summary><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="fc37e3a3-1e12-4711-ade4-72991b914e3e" class="code"><code class="language-Plain Text">tab discrete_X, m // 报告每个观测值的数量和频率</code></pre></details></li></ul></details></li></ul><ul id="eec46b6e-6d51-4eee-814a-ad377f5baba7" class="toggle"><li><details open=""><summary>重复值的处理：缩尾 <code>winsor2</code></summary><ul id="35c7cc42-e9a0-4c1f-8e9a-09c3458ffe7f" class="bulleted-list"><li style="list-style-type:disc">请注意，<code>winsor2</code>不是Stata的官方命令。如果您还没有安装，可以通过运行<code>ssc install winsor2</code>的命令来完成</li></ul><ul id="f7261603-8b32-4468-94d7-e042331ad0e1" class="bulleted-list"><li style="list-style-type:disc">使用<code>winsor2</code>命令对每个变量<code>X1</code>、<code>X2</code>和<code>X3</code> 直接缩尾</li></ul><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="558a9202-7094-4266-92a4-cd604d1bb63d" class="code"><code class="language-Plain Text">// 缩尾
foreach x of varlist X1 X2 X3 {
	winsor2 `x&#x27; if year==`y&#x27;, replace cuts(5 95) trim
}</code></pre><ul id="24840b82-a9c7-4188-a86f-0713bd8320ab" class="bulleted-list"><li style="list-style-type:disc"><code>replace</code>：替换原有变量，而不是生成新变量</li></ul><ul id="ef4ffe2e-8b41-43d9-863b-439a8654096c" class="bulleted-list"><li style="list-style-type:disc"><code>trim</code>：执行截尾处理，将特定百分位数之外的数值替换为缺失值。如果不指定 <code>trim</code>，则默认执行缩尾处理</li></ul><ul id="d2c02706-5d83-4c58-8bfc-901022316210" class="bulleted-list"><li style="list-style-type:disc"><code>cuts(# #)</code>：指定缩尾或截尾的百分位数。例如，<code>cuts(5 95)</code> 表示将小于 5% 和大于 95% 的数值进行缩尾或截尾处理</li></ul><p id="58b7e501-58ce-4257-8fa5-2a7b209e9e3d" class="">对于面板数据，考虑到变量的时间趋势，上/下分位数据很可能出现在样本时间范围的起始或末尾，因此可以在特定年份<code>year</code>上进行缩尾处理</p><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="e42d174e-62da-4697-8621-82dbbcfa6395" class="code"><code class="language-Plain Text">// 缩尾
sum year
forval y = `=r(min)&#x27;/`=r(max)&#x27; {
	foreach x in x1 x2 x3 {
		winsor2 `x&#x27; if year==`y&#x27;, replace cuts(5 95) trim
	}
}</code></pre></details></li></ul><h3 id="1e458546-40f3-48f3-b2d7-23fb24a60f82" class="">重复值的识别和处理</h3><ul id="f746798a-1b25-4ab6-a1ad-f98d24149161" class="toggle"><li><details open=""><summary>重复值的识别</summary><ul id="1c5a4d73-40ae-4de0-b4bb-88a606cea768" class="bulleted-list"><li style="list-style-type:disc">列出重复观测值</li></ul><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="7444c9aa-6aa4-4d04-a4e0-03765451218e" class="code"><code class="language-Plain Text">duplicates list id value</code></pre><ul id="76f2ac0d-8c24-4e2b-a102-3025e9649147" class="bulleted-list"><li style="list-style-type:disc">标记重复观测值</li></ul><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="8b823276-d19a-464f-9ec0-fca97dc2bcfa" class="code"><code class="language-Plain Text">duplicates tag id value, generate(dup_tag)</code></pre><ul id="3fc559c9-9300-4ea3-ab23-44998263a2ec" class="bulleted-list"><li style="list-style-type:disc">查找特定变量的重复值</li></ul><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="d2188d7f-4886-4277-ab5f-4cd71e8d5a21" class="code"><code class="language-Plain Text">bysort id: duplicates list if _N &gt; 1</code></pre></details></li></ul><ul id="660ef114-b6a6-4167-b2db-642b836ef083" class="toggle"><li><details open=""><summary>重复值的处理</summary><ul id="28acf677-674b-4417-a48a-7910a70a1eb5" class="bulleted-list"><li style="list-style-type:disc">删除重复值</li></ul><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="7848c157-241f-4dcc-9af0-b90687d7c2c7" class="code"><code class="language-Plain Text">duplicates drop all</code></pre></details></li></ul><ul id="6b7fb655-b4ad-4ca8-8b73-afa784d8d595" class="toggle"><li><details open=""><summary>检查面板结构的重复</summary><ul id="9f63f0e1-dc55-4b6c-b3e8-9ec9b572404f" class="bulleted-list"><li style="list-style-type:disc">使用 <code>isid</code> 检查唯一性，适合检查面板数据的结构是否正确</li></ul><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="7518b89f-68c5-4b31-bfde-5097e591de7c" class="code"><code class="language-Plain Text">isid id year</code></pre><ul id="87a5b501-2e10-4cb6-8006-ec7d71d136bc" class="bulleted-list"><li style="list-style-type:disc">或者使用<code>assert</code>，尽管这样做会更改样本顺序</li></ul><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="73626323-04f0-4433-a196-134547be7c64" class="code"><code class="language-Plain Text">bys year id: assert _N==1</code></pre></details></li></ul><h3 id="88ee2904-fae3-4b2b-9744-24b36ee3b0af" class="">样本排序</h3><ul id="100e71ca-81c2-4f71-937b-b1552685cc53" class="toggle"><li><details open=""><summary>排序 <code>sort</code> 与<code>gsort</code></summary><ul id="40e8f74e-5daf-49e6-8997-5df509848547" class="bulleted-list"><li style="list-style-type:disc"><code>sort</code> 默认正序排序</li></ul><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="71a84b6b-511e-4a57-81c5-d32bb06a5f44" class="code"><code class="language-Plain Text">sort y x</code></pre><ul id="fac79ca7-b723-4c53-bc09-db45f67b857d" class="bulleted-list"><li style="list-style-type:disc"><code>gsort</code> 可用于倒序排序（变量前加上负号）</li></ul><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="51289275-dcaa-49db-8451-25276cecd774" class="code"><code class="language-Plain Text">gsort y -x</code></pre></details></li></ul><h2 id="fbe45015-37fc-4a95-9899-3c9ed96b6ad7" class="">样本管理</h2><h3 id="09bcd51d-6ab4-4873-a9d4-d8601b21070d" class="">样本标签</h3><ul id="4b59f65e-f224-4d4f-bc00-a0dae7ab7796" class="toggle"><li><details open=""><summary><code>label value</code></summary><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="05f44e95-6bf4-4145-aef3-7ceed880f7cf" class="code"><code class="language-Plain Text">label define gender 1 &quot;男&quot; 0 &quot;女&quot;
label value gender gender</code></pre></details></li></ul><h2 id="d1232a94-aa89-41b1-a926-95f0b60c6933" class="">文件管理</h2><h3 id="9572cb48-9fb4-434d-b068-275c99a9face" class="">创建和删除文件夹</h3><ul id="3c0698ca-a81b-485b-a681-18122e7518e1" class="toggle"><li><details open=""><summary>创建和删除文件夹</summary><ul id="83c290c0-d52d-4af4-ab69-74c715885078" class="bulleted-list"><li style="list-style-type:disc">可以使用<code>mkdir</code>和<code>rmdir</code>命令来分别创建和删除文件夹</li></ul><ul id="d940a425-f319-40ad-be83-278b1d5cb9e3" class="bulleted-list"><li style="list-style-type:disc">在Windows系统中还可以使用<code>!mkdir</code>和<code>!rmdir</code>命令来分别创建和删除文件夹，区别是这一过程是通过调用操作系统的命令行工具来实现的</li></ul><ul id="5c4c22a5-d769-4d8b-8e7b-b0128e1f3260" class="bulleted-list"><li style="list-style-type:disc"><code>!mkdir</code>和<code>!rmdir</code>命令的另一个优势是，除目录本身外，还将删除指定目录下的所有子目录和文件，而<code>rmdir</code>命令会在此时报错停止。例如<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="5caa6684-3661-437a-a631-e9107610b6f3" class="code"><code class="language-Plain Text">!rmdir /s /q foldername</code></pre><ul id="47406a99-df18-421a-a2e4-5e5688c8cf0a" class="bulleted-list"><li style="list-style-type:circle">这里的<code>/s</code>选项表示递归删除文件夹及其内容，<code>/q</code>选项表示在删除过程中不提示确认</li></ul></li></ul><ul id="470b0dcc-e61f-45f9-818b-af121760e375" class="bulleted-list"><li style="list-style-type:disc">使用<code>rmdir</code>或<code>!mkdir</code>命令时需要格外小心，因为它们会永久删除文件或文件夹！</li></ul></details></li></ul><h3 id="e36a99d1-01fc-4eee-b4cc-ce2ff6dd4da6" class="">删除文件</h3><ul id="2aebeef0-4fd1-4bc0-acc1-9eb45b496bb6" class="toggle"><li><details open=""><summary>删除临时文件</summary><ul id="640ef676-9f2d-4767-9053-e009b6e7b88a" class="bulleted-list"><li style="list-style-type:disc">删除单个文件<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="2d86642d-1d84-4e9d-9eb5-b3457ec548ff" class="code"><code class="language-Plain Text">cap erase &quot;temp_data.dta&quot;</code></pre></li></ul><ul id="40158756-5505-4d7d-8981-a3be905ecdbb" class="bulleted-list"><li style="list-style-type:disc">删除多个文件<ul id="391064b4-1850-4345-939d-fbbd70a3c887" class="bulleted-list"><li style="list-style-type:circle">不含子文件夹</li></ul><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="88dc56d1-f385-453c-8f51-8e6cff006fcf" class="code"><code class="language-Plain Text">local folderpath &quot;.&quot; // 要操作的文件夹
local prefix &quot;temp_&quot; // 要删除的文件前缀
local suffix &quot;.dta&quot; // 要删除的文件后缀

// 列出文件夹中的所有文件和子文件夹
local filelist : dir &quot;`folderpath&#x27;&quot; files &quot;`prefix&#x27;*.`suffix&#x27;&quot;, respectcase

// 遍历文件，删除前缀为`prefix&#x27;的文件
foreach ff in `filelist&#x27; {  
	if strpos(&quot;`ff&#x27;&quot;, &quot;`prefix&#x27;&quot;) == 1 {  
		cap erase &quot;`folderpath&#x27;\\`ff&#x27;&quot;  
	}
}</code></pre></li></ul><ul id="0ea8a0ef-21db-489e-8d8b-51a13859c228" class="bulleted-list"><li style="list-style-type:disc">我定义了一个 <code>delete_temp_files</code> 程序，通过递归的方式删除特定文件夹（及其子文件夹）中所有以给定前缀开头，并以后缀结尾的文件<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="bdbb9ca7-c36d-4cb3-8a74-4cd530701920" class="code"><code class="language-Plain Text">// 删除临时文件
cap program drop delete_temp_files
program define delete_temp_files
	args folderpath prefix suffix

	// 列出文件夹中的所有文件和子文件夹
	local filelist : dir &quot;`folderpath&#x27;&quot; files &quot;`prefix&#x27;*.`suffix&#x27;&quot;, respectcase
	local subfolderlist : dir &quot;`folderpath&#x27;&quot; dirs &quot;*&quot;, respectcase

	// 遍历文件，删除前缀为`prefix&#x27;的文件
	foreach ff in `filelist&#x27; {  
		if strpos(&quot;`ff&#x27;&quot;, &quot;`prefix&#x27;&quot;) == 1 {  
			cap erase &quot;`folderpath&#x27;\\`ff&#x27;&quot;  
		}
	}
	
  // 递归处理子文件夹  
	foreach subsub in `subfolderlist&#x27; {  
		delete_temp_files &quot;`folderpath&#x27;\\`subsub&#x27;&quot; &quot;`prefix&#x27;&quot; &quot;`suffix&#x27;&quot;
	}
end

delete_temp_files &quot;./temp_files&quot; &quot;temp_&quot; &quot;.dta&quot;</code></pre><ul id="a5aa3ae1-f9fe-41f8-84ec-a330bc6088ed" class="bulleted-list"><li style="list-style-type:circle">参数解释如下：<ul id="b7d5c9bd-764f-4298-9823-4bcc8f942c74" class="bulleted-list"><li style="list-style-type:square"><code>&quot;./temp_files&quot;</code> 是你想要搜索并删除文件的文件夹路径</li></ul><ul id="78e9eebd-ec70-45ca-a8e1-dd3f654148d7" class="bulleted-list"><li style="list-style-type:square"><code>&quot;temp_&quot;</code> 是文件名的前缀。</li></ul><ul id="f9fdc77b-bd39-48e5-a068-6006528c9f62" class="bulleted-list"><li style="list-style-type:square"><code>&quot;.dta&quot;</code> 是你想要删除文件的文件后缀。</li></ul></li></ul></li></ul></details></li></ul><p id="e426c66f-da95-477e-9435-d667e1ae68b2" class="">
</p><hr id="e051f10e-bb29-4fc8-90ea-7fbb588490ef"/><h1 id="f772634d-5036-4c80-aa62-eb12ce3b8968" class=""><span style="border-bottom:0.05em solid">3 初步分析</span></h1><h3 id="1a8cdfe7-8d6e-472e-9a3f-ce9cc77c41c2" class="">描述性统计</h3><ul id="da3eeec4-a03d-40eb-81e8-738ae2852996" class="toggle"><li><details open=""><summary>使用<code>tabstat</code> 直接展示</summary><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="04a41e1b-05e5-493a-be19-8965f3df4ffc" class="code"><code class="language-Plain Text">tabstat y x1 x2 x3, s(N mean p50 sd min max) f(%12.3f) c(s) // 描述性统计</code></pre></details></li></ul><ul id="c0b91487-18b9-491e-b553-530e28c60dc4" class="toggle"><li><details open=""><summary>使用<code>sum2docx</code>导出到外部文档</summary><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="2f8c052f-ea48-4b4d-b392-cada4db51d33" class="code"><code class="language-Plain Text">// 描述性统计
local format1 %9.3f
sum2docx y x1 x2 x3 using &quot;table.docx&quot;, replace stats(N mean(`format1&#x27;) sd(`format1&#x27;) min(`format1&#x27;) median(`format1&#x27;) max(`format1&#x27;))</code></pre></details></li></ul><ul id="0513c990-c7d6-4dcf-8a5a-d6ad735f3bb1" class="toggle"><li><details open=""><summary>报告样本与回归模型对齐</summary><ul id="5214a330-fd3c-4fe5-a448-54b1cadfbc51" class="bulleted-list"><li style="list-style-type:disc">Stata会在回归时默认取所有变量非缺失样本的交集为样本，而描述性统计则不会。这会让描述性统计与实际分析的样本有偏差</li></ul><ul id="c557cbcd-a6ba-404c-b619-87633dcc0a9f" class="bulleted-list"><li style="list-style-type:disc">我们可以将描述性统计置于回归之后，来解决这一问题</li></ul><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="14d1553c-d32a-44a0-afec-b40d0861985a" class="code"><code class="language-Plain Text">reg y c $covariates
tabstat y c $covariates if e(sample), s(N mean p50 sd min max) f(%12.3f) c(s) // 描述性统计</code></pre></details></li></ul><h3 id="fa3dacc3-69c6-443a-ae38-35104366a08b" class="">相关性分析</h3><ul id="6d3dfffb-41c0-4d7f-8b3c-d20148740ab3" class="toggle"><li><details open=""><summary>相关系分析</summary><ul id="ef33ef49-a6ec-4d8d-af87-aa4438d8a32c" class="bulleted-list"><li style="list-style-type:disc">Pearson 相关系数 <code>pwcorr</code></li></ul><ul id="252c7c3f-b267-4323-b38e-bba2d976d5e4" class="bulleted-list"><li style="list-style-type:disc">Spearman 相关系数 <code>spearman</code> </li></ul><ul id="19027f3a-47fe-4a83-9427-ccc20e508979" class="bulleted-list"><li style="list-style-type:disc"><code>asdoc</code> 导出</li></ul><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="0d6446c8-69b8-4136-851c-f942f49705b6" class="code"><code class="language-Plain Text">asdoc pwcorr Y X1 X2 X3 X4 X5, star(all) nonum save(corr.doc) replace</code></pre></details></li></ul><ul id="1e653420-ce02-44c7-9ae1-e5ac3217fe92" class="toggle"><li><details open=""><summary>用热力图绘制相关系数</summary><ul id="ad677474-8635-4fa3-b694-4ba8187ddf5e" class="bulleted-list"><li style="list-style-type:disc">生成一个示例的数据集</li></ul><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="a377daa3-4a86-49e3-a8b6-3cdc688244d6" class="code"><code class="language-Plain Text">clear all
set obs 1000 // 设置观测数，这里我们生成1000个观测值作为示例  
  
// 定义均值向量（假设每个变量的均值都为0）  
matrix mu = (0,0,0,0,0,0)  
  
// 定义协方差矩阵，这里我们使用一个简单的例子  
matrix Sigma = (1,   0.5, 0.4, 0.3, 0.2, 0.1 \ ///  
                0.5, 1,   0.4, 0.3, 0.2, 0.1 \ ///  
                0.4, 0.4, 1,   0.3, 0.2, 0.1 \ ///  
                0.3, 0.3, 0.3, 1,   0.2, 0.1 \ ///  
                0.2, 0.2, 0.2, 0.2, 1,   0.1 \ ///  
                0.1, 0.1, 0.1, 0.1, 0.1, 1)  
  
// 使用drawnorm命令生成相关随机变量  
// 注意：drawnorm命令需要Stata 12或更高版本，并且可能需要安装（通过ssc install drawnorm）  
drawnorm Y X1 X2 X3 X4 X5, means(mu) cov(Sigma) clear  
  
// 查看生成的数据  
list</code></pre><ul id="e05e49c6-8d36-412c-9aa0-9c5f110ba739" class="bulleted-list"><li style="list-style-type:disc">用热力图绘制相关系数</li></ul><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="0deee741-17ea-4cc0-8c08-dc7fb0cc7378" class="code"><code class="language-Plain Text">// 用热力图绘制相关系数
pwcorr Y X1 X2 X3 X4 X5, sig
mat C = r(C)
mat S = r(sig)
scalar num_degree = rowsof(C)

heatplot C, upper nodiagonal gen replace // nopreserve
ren (_Y _X _Z) (add_Yshape add_Xshape add_Z)

local add_corrcoef ///
sc add_Yshape add_Xshape if add_Z!=., mlabel(add_Z) msymbol(i) mlabposition(0) msize(small) mlabcolor(gs2) mlabformat(%9.3f)  

local pos_col navy
local neg_col olive_teal
local color_space &quot;`neg_col&#x27; `neg_col&#x27;*.8 `neg_col&#x27;*.6 `neg_col&#x27;*.4 `neg_col&#x27;*.2 gs12 `pos_col&#x27;*.2 `pos_col&#x27;*.4 `pos_col&#x27;*.6 `pos_col&#x27;*.8 gs8%10&quot; //`pos_col&#x27;

heatplot C, cuts(-1.1(0.2)1.1) size srange(0.95 0.95) /// levels(11)
	lower ` nodiagonal&#x27; values(label(S)transform(cond(@&lt;.01, &quot;***&quot;, cond(@&lt;.05, &quot;**&quot;, cond(@&lt;.01, &quot;*&quot;, &quot;&quot;))))color(gs2)size(vsmall)) ///format(%fmt)
	colors(`color_space&#x27;) /// colors(economist,gs reverse)
	addplot(`add_corrcoef&#x27;) ///
	xtitle(&quot;&quot;)ytitle(&quot;&quot;)xlabel(,noticks nolabels)ylabel()xscale(noline)yscale(noline) ///
	legend(`order(4 &quot;***&quot; 3 &quot;**&quot; 2 &quot;*&quot; 1 &quot;none&quot;)&#x27;subtitle(&quot;{fontface 宋体:相关系数}&quot;,size(small))) ///
	scheme(white)xsize(20)ysize(13)graphregion(fcolor(none)lcolor(none)ifcolor(none)ilcolor(none))plotregion(margin(zero)) 
*注：此图呈现了相关系数矩阵的热力图表示：颜色表示了相关系数的方向，蓝色表示正相关，绿色表示负相关；颜色的深浅表示相关性的强度，颜色越深，相关性越强，颜色越浅，相关性越弱；图中，右上三角位置报告的是相关系数，左下三角报告的是相关系数的检验结果，***、**和*分别表示在1%、5%和10%的水平下显著。</code></pre><ul id="3087abf9-e418-4944-8d55-fdbb626d69d4" class="bulleted-list"><li style="list-style-type:disc">绘制效果：</li></ul><p id="a24165bf-feb6-431e-846a-3d19b7eaec9b" class="">
</p><figure id="9205c231-0167-4dde-8e83-3e6de5156fec" class="image" style="text-align:center"><a href="Graph.svg"><img style="width:528px" src="Graph.svg"/></a></figure></details></li></ul><h3 id="3dfab92e-052a-474c-b95f-65b0c3ca3f48" class="">一重差分</h3><ul id="8f11ba11-d0ef-4bd8-84e7-37fcedbaf98e" class="toggle"><li><details open=""><summary>双样本 t 检验</summary><ul id="77321592-f167-4b97-8e83-19eb88c325fe" class="bulleted-list"><li style="list-style-type:disc">这里定义程序 <code>singlediff</code> 进行双样本 t 检验<ul id="215e2895-7105-46a4-93b4-e46043de2cad" class="bulleted-list"><li style="list-style-type:circle"><code>singlediff varname, [cond1(string) cond2(string)] </code><ul id="dab7585e-b9ae-4909-8fb9-b81b367cf78b" class="bulleted-list"><li style="list-style-type:square"><code>varname</code> ：需要分析的变量</li></ul><ul id="92d8f632-6637-409c-9a91-d48b7d6d460e" class="bulleted-list"><li style="list-style-type:square"><code>cond1</code> <code>cond2</code> ：分组的条件</li></ul></li></ul></li></ul><ul id="17966660-402d-4246-814b-a0259fdea92e" class="bulleted-list"><li style="list-style-type:disc">基于 <code>ttesti</code>，这一方式能够展示更丰富的细节信息</li></ul><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="e891536b-f6c1-402d-9e0e-05af143b8872" class="code"><code class="language-Plain Text">// t-statistic calculation procedure
cap program drop singlediff
program define singlediff
	syntax varlist(min=1 max=1), [COND0(string) COND1(string)]
	tokenize `varlist&#x27;
	local diffvar `1&#x27;
	
	// sort condition
	if &quot;`cond0&#x27;&quot;==&quot;&quot; local cond0 &quot;group==0&quot;
	if &quot;`cond1&#x27;&quot;==&quot;&quot; local cond1 &quot;group!=0&quot;
	
	// calculate t-statistic
	qui su `diffvar&#x27;
	qui su `diffvar&#x27; if `cond0&#x27;
		local obs0 = r(N)
		local mean0 = r(mean)
		local sd0 = r(sd)
	qui su `diffvar&#x27; if `cond1&#x27;
		local obs1 = r(N)
		local mean1 = r(mean)
		local sd1 = r(sd)
	ttesti `obs0&#x27; `mean1&#x27; `sd0&#x27; `obs1&#x27; `mean1&#x27; `sd1&#x27;
end</code></pre><ul id="ca0f1f32-65c4-4981-8c97-0e5f83ffd148" class="bulleted-list"><li style="list-style-type:disc">基于回归模型的，这方式能够提供更丰富的 t 值计算方式</li></ul><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="d9f65f0c-9f13-46ae-9de1-fc516b86f0ce" class="code"><code class="language-Plain Text">// t-statistic calculation procedure
cap program drop singlediff
program define singlediff
	syntax varlist(min=1 max=1), [COND0(string) COND1(string) VCE(string)]
	tokenize `varlist&#x27;
	local diffvar `1&#x27;

	// sort condition
	if &quot;`cond0&#x27;&quot;==&quot;&quot; local cond0 &quot;group==0&quot; // control group
	if &quot;`cond1&#x27;&quot;==&quot;&quot; local cond1 &quot;group!=0&quot; // treatment group
	tempvar sortcond
	gen `sortcond&#x27; = cond(`cond0&#x27;, 0, cond(`cond1&#x27;, 1, .))

	// calculate t-statistic
	qui su `diffvar&#x27;
	su `diffvar&#x27; if `cond0&#x27;
		local obs0 = r(N)
		local mean0 = r(mean)
		local sd0 = r(sd)
	su `diffvar&#x27; if `cond1&#x27;
		local obs1 = r(N)
		local mean1 = r(mean)
		local sd1 = r(sd)
	if &quot;`vce&#x27;&quot;==&quot;&quot; local vcetype &quot;&quot;
	else local vcetype &quot;vce(`vce&#x27;)&quot;
	qui regress `diffvar&#x27; `sortcond&#x27;, `vcetype&#x27;
	di &quot;t stat. = &quot; `=_b[`sortcond&#x27;]/_se[`sortcond&#x27;]&#x27;
end
</code></pre></details></li></ul><p id="1e3f5a10-4a55-43b0-a6de-1fcd75523a8f" class="">
</p><hr id="5d2662e6-91dd-4459-984f-6702821c9c15"/><h1 id="3204c97d-a488-45b9-ab36-5c6e2a82248f" class=""><span style="border-bottom:0.05em solid">4 回归分析</span></h1><h2 id="0711f17a-37c7-4755-9827-3a6e70ae61f1" class="">基准回归</h2><h3 id="6a0dcc7c-ba3e-4c6b-b506-abe3cbcd02f3" class="">OLS</h3><ul id="1e4aae88-838e-4c2f-8cb5-62f6a0a084da" class="toggle"><li><details open=""><summary>提升运算效率的几点建议</summary><ul id="6fda2f0f-b23e-492c-af8a-74bbe385a818" class="bulleted-list"><li style="list-style-type:disc"><code>regress</code>比<code>reg</code>可以节约至少三倍的时间（可能因计算机性能而异）</li></ul><ul id="bd424026-b11c-4aa1-b890-4b8eda09add7" class="bulleted-list"><li style="list-style-type:disc">使用<code>reghdfe</code>控制固定效应效率更高，多次对百万级样本下<code>reghdfejl</code> 效率更高 <a href="https://mp.weixin.qq.com/s/FBy8qso-ctVECK36-AsLTA">[安装与使用]</a></li></ul></details></li></ul><ul id="dc8bed5b-8a04-4b44-a0f8-a3a56d898c46" class="toggle"><li><details open=""><summary>控制新变量后样本损失</summary><ul id="b28449cd-f7ae-49b2-9c4b-73e6cc958e3a" class="bulleted-list"><li style="list-style-type:disc">使用回归模型时，Stata可以帮助我们自动剔除剔除缺失样本（pairwise deletion），这能最大化样本的使用效率</li></ul><ul id="4a65b6bb-eab6-47ac-a2b9-8e80694fc371" class="bulleted-list"><li style="list-style-type:disc">事实上我们有更多应对缺失值的处理方法，比如 MLE 估计和多重插补</li></ul><ul id="9ff63cb5-8ba1-4ec0-b2c9-c7dc05ec7eb2" class="bulleted-list"><li style="list-style-type:disc">个人更推崇的做法是listwise delection，也就是事先将数据集中所有任意变量取值缺失的样本都剔除<ul id="a7065a1a-7312-475f-9aff-46f6ce9570a2" class="bulleted-list"><li style="list-style-type:circle">例如，可以这样做<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="46952c25-acdf-4a3f-94fd-eff0ac06e0ec" class="code"><code class="language-Plain Text">reg y x1 x2 x3
gen listwise = e(sample)

reg y x1 if listwise 
reg y x1 x2 if listwise 
reg y x1 x2 x3 if listwise </code></pre></li></ul><ul id="5e8e7ba0-5644-4de9-a73a-f3d66a7eeaaa" class="bulleted-list"><li style="list-style-type:circle">这一方式的好处是汇报的样本数量更对齐，描述性统计也更具有针对性</li></ul><ul id="0fd8e5ff-ac04-45f3-9e1f-22657b9c68b0" class="bulleted-list"><li style="list-style-type:circle"><a href="https://www.ibm.com/support/pages/pairwise-vs-listwise-deletion-what-are-they-and-when-should-i-use-them">Pairwise vs. Listwise deletion: What are they and when should I use them?</a> </li></ul></li></ul><ul id="9613e94d-43f7-40b3-a00b-213064ec76e6" class="bulleted-list"><li style="list-style-type:disc">更多关于样本缺失的处理： <a href="https://stefvanbuuren.name/fimd/want-the-hardcopy.html">Flexible Imputation of Missing Data</a></li></ul><ul id="48cc3077-d940-4344-892f-a01c876e4f96" class="bulleted-list"><li style="list-style-type:disc">上述处理适用于因数据可得性造成的缺失；如果样本的缺失带有 economic concern，那需要严肃对待其中的内生性问题</li></ul></details></li></ul><h3 id="6f1fbbc0-82fe-4b6a-a03d-f72f5bd6434a" class="">控制变量</h3><ul id="e3a24727-246a-4e22-be55-3ff89628b286" class="toggle"><li><details open=""><summary>Insights</summary><ul id="3c2f67df-070c-45cb-bbf9-e0c82c2fcc67" class="bulleted-list"><li style="list-style-type:disc">优先选择与文献一致的控制变量</li></ul><ul id="d8717dc2-dc2e-4f1b-ba15-0db6629b82f8" class="bulleted-list"><li style="list-style-type:disc">选择控制变量的建议参考：<a href="https://mp.weixin.qq.com/s/ehIAs5BRQB4En4v7DE3huA">Good controls v.s. bad controls</a></li></ul><ul id="3676bb3c-c3e5-442d-a30f-16645bace72f" class="bulleted-list"><li style="list-style-type:disc">谨慎处理控制变量的缺失值引起的sample attrition问题</li></ul></details></li></ul><ul id="2038f1f6-299a-4682-8667-e333938445b6" class="toggle"><li><details open=""><summary>Good controls v.s. bad controls</summary><figure id="6da6aac8-04b1-4490-8a57-157d47daf805"><a href="https://mp.weixin.qq.com/s/ehIAs5BRQB4En4v7DE3huA" class="bookmark source"><div class="bookmark-info"><div class="bookmark-text"><div class="bookmark-title">【笔记分享】“好”和“坏”控制变量的一堂速成课</div><div class="bookmark-description">有些变量加入回归方程后，会在回归系数与该系数预期代表的效果之间产生意想不到的差异，这类变量被称为“bad controls”，与之相反的则称为“good controls”。</div></div><div class="bookmark-href"><img src="https://res.wx.qq.com/a/wx_fed/assets/res/MjliNWVm.svg" class="icon bookmark-icon"/>https://mp.weixin.qq.com/s/ehIAs5BRQB4En4v7DE3huA</div></div><img src="https://mmbiz.qpic.cn/sz_mmbiz_jpg/KAMytQfNaMM4oWskTyia7RJiblicg88lUveoMzynZp42TtRh1jfiaJnPJRkwLiaRuSjPD8Lyz9owdCaBtDHXgKQxp1Q/0?wx_fmt=jpeg" class="bookmark-image"/></a></figure></details></li></ul><ul id="fa959676-626a-479f-815b-28cefe95b7f9" class="toggle"><li><details open=""><summary>机器学习方法筛选控制变量</summary><ul id="31ba5687-66a6-4223-9969-caa31087ef2a" class="toggle"><li><details open=""><summary>Lasso回归</summary></details></li></ul></details></li></ul><ul id="d26e15e0-bacd-42fa-bc84-1a0e305fec87" class="toggle"><li><details open=""><summary><em>p</em>-hacking: <code>oneclick</code> 及其拓展</summary><ul id="672b393e-4227-4785-a86a-d173daefd502" class="bulleted-list"><li style="list-style-type:disc"><code>oneclick</code>介绍</li></ul><figure id="47597e93-826a-4ddd-9349-366244a57585"><a href="https://www.bilibili.com/video/BV1qL41117ep/?share_source=copy_web&amp;vd_source=bc9c539ccb1d2b7c076a42030004d4d4" class="bookmark source"><div class="bookmark-info"><div class="bookmark-text"><div class="bookmark-title">「oneclick5.0」Stata一键显著命令更新，大幅提升运行速度！_哔哩哔哩_bilibili</div><div class="bookmark-description">oneclick5.0震撼来袭！！！, 视频播放量 80199、弹幕量 15、点赞数 1664、投硬币枚数 1116、收藏人数 2965、转发人数 1088, 视频作者 拿铁一定要加冰, 作者简介 XMU会计学博士生。公众号: OneStata。，相关视频：【Stata】手把手教你控制显著性，Stata实证分析论文实证一键完成，调显著！一键显著教学，数据不显著怎么办？回归结果不显著怎么办？调整数据骚操作第一期---行行出状元大法！【Stata】，Stata | 快速完成毕业论文和学术论文的实证分析（描述性统计 相关性检验 共线性诊断 豪斯曼检验 滞后效应 调节效应  中介效应 分组回归 控制个体、时间），【Stata】一键显著OneClick4.2小小小更新，Oneclick包本地安装，Stata面板数据处理——什么是面板数据？，「Stata」从CSMAR整理来的常用控制变量数据集（快进来白嫖），stata实证分析stata论文实证一键输出</div></div><div class="bookmark-href"><img src="https://i2.hdslb.com/bfs/archive/7cf54832142720f30a5062f105d5a2449634953e.jpg@100w_100h_1c.png@57w_57h_1c.png" class="icon bookmark-icon"/>https://www.bilibili.com/video/BV1qL41117ep/?share_source=copy_web&amp;vd_source=bc9c539ccb1d2b7c076a42030004d4d4</div></div><img src="https://i2.hdslb.com/bfs/archive/7cf54832142720f30a5062f105d5a2449634953e.jpg@100w_100h_1c.png" class="bookmark-image"/></a></figure><ul id="2ef7b9c5-57c9-43d6-93e0-566a1915d40f" class="bulleted-list"><li style="list-style-type:disc"><code>oneclick</code> 会把结果储存在外部数据，因此我进行了扩展，把结果保存在新的变量里</li></ul><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="0975f730-5a03-40fa-8f70-a467f2283d63" class="code"><code class="language-Plain Text">// input your data


// define several candidates as dependent variable


// claim your potenial control variables
local ctrlvar &quot;aaa bbb ccc ddd eee&quot; 

capture program drop bin_transfer
program define bin_transfer, rclass
	version 14
	args dec_num
	local bin_num &quot;&quot;
	local remainder 0
	while `dec_num&#x27; &gt; 0 {
		local remainder = mod(`dec_num&#x27;, 2)
		local bin_num &quot;`remainder&#x27;`bin_num&#x27;&quot;
		local dec_num = floor(`dec_num&#x27;/2)
	}
	return local binary &quot;`bin_num&#x27;&quot;
end

tokenize &quot;`ctrlvar&#x27;&quot;
local CtrlLen = wordcount(&quot;`ctrlvar&#x27;&quot;)
local temp = ustrregexra(&quot;`ctrlvar&#x27;&quot;,&quot; &quot;,&quot;&quot;)
local Lenth = 2^`CtrlLen&#x27;
forvalues i = 1/`Lenth&#x27; {
	local Combo &quot;&quot;
	bin_transfer `i&#x27;
	forvalues j = 1/`CtrlLen&#x27; {
		if substr(r(binary),-`j&#x27;,1) == &quot;1&quot; {
			local addword &quot;``j&#x27;&#x27;&quot;
			local Combo &quot;`Combo&#x27; `addword&#x27;&quot;
		}
	}
	local Combo`i&#x27; &quot;`Combo&#x27;&quot;
}
* note: each combination of control variables is remembered in Combo`i&#x27; as local name.


// loop for recording each model
gen cmd_used = &quot;&quot;
gen b_xxx = .
gen pval_xxx = .
* note: replace the name of your interested variable to &quot;xxx&quot; here.


local counter = 1
foreach depvar of varlist depvar* { // put the list of dependent variable
foreach indepvar of varlist xxx { // put the name of independent variable (or a list of them if any)
forvalues i = 1/`Lenth&#x27; { // cvlist
foreach abstype in &quot;abs(fe1 fe2)&quot; &quot;abs(fe1 fe2 fe3)&quot; { // FEs can also be free of choice, if reasonable
foreach vcetype in &quot;vce(cl clvar1)&quot; &quot;vce(r)&quot;  { // SE type can also be free of choice, if reasonable

	* di &quot;`Combo`i&#x27;&#x27;&quot;
	
	reghdfe `depvar&#x27; `indepvar&#x27; `Combo`i&#x27;&#x27;, `abstype&#x27; `vcetype&#x27; 
	
	replace cmd_used = &quot;reghdfe `depvar&#x27; `indepvar&#x27; `Combo`i&#x27;&#x27;, `abstype&#x27; `vcetype&#x27;&quot; in `counter&#x27;
	replace b_xxx = _b[xxx] in `counter&#x27;
	replace pval_xxx = 2*ttail(e(df_r),abs(_b[xxx]/_se[xxx])) in `counter&#x27;
	
	local counter = `counter&#x27; + 1
}
}
}
}
}


// now selecting the your favorite model setting
gsort -pval_xxx
br cmd_used b_* pval_* if 1 ///
	&amp; b_xxx&gt;0 ///
	&amp; pval_xxx&gt;0 //
*</code></pre></details></li></ul><h3 id="a8471794-0f61-438c-8c39-e43a2c605ed3" class="">固定效应</h3><ul id="1cedee35-2304-4017-ab52-5a819aca4d42" class="toggle"><li><details open=""><summary>使用<code>reghdfe</code>添加固定效应</summary><figure id="bf18ade4-cf21-4cef-b6dd-4bd8be9da8c4"><a href="https://www.bilibili.com/video/BV1w7411j7ar/?share_source=copy_web&amp;vd_source=bc9c539ccb1d2b7c076a42030004d4d4" class="bookmark source"><div class="bookmark-info"><div class="bookmark-text"><div class="bookmark-title">Stata命令reghdfe(高维固定效应回归)_哔哩哔哩_bilibili</div><div class="bookmark-description">参考：https://zhuanlan.zhihu.com/p/96691029往期视频：Stata的areg命令讲解 av84078124解决内生性(2)——固定效应模型 av82150391解决内生性(5)——多时点DID av89878494, 视频播放量 60960、弹幕量 45、点赞数 801、投硬币枚数 382、收藏人数 1229、转发人数 233, 视频作者 silencedream, 作者简介 兴趣使然（视频目录：http://silencedream.gitee.io/），相关视频：Stata实现固定效应,areg、reg、reghdfe、xtreg、有区别吗？，固定效应模型，xtreg还是reghdfe？，reg还是xtreg？固定效应模型原理及stata操作，Stata基础-个体、时间、行业、省份的固定效应，选择个体固定效应模型还是时间还是双向固定效应？一看就懂！stata，STATA|保姆级实证全程操作-小白专享-企业面板数据固定效应回归分析，全程教学|数据下载、合并清理、收尾、相关性、共线性、Hausman、回归、稳健性、异质性，面板数据4 模型简介：混合模型、固定效应模型和随机效应模型，Stata基础：固定效应模型，Stata虚拟变量：行业/年份固定效应，Stata基础-控制省份固定效应</div></div><div class="bookmark-href"><img src="https://i2.hdslb.com/bfs/archive/ace232606b92638014fae61076a324f4a669702e.jpg@100w_100h_1c.png@57w_57h_1c.png" class="icon bookmark-icon"/>https://www.bilibili.com/video/BV1w7411j7ar/?share_source=copy_web&amp;vd_source=bc9c539ccb1d2b7c076a42030004d4d4</div></div><img src="https://i2.hdslb.com/bfs/archive/ace232606b92638014fae61076a324f4a669702e.jpg@100w_100h_1c.png" class="bookmark-image"/></a></figure></details></li></ul><ul id="d697682d-0dab-4550-acfd-73627e936448" class="toggle"><li><details open=""><summary>共线性的处理方法</summary><ul id="86c90e1d-1126-4026-991f-86d92c0884f0" class="toggle"><li><details open=""><summary>i) 合并处理组别</summary><ul id="8c78215d-2f69-4454-9df0-38d80538f28e" class="bulleted-list"><li style="list-style-type:disc">例如，<a href="https://www.aeaweb.org/articles?id=10.1257/mac.2.4.158">Nunn &amp; Trefler (2010, AEJ Macro)</a> 中利用国家样本的截面样本，将关税水平对经济增长回归，控制了地理板块层面的固定效应。</li></ul></details></li></ul><ul id="dda9972a-c1ab-4fda-ad50-71f26f989e0a" class="toggle"><li><details open=""><summary>ii) 强制共线性变量不被omitted</summary><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="64ef9843-fc8c-45c0-9aeb-ce02a1a1f047" class="code"><code class="language-Plain Text">regress unitprice i.year if inrange(year,2003,2022)
* 最后一年被omitted

regress unitprice ibn.year if inrange(year,2003,2022), nocons
* 强制共线性变量不被omitted</code></pre></details></li></ul></details></li></ul><ul id="fe02e800-801d-43a9-8614-ee529ac2725d" class="toggle"><li><details open=""><summary>经验贝叶斯收缩（Empirical Bayes Shrinkage）</summary><blockquote id="458c1b54-a851-43d8-9254-d136be30736e" class="">Researchers (e.g., <a href="https://doi.org/10.1093/qje/qjx001">Angrist et al., 2017</a>; <a href="https://doi.org/10.1093/qje/qjy006">Chetty and Hendren, 2018</a>, for example) are increasingly embracing the empirical Bayes method to reduce prediction error in fixed effect estimates when the number of observations per unit is small for selected cells (<a href="https://drive.google.com/file/d/1U5tFHXqrcmNbCWOw5t7MqAcZ8BDMlMIN/view">Cao, 2023</a>).</blockquote><ul id="b9d87d9a-9c90-474b-b176-45353810a783" class="bulleted-list"><li style="list-style-type:disc"><code>ebayes</code> 命令，ado文件通过<a href="https://sacarny.com">Adam Sacarny</a>个人主页下载 [<a href="https://sacarny.com/wp-content/uploads/2015/08/ebayes.ado">ado链接</a>]</li></ul><ul id="01195f69-9b93-4215-9e50-7d7f1ab8e312" class="bulleted-list"><li style="list-style-type:disc">下面是使用 <code>ebayes</code> 估计EBS estimator的示例</li></ul><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="2544f03d-1bcd-41c4-978c-e27c7f507ca9" class="code"><code class="language-Plain Text">gen fe_t = .		// 时间固定效应
gen fese_t = .		// 时间固定效应标准误
gen fe_id = .		// 个体固定效应
gen fese_id = .		// 个体固定效应标准误

reg y d x ibn.t ibn.id, nocons 	// 基准回归
scalar df = e(df_r)
levelsof t, local(list_t) 	// 时间变量
foreach tt in `list_t&#x27; {
	if (_b[i`tt&#x27;.t]==_se[i`tt&#x27;.t] &amp; _b[i`tt&#x27;.t]==0) continue
	qui replace fe_t = _b[i`tt&#x27;.t] if t==`tt&#x27;
	qui replace fese_t = _se[i`tt&#x27;.t] if t==`tt&#x27;
}
levelsof id, local(list_id)  	// 个体变量
foreach idid in `list_id&#x27; {
	if (_b[i`idid&#x27;.id]==_se[i`idid&#x27;.id] &amp; _b[i`idid&#x27;.id]==0) continue
	qui replace fe_id = _b[i`idid&#x27;.id] if id==`idid&#x27;
	qui replace fese_id = _se[i`idid&#x27;.id] if id==`idid&#x27;
}

// 使用 ebayes 调整FEs
ebayes fe_t fese_t x, gen(fe_t_adj)
ebayes fe_id fese_id x, gen(fe_id_adj) simple

// 估计EBS estimator
constraint define 1 fe_t_adj=1
constraint define 2 fe_id_adj=1
cnsreg y d x fe_t_adj fe_id_adj, const(1 2)
* 这里的se并不是有效估计量</code></pre><ul id="1cf6025f-3947-4046-b6bf-6273fa4b3667" class="bulleted-list"><li style="list-style-type:disc">注意：示例中没有考虑聚类标准误</li></ul></details></li></ul><h3 id="e4a58541-c3ac-40d3-bd2f-d3db4413843c" class="">导出结果</h3><ul id="542b4d29-cf8a-47eb-bc9e-acec613d2c72" class="toggle"><li><details open=""><summary>批量导出</summary><ul id="53889be7-0494-4032-9f0c-94524be355e8" class="bulleted-list"><li style="list-style-type:disc">先定义导出的样式</li></ul><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="b3b5647f-c020-44b8-b889-5c09a4549ac5" class="code"><code class="language-Plain Text">global esttab_opt &quot;b(%8.3f) not p(%8.3f) drop(_cons) &quot; // addtext() order() keep()
* global outreg2_opt &quot;pvalue bdec(3)pdec(3)rdec(3) addtext(City fe, YES, Year fe, YES) nocons &quot; // drop() sortvar( )
global outreg2_opt &quot;bdec(3)sdec(3)rdec(3) addtext(City FE, YES, Year FE, YES) nocons &quot; // drop() sortvar( )</code></pre><ul id="850b67cd-c1d8-4292-b39d-9342c05d23ec" class="bulleted-list"><li style="list-style-type:disc">然后逐一回归，用下方命令储存每次回归结果</li></ul><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="3abfeff0-3b8d-4f06-89d1-b6fdc1f18f8a" class="code"><code class="language-Plain Text">eststo, p(re_)</code></pre><ul id="fea48f14-4714-4e93-84db-9ff84ef728ad" class="bulleted-list"><li style="list-style-type:disc">展示并导出结果</li></ul><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="3c3bf6f9-19a5-421b-9554-d0ec3410df35" class="code"><code class="language-Plain Text">// dispaly and output
esttab re_*, star(* 0.1 ** 0.05 *** 0.01) ${esttab_opt}
outreg2 [re_*] using &quot;outputtable.doc&quot;, replace ${outreg2_opt}
eststo clear</code></pre><ul id="1d3b6239-c5d1-47da-b579-455778c43d6e" class="bulleted-list"><li style="list-style-type:disc">通过循环高效的完成上述流程</li></ul><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="1296f27a-6607-405e-b716-237c018c1995" class="code"><code class="language-Plain Text">// baseline
foreach depvar in  { // 
	foreach indepvar in  { // 
		reghdfe `depvar&#x27; `indepvar&#x27; $covariate, abs(id year) vce(r)
		eststo, p(re_)
	}
}
esttab re_*, star(* 0.1 ** 0.05 *** 0.01) ${esttab_opt}
outreg2 [re_*] using &quot;outputtable.doc&quot;, replace ${outreg2_opt}
eststo clear</code></pre></details></li></ul><ul id="3c5ac66a-d6c3-4168-bd19-3a8e94f28c97" class="toggle"><li><details open=""><summary>导出结果中添加因变量均值以及其他统计量</summary><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="91cf7576-e019-4f2f-8b4f-8d72fc844967" class="code"><code class="language-Plain Text">// patch--dependant variable&#x27;s mean
program define EstAddDepMean, rclass
	version 16
	args dep_var
	qui if &quot;`dep_var&#x27;&quot;==&quot;&quot; {
		sum `e(depvar)&#x27; if e(sample)
	}
	else {
		sum `dep_var&#x27; if e(sample)
	}
	estadd local dep_var_mean `r(mean)&#x27;
end</code></pre><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="a6ef85a1-f8d2-49d1-8ae3-e313b82c5f10" class="code"><code class="language-Plain Text">reg depvar indepvars
EstAddDepMean depvar

outreg2 [re_*] using &quot;outputtable.doc&quot;, replace bdec(3)sdec(3)rdec(3) addtext(Firm FE, YES, Year FE, YES) e(dep_var_mean) adec(3)</code></pre></details></li></ul><h3 id="17acf529-41e2-44db-9a0b-940b5f3ebd27" class="">调用参数估计结果</h3><ul id="3532468b-7084-474a-872c-73222e33e046" class="toggle"><li><details open=""><summary>调用回归系数和标准误</summary><p id="effca751-851b-41ec-b0a0-f5323a95ace8" class="">
</p></details></li></ul><ul id="3fcf9d3e-e957-41f3-ba22-be9da47126c5" class="toggle"><li><details open=""><summary>手动计算 <style>@import url('https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.9/katex.min.css')</style><span data-token-index="0" contenteditable="false" class="notion-text-equation-token" style="user-select:all;-webkit-user-select:all;-moz-user-select:all"><span></span><span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi></mrow><annotation encoding="application/x-tex">p</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord mathnormal">p</span></span></span></span></span><span>﻿</span></span> 值和置信区间</summary><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="fa4d390e-1c91-448d-b678-c658ffc8f79d" class="code"><code class="language-Plain Text">regress depvar indepvar

// manually calculating p-value
local pval = 2*ttail(e(df_r),abs(_b[indepvar]/_se[indepvar]))

// manually confident interval (sig. level = 0.05)
local b_ll = _b[indepvar] - invttail(e(df_r),.05/2) * _se[indepvar]
local b_ul = _b[indepvar] + invttail(e(df_r),.05/2) * _se[indepvar]</code></pre><ul id="5624752d-5bc3-479a-ac51-9ff20bf79652" class="bulleted-list"><li style="list-style-type:disc">Stata 18 版本开始可以通过<code>_r_p[indepvar]</code>  <code>_r_lb[indepvar]</code> <code>_r_ub[indepvar]</code> 来调用 <style>@import url('https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.9/katex.min.css')</style><span data-token-index="0" contenteditable="false" class="notion-text-equation-token" style="user-select:all;-webkit-user-select:all;-moz-user-select:all"><span></span><span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi></mrow><annotation encoding="application/x-tex">p</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord mathnormal">p</span></span></span></span></span><span>﻿</span></span> 值和置信区间<ul id="0c2be337-4232-42ff-8da1-c61c0fc2799f" class="bulleted-list"><li style="list-style-type:circle">更多可调参数见帮助文档 <code>help _variables</code></li></ul></li></ul></details></li></ul><h2 id="52fd3815-b648-4496-b72d-986c0ccd94e0" class="">内生性考虑</h2><h3 id="ce61233d-3894-40bc-827c-6a7c167437c2" class="">工具变量法</h3><ul id="304e10dd-541f-4db2-90a7-0fba32ef0577" class="toggle"><li><details open=""><summary><code>ivreghdfe</code></summary><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="47f35541-5c69-478b-8b2f-90d763e8323d" class="code"><code class="language-Plain Text">ivreghdfe y covariates (x = iv), abs(id year) </code></pre></details></li></ul><ul id="29abaf45-b940-432d-8d3d-97ca36cdaf97" class="toggle"><li><details open=""><summary>易生成的工具变量（但不推荐，慎用）</summary><ul id="124038ca-8370-47be-97d9-629a25043f0b" class="toggle"><li><details open=""><summary>内生变量滞后一年</summary><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="3d114bdc-823b-49e0-ab19-c33928942cb1" class="code"><code class="language-Plain Text">xtset citycode year
gen iv = L.xvar</code></pre></details></li></ul><ul id="b41e3a45-38bd-493a-bb4a-d1618bf50a28" class="toggle"><li><details open=""><summary>同省其他城市内生变量的均值</summary><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="48b7394b-7c5c-4ba4-bf5a-b7ba22c67313" class="code"><code class="language-Plain Text">// 同省其他城市内生变量的均值
gen iv = .
levelsof citycode, local(citycode_list) // citycode是记录城市代码的变量
qui forval yy = 2010/2019 { // 数据集中的年份范围
qui foreach cc in `citycode_list&#x27; {
	qui levelsof province if citycode==`cc&#x27; &amp; year==`yy&#x27;, local(pp) clean // province是记录省份的变量
	qui sum xvar if province==&quot;`pp&#x27;&quot; &amp; citycode!=`cc&#x27; &amp; year==`yy&#x27; // xvar是内生变量
	replace iv = `=r(mean)&#x27; if citycode==`cc&#x27; &amp; year==`yy&#x27;
}
}</code></pre></details></li></ul><ul id="9ced6bea-5f12-486a-8c44-f8e0e0069ff3" class="toggle"><li><details open=""><summary>Bartik IV</summary><figure id="afd356d6-4ad8-4ed6-b86b-7dc9fd066c06"><a href="https://mp.weixin.qq.com/s/V93-HJjBs6E3qVWLRkstOQ" class="bookmark source"><div class="bookmark-info"><div class="bookmark-text"><div class="bookmark-title">【香樟推文2597】还不会用Bartik工具变量？看这篇就够了！</div><div class="bookmark-description">图片来源：https://www.upjohn.org/about/upjohn-team/staff/ti</div></div><div class="bookmark-href"><img src="https://res.wx.qq.com/a/wx_fed/assets/res/MjliNWVm.svg" class="icon bookmark-icon"/>https://mp.weixin.qq.com/s/V93-HJjBs6E3qVWLRkstOQ</div></div><img src="https://mmbiz.qpic.cn/mmbiz_jpg/dmLyqh5TYr8h9g66GkJPgOyhYeyp9gG6a5GAqX1h8SxPqSFicOGibBeicvp97SBBr2YlrIP6GGkXsU93XTKOyh68g/0?wx_fmt=jpeg" class="bookmark-image"/></a></figure><figure id="b367e89c-84a1-43cf-a93e-0fad5455242b"><a href="https://mp.weixin.qq.com/s/e5wce3I4rXK6Q3O-y_x6XA" class="bookmark source"><div class="bookmark-info"><div class="bookmark-text"><div class="bookmark-title">Stata论文复现：移动份额法工具变量(Shift-Share IV)</div><div class="bookmark-description">2023-连享会：机制分析与政策优化      \x0d\x0a主讲老师：杨海生  \x0d\x0a课程时间：2023年8月22-24日      \x0d\x0a课程地点：西安·西北工业大学</div></div><div class="bookmark-href"><img src="https://res.wx.qq.com/a/wx_fed/assets/res/MjliNWVm.svg" class="icon bookmark-icon"/>https://mp.weixin.qq.com/s/e5wce3I4rXK6Q3O-y_x6XA</div></div><img src="https://mmbiz.qpic.cn/mmbiz_jpg/cCEqAEoUCHwIH20zpJqfhBe288uSENtHibd59Ou0lBvELzbR63UlaqIMZJy4EibRzXllF70MDrq9RFtCbCfSibmxA/0?wx_fmt=jpeg" class="bookmark-image"/></a></figure></details></li></ul></details></li></ul><h3 id="bef31a9d-5f64-40ae-97b0-b08a0750a613" class="">遗漏变量问题</h3><h3 id="b19a4c68-aa5a-4e28-bb1f-93543b5b3a4c" class="">样本偏差问题</h3><ul id="be899c7d-5780-4c8d-851a-6736352672b9" class="toggle"><li><details open=""><summary>Lee bounds</summary><ul id="519aff67-8990-498a-963b-f3e0491eba98" class="bulleted-list"><li style="list-style-type:disc">见 <a href="https://academic.oup.com/restud/article-abstract/76/3/1071/1590707">Lee (2009, QJE)</a></li></ul><ul id="aadf492a-5af6-4d56-b594-78b31e99a048" class="bulleted-list"><li style="list-style-type:disc">Stata code <a href="https://www.stata.com/meeting/germany12/abstracts/desug12_tauchmann.pdf">[pdf]</a></li></ul></details></li></ul><ul id="755ea804-97f2-46e1-b9f2-52dce46eb30a" class="toggle"><li><details open=""><summary>Hackman两阶段</summary><p id="5a625546-d66f-4316-918d-5f4773532e50" class="">
</p></details></li></ul><h3 id="b7d50c9d-b1ad-45dc-be4d-91ab0ee4e490" class="">测量误差问题</h3><h3 id="faba0abd-f7ba-41e5-95c5-6f46a8bc3bfa" class="">互为因果问题</h3><h2 id="637bf549-e38a-4b4e-aecb-8d60430689c1" class="">稳健性检验</h2><h3 id="fa216049-478b-4dae-86a1-1c79b0895a1e" class="">改变标准误</h3><ul id="b9ea1928-3d12-48b1-9c03-f278db9efe0b" class="toggle"><li><details open=""><summary>什么时候应该调整聚类标准误？</summary><ul id="451cd2e2-88f1-4651-a892-9a057976181f" class="bulleted-list"><li style="list-style-type:disc">见 <a href="https://academic.oup.com/qje/article-abstract/138/1/1/6750017">Abadie et al. (2023)</a> <a href="https://mp.weixin.qq.com/s/cMAHGPOvzf88Mz1-31pfVQ">[media cover in Chinese]</a><ul id="bd889611-f766-4617-9030-ce8e03cfc35c" class="bulleted-list"><li style="list-style-type:circle">Abadie, A., Athey, S., Imbens, G. W., &amp; Wooldridge, J. M. (2023). When should you adjust standard errors for clustering?. <em>The Quarterly Journal of Economics</em>, <em>138</em>(1), 1-35.</li></ul></li></ul></details></li></ul><ul id="bcd5b94b-585a-4a75-bbd8-fd53aa760c1f" class="toggle"><li><details open=""><summary>多重聚类 (Cameron, 2011)</summary><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="c016e138-d335-4b7e-940a-fb02183fbd79" class="code"><code class="language-Plain Text">// Robust inference with multiway clustering (Cameron, 2011)
vcemway reghdfe `depvar&#x27; `indepvar&#x27; $covariate, abs(id year) vce(r) cluster(cl_1 cl_2)
* ref: Cameron A C, Gelbach J B, Miller D L. Robust inference with multiway clustering[J]. Journal of Business &amp; Economic Statistics, 2011, 29(2): 238-249.</code></pre></details></li></ul><ul id="7737d2cb-c257-460c-85f1-6494cdc31361" class="toggle"><li><details open=""><summary>Bootstrap</summary><p id="14253f31-ea40-49db-9378-760f179a61ff" class=""><code>boottest</code></p></details></li></ul><ul id="af92decb-f8bb-4974-a2ea-db3f111bf6e4" class="toggle"><li><details open=""><summary>Multiple hypothesis testing</summary><p id="cf26026f-3eaa-482c-83df-c887fc41c3b3" class="">see in: <a href="https://blogs.worldbank.org/impactevaluations/updated-overview-multiple-hypothesis-testing-commands-stata">https://blogs.worldbank.org/impactevaluations/updated-overview-multiple-hypothesis-testing-commands-stata</a></p></details></li></ul><ul id="e632f4be-eabf-4b7f-81ab-3e0eade1aad9" class="toggle"><li><details open=""><summary>时间序列自相关的异方差处理</summary><ul id="8e9a77d8-7d40-4b0a-b964-89d6557ecf3a" class="toggle"><li><details open=""><summary>Driscoll-Kraay标准误</summary><p id="c9cb9a57-e3f5-4e88-a219-936df4a931a2" class=""><code>xtscc </code></p><p id="e648ffe7-c6c1-44d1-a41b-ff544f86b2f4" class="">
</p></details></li></ul></details></li></ul><h3 id="658c314b-df70-431c-8624-edda111a63d5" class="">样本控制</h3><h3 id="c2551022-96a2-4507-a1be-82a9c26b26ba" class="">改变模型</h3><h3 id="2315481a-4128-48ac-9082-31a4b4b1d4c0" class="">改变数据</h3><ul id="bbce2720-0335-4050-9a3c-f7956c9f1595" class="toggle"><li><details open=""><summary>一些跨数据集分析的技巧</summary><p id="9e3a39bb-8617-4a8f-b585-f9e5f6be0cc5" class="">
</p></details></li></ul><h3 id="f3f853df-a2e2-4e47-974a-e58f9cc63859" class="">改变参数估计方式</h3><ul id="b466467e-bdb5-48f1-a4f3-7066fb853ce0" class="toggle"><li><details open=""><summary>极大似然估计 MLE</summary></details></li></ul><h2 id="ae2a22ea-673d-449d-abfd-0eff809d2116" class=""><strong>异质性分析</strong></h2><h3 id="8b45f558-d6ca-4b87-bade-d8f5b076589e" class="">什么是好的异质性分析？</h3><ul id="5735f040-7c41-42a9-829b-0ebdf67b24dc" class="bulleted-list"><li style="list-style-type:disc">强化因果关系</li></ul><ul id="abaef707-40c5-49d0-9d4c-a5069dcbb4b4" class="bulleted-list"><li style="list-style-type:disc">呼应经典文献</li></ul><ul id="bb0693b2-5b8e-4cd1-85e9-3eaeb03e15cb" class="bulleted-list"><li style="list-style-type:disc">具有政策含义</li></ul><ul id="eb66e63a-231e-467e-bb1a-0a50fd603b34" class="bulleted-list"><li style="list-style-type:disc">紧扣核心变量</li></ul><figure id="53597e91-ceab-475d-a20e-d34fcebcdf42"><a href="https://mp.weixin.qq.com/s/eW_LF-_qaoZ9w6HbgXHx_Q" class="bookmark source"><div class="bookmark-info"><div class="bookmark-text"><div class="bookmark-title">异质性分析！异质性分析！</div><div class="bookmark-description">连享会：2024五一论文\x0d\x0a嘉宾：杨海生，王群勇，连玉君\x0d\x0a时间：5月2-4日（可单独报名某一天）\x0d\x0a详情：https://www.lianxh.cn/details/1349.html\x0d\x0a咨询：王老师 18903405450（微信）</div></div><div class="bookmark-href"><img src="https://res.wx.qq.com/a/wx_fed/assets/res/MjliNWVm.svg" class="icon bookmark-icon"/>https://mp.weixin.qq.com/s/eW_LF-_qaoZ9w6HbgXHx_Q</div></div><img src="https://mmbiz.qpic.cn/mmbiz_jpg/cCEqAEoUCHyiaIv1sdIwLOJbh0V9eZh3g6FnHO7E5zxsICbYm8q0p4Ar6HXptaPfibo12wkuyKgPzyTb6FNdicgKw/0?wx_fmt=jpeg" class="bookmark-image"/></a></figure><h3 id="d91e19ee-297b-43b8-bc9e-32ebff0c0361" class="">引入交互项</h3><ul id="b55f1f0f-a278-4e70-839b-5d7c8911c45b" class="toggle"><li><details open=""><summary><code>fvvarlist</code></summary><p id="9e912922-283a-47dc-96fe-45e5da2319cb" class="">不省略i.的方法</p></details></li></ul><h3 id="30ebafd3-7024-4187-90f5-ff67b3d28fbb" class="">分样本回归</h3><ul id="fe99a4ba-44bf-45ef-9431-4859c12df939" class="toggle"><li><details open=""><summary>样本分组方法</summary><ul id="0c1503b0-7db4-4636-9a3d-77e103e9d7a0" class="bulleted-list"><li style="list-style-type:disc">有时我们需要把反映异质性的连续变量映射到离散变量上</li></ul><ul id="724193a2-5efd-4478-be49-6e6b374ae5f2" class="bulleted-list"><li style="list-style-type:disc">可以使用 <code>xtile</code> 实现，<code>#</code> 表示分类的数量</li></ul><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="df1fe3c5-11c5-421f-8c4b-bc85f99c4dea" class="code"><code class="language-Plain Text">xtile newvar = varname, n(#)

reg depvar indepvars if newvar == 1
reg depvar indepvars if newvar == 2
* ...
reg depvar indepvars if newvar == #</code></pre><ul id="31a7047d-b587-472e-ad49-84e17d4d7740" class="bulleted-list"><li style="list-style-type:disc">如果仅分为两组，可以通过 <code>egen</code> 计算中位数</li></ul><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="a11e6d80-ecb2-4187-8a39-c1dfe54119bd" class="code"><code class="language-Plain Text">egen newvar = median(varname)

reg depvar indepvars if varname &lt;  newvar
reg depvar indepvars if varname &gt;= newvar</code></pre><ul id="d99ff294-54c6-4062-8ca8-6e689f0ea870" class="bulleted-list"><li style="list-style-type:disc">然而，如果不同年份的数据混合在一起，且异质性变量非平稳，简单地对整体分组，可能无法准确反映个体的异质性</li></ul><ul id="9b557809-b186-4c30-be5b-b02889739369" class="bulleted-list"><li style="list-style-type:disc">一种应对策略是逐年分类</li></ul><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="786c2db0-7414-405a-bab9-00c8713bd8d0" class="code"><code class="language-Plain Text">bys year: egen newvar = median(varname)

reg depvar indepvars if varname &lt;  newvar
reg depvar indepvars if varname &gt;= newvar</code></pre><ul id="47aa12a6-a5c3-4010-8353-8d8463b6b4de" class="bulleted-list"><li style="list-style-type:disc">另一种策略是选择一个基期作分类</li></ul><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="f7f80093-f3d1-49d3-81ab-491701e55e45" class="code"><code class="language-Plain Text">tempfile temp_heter
preserve
keep if year == 2010 // base year
xtile newvar = varname, n(2)
keep id newvar
save `temp_heter&#x27;
restore

merge m:1 id using `temp_heter&#x27;, nogen</code></pre></details></li></ul><ul id="3d0ac949-6261-4380-849c-0c583bfa5044" class="toggle"><li><details open=""><summary>分组系数检验方法</summary><ul id="18bfd9e8-be9b-4fc1-8ac2-64a3a79ba06a" class="toggle"><li><details open=""><summary>suest检验</summary><ul id="4dd4b6d4-e49f-4026-96fe-663dd684dfef" class="bulleted-list"><li style="list-style-type:disc">无个体固定效应</li></ul><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="d6515cce-cba7-421d-a624-d1fb5c0e84a8" class="code"><code class="language-Plain Text">reg edu pat $firmvar $cityvar if hangye==1
eststo, p(re_)
reg edu pat $firmvar $cityvar if hangye==0
eststo, p(re_)

suest re_1 re_2
test [re_1_mean]pat = [re_2_mean]pat
* pat为所检验的核心变量</code></pre><ul id="62098074-f98a-4909-b5e6-211305f56ca8" class="bulleted-list"><li style="list-style-type:disc">对于固定效应模型而言，见<figure id="de5283e4-358d-402a-b0b4-6d80dec4edcb"><a href="https://www.bilibili.com/video/BV1R2421K7a7/?share_source=copy_web&amp;vd_source=bc9c539ccb1d2b7c076a42030004d4d4" class="bookmark source"><div class="bookmark-info"><div class="bookmark-text"><div class="bookmark-title">「Stata」带有固定效应的似不相关检验（suest）_哔哩哔哩_bilibili</div><div class="bookmark-description">推文地址：https://mp.weixin.qq.com/s/lZsWQ90ptNvrhdnxnapQQg, 视频播放量 2343、弹幕量 4、点赞数 48、投硬币枚数 31、收藏人数 82、转发人数 11, 视频作者 拿铁一定要加冰, 作者简介 XMU会计学博士生。公众号: OneStata。，相关视频：「Stata」一个视频搞懂固定效应！原理与推荐回归方法，3种方式实现固定效应回归！，「Stata」中介效应检验 - 带固定效应Sobel与Bootstrap，【补充】在Oneclick命令中加入固定效应，交互固定效应，非常简单，下次你也应该试试，【Stata】一键显著OneClick4.2小小小更新，【Stata】手动绘制调节效应图，「oneclick5.0」Stata一键显著命令更新，大幅提升运行速度！，震惊！某博主偷偷搭建了一个免费的Stata入门级教程网站，「Stata」一键显著oneclick也能做稳健性检验？</div></div><div class="bookmark-href"><img src="https://i2.hdslb.com/bfs/archive/50ab7eb430548b47622a901fdd1ce7009300c248.jpg@100w_100h_1c.png@57w_57h_1c.png" class="icon bookmark-icon"/>https://www.bilibili.com/video/BV1R2421K7a7/?share_source=copy_web&amp;vd_source=bc9c539ccb1d2b7c076a42030004d4d4</div></div><img src="https://i2.hdslb.com/bfs/archive/50ab7eb430548b47622a901fdd1ce7009300c248.jpg@100w_100h_1c.png" class="bookmark-image"/></a></figure></li></ul></details></li></ul><ul id="a015998c-6629-4c25-883b-73c90a7d4ffa" class="toggle"><li><details open=""><summary>费舍尔检验</summary><ul id="79b71e8a-52f1-4387-abe9-db8fb96e344c" class="bulleted-list"><li style="list-style-type:disc">通过 <code>bdiff</code> 实现，需要先 <code>ssc install bdiff</code> </li></ul><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="5513cff0-44b7-47ce-b7de-046474eb779e" class="code"><code class="language-Plain Text">bdiff, group(hangye) model(reghdfe edu pat $firmvar $cityvar, absorb(indu cdyear) vce(cluster stkcd)) reps(50) detail seed(123)</code></pre></details></li></ul></details></li></ul><ul id="6e8b94f7-0f59-435b-95ee-a3d8729d38a1" class="toggle"><li><details open=""><summary>推荐阅读</summary><ul id="385d9cc7-4143-4990-b3f9-8a8478cf6b4d" class="bulleted-list"><li style="list-style-type:disc"><a href="https://mp.weixin.qq.com/s/Qwv24bFyEfDf2a5o-DrZUA">分组回归的组间系数差异性检验, 似不相关SUR和置换检验PT操作！</a></li></ul><ul id="4fe06758-7f4f-4549-a96f-78bd7c7721ba" class="bulleted-list"><li style="list-style-type:disc"><a href="https://mp.weixin.qq.com/s/DJ4Z10KlMJptbYjQpLzWGw">Stata：如何检验分组回归后的组间系数差异？</a></li></ul></details></li></ul><h3 id="9b3c01ca-573c-4ee7-9f51-ab1541e9222d" class="">可视化异质性分析</h3><h3 id="3ec4fa0b-5f6c-4902-8245-55782c3497d7" class="">柱状图</h3><ul id="b0797ce1-bda4-433e-9b64-2c9856fa004b" class="toggle"><li><details open=""><summary></summary><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="93c0b00d-eed5-41ce-9b0b-738969742e74" class="code"><code class="language-Plain Text">// global setup
graph set window fontface &quot;Times New Roman&quot;
set scheme s1mono // s1mono white tufte

/*******************************************************************************
	input data
*******************************************************************************/
import excel &quot;HetRes.xlsx&quot;, sheet(&quot;Sheet1&quot;) cellrange(K1:R15) firstrow clear
* generate data in Excel


/*******************************************************************************
	
*******************************************************************************/
// set bin width
scalar bw=.08 // bin width
gen axis=int((1+_n)/2)
if 0 {
replace axis=axis-bw if mod(_n,2)==1 //even
replace axis=axis+bw if mod(_n,2)==0 //odd
}
else if 1 {
replace axis=1-bw if mod(_n,2)==1 //even
replace axis=1+bw if mod(_n,2)==0 //odd
}

// label for variables rendering the heterogeneity
cap program drop labelstring
program define labelstring, rclass
	syntax, OVERvarval(string)
    if &quot;`overvarval&#x27;&quot;==&quot;Number of children&quot; {
	    return local odd_lab=&quot;# Children {&amp;ge} 2&quot;
	    return local eve_lab=&quot;{&amp;le} 1&quot;
	    return local tit_str=&quot;# children&quot;
	}
    if &quot;`overvarval&#x27;&quot;==&quot;Famliy size&quot; {
	    return local odd_lab=&quot;Famliy size {&amp;gt} mean&quot;
	    return local eve_lab=&quot;{&amp;le} mean&quot;
	    return local tit_str=&quot;Famliy size&quot;
	}
    if &quot;`overvarval&#x27;&quot;==&quot;Invovled in agricultural work&quot; {
	    return local odd_lab=&quot;Agri. work = 1&quot; 
	    return local eve_lab=&quot;= 0&quot;
	    return local tit_str=&quot;Agricultrual work&quot;
	}
    if &quot;`overvarval&#x27;&quot;==&quot;Region of residence&quot; {
	    return local odd_lab=&quot;Rural&quot; //sch.
	    return local eve_lab=&quot;Urban&quot;
	    return local tit_str=&quot;Region of residence&quot;
	}
    if &quot;`overvarval&#x27;&quot;==&quot;Household age&quot; {
	    return local odd_lab=&quot;Age {&amp;le} mean&quot;
	    return local eve_lab=&quot;{&amp;gt} mean&quot;
	    return local tit_str=&quot;Household age&quot;
	}
    if &quot;`overvarval&#x27;&quot;==&quot;Household gender&quot; {
	    return local odd_lab=&quot;Male&quot;
	    return local eve_lab=&quot;Female&quot;
	    return local tit_str=&quot;Household gender&quot;
	}
    if &quot;`overvarval&#x27;&quot;==&quot;Household year of schooling&quot; {
	    return local odd_lab=&quot;High school = 1&quot;
	    return local eve_lab=&quot;= 0&quot;
	    return local tit_str=&quot;Household education&quot;
*	    return local tit_str=&quot;Household year of schooling&quot;
	}
end


// discriminate 2 type of outcome variables
cap program drop disdepvar
program define disdepvar, rclass
	syntax, DEPvar(string)
    if &quot;`depvar&#x27;&quot;==&quot;log_tot_inc&quot; {
	    return local depvar_text=&quot;Log total income&quot;
	    return local bar_color=&quot;navy&quot;
	}
    if &quot;`depvar&#x27;&quot;==&quot;per_cap_inc&quot; {
	    return local depvar_text=&quot;Log per capita income&quot;
	    return local bar_color=&quot;dknavy&quot;
	}
	* other bar_color: liblue gray
end


// main job
local c=1
local gra_list=&quot;&quot;
// 7 type of root of heterogeneity 
foreach hetvar in &quot;Household age&quot; &quot;Household gender&quot; &quot;Household year of schooling&quot; &quot;Number of children&quot; &quot;Famliy size&quot; &quot;Invovled in agricultural work&quot; { // &quot;Region of residence&quot;
// 2 type of outcome variable
foreach depvar in log_tot_inc per_cap_inc {

// knowing how to label and scrawl
labelstring,over(&quot;`hetvar&#x27;&quot;)
	local odd_lab=&quot;`r(odd_lab)&#x27;&quot;
	local eve_lab=&quot;`r(eve_lab)&#x27;&quot;
*	local tit_str=&quot;`r(tit_str)&#x27;&quot;
	local tit_str=&quot;&quot;
disdepvar, depvar(`depvar&#x27;)
	local bar_color=&quot;`r(bar_color)&#x27;&quot;
	local depvar_text=&quot;`r(depvar_text)&#x27;&quot;

// ytitle option
if (mod(`c&#x27;,2)==1) local yaxistitleopt &quot;ytitle(&quot;Coefficient&quot;)&quot;
else local yaxistitleopt &quot;ytitle(&quot;  &quot;)&quot;

// xtitle option
local xaxistitleopt &quot;xtitle(&quot;`tit_str&#x27;&quot;)&quot; //

// title option
if (`c&#x27;&lt;=2) local titleopt &quot;title(&quot;`depvar_text&#x27;&quot;)&quot;
else local titleopt &quot;title(&quot;  &quot;)&quot;

// plot
tw	(bar b_`depvar&#x27; axis , lw(medthin) lc(black) barwidth(0.08) fc(`bar_color&#x27;%0) base(0)) ///`bar_color&#x27;
	(rcap ll_`depvar&#x27; ul_`depvar&#x27; axis, lc(black)lw(medthin)) /// gs4 orange_red
	if overvar==&quot;`hetvar&#x27;&quot;, ///
	yline(0,lc(gs6)lp(long)) ///xline(1.5 2.5 3.5 4.5, lc(gs14)lp(long) noextend) ///
	`xaxistitleopt&#x27; xlabel(`=1-bw&#x27; &quot;`odd_lab&#x27;&quot; `=1+bw&#x27; &quot;`eve_lab&#x27;&quot;, nogrid noticks labsi(medsmall)) xscale(alt noline range(`=1-bw*2&#x27; `=1+bw*2&#x27;)) /// grid glcolor(white)
	`yaxistitleopt&#x27; ylabel(, nogrid labsi(medsmall) ticks tlength(half_tiny)) yscale(noline) /// glcolor(gs14%70)
	`titleopt&#x27; legend(off) scheme(s1color) plotregion(fc(none)lw(medthin)) graphregion(margin(medlarge)) ///lw(none)
	name(gra_`c&#x27;,replace)

// loop counter
local gra_list &quot;`gra_list&#x27; gra_`c&#x27;&quot;
local c=`c&#x27;+1
}
}

// combine together
graph combine `gra_list&#x27;, rows(7) cols(2) xsize(10) ysize(20) imargin(l+5 r+5 t=0 b=0) //iscale(.4)
graph drop `gra_list&#x27;
// output
graph export &quot;heterogeneity.pdf&quot;,as(pdf)replace

// 2 by 2 combine
* forval i=1/`=`c&#x27;-1&#x27; {
* 	if (mod(`i&#x27;,2)!=0) { // not the 2×n th graph
* 		local gra_list_comb &quot;`gra_list_comb&#x27; gra_`i&#x27;&quot; 
* 	}
* 	else {
* 		local gra_list_comb &quot;`gra_list_comb&#x27; gra_`i&#x27;&quot; 
* 		no di &quot;`gra_list_comb&#x27;&quot;
* 		graph combine `gra_list_comb&#x27;, cols(2) xsize(20) ysize(10) // imargin(small)iscale(.4) rows(1)
* 		graph export &quot;heterogeneity_`i&#x27;.png&quot;, as(png) replace
* 		graph drop `gra_list_comb&#x27;
* 		local gra_list_comb &quot;&quot; 
* 	}
* }</code></pre></details></li></ul><h2 id="03884d84-e41d-433e-a4bc-0180b5bdd68a" class=""><strong>关于</strong><em><strong><strong>p</strong></strong></em><strong><strong>-Hacking</strong></strong></h2><figure id="f9a58065-501d-4113-bb34-b77a70968fb3"><a href="https://academic.oup.com/ej/article/134/659/985/7512229" class="bookmark source"><div class="bookmark-info"><div class="bookmark-text"><div class="bookmark-title">p-Hacking, Data type and Data-Sharing Policy</div><div class="bookmark-description">Abstract. This paper examines the relationship between p-hacking, publication bias and data-sharing policies. We collect 38,876 test statistics from 1,106</div></div><div class="bookmark-href"><img src="https://oup.silverchair-cdn.com/UI/app/img/v-638473439734014668/apple-touch-icon.png" class="icon bookmark-icon"/>https://academic.oup.com/ej/article/134/659/985/7512229</div></div><img src="https://oup.silverchair-cdn.com/oup/backfile/Content_public/Journal/ej/134/659/10.1093_ej_uead104/2/m_uead104fig1.jpeg?Expires=1776363774&amp;Signature=N0jZNP6jIOhQFwPWOhuszrUOUsuy53RmLylVfrVq0O7eQT0ZnGk0zxbP5LwPSUNxXjkoIp9OCxyje6iFCeZsnRHqGsmyQQ2i5ODjH3Mmh-zOxsVFfQiheHVvCaESJZmRXLMAevg~mUDpedk~PvdLElP1kh1fCVopnmHNkK9hNrzung6Y7yhk13jSB5VtFRUqk6HSCUbPr6xOtrbyfa5QrD8RiEAKVErOtPQ98abtmIjtPbOjQDTwZvwOOLvef9XSAdVb-bTYIMf~eFPBtg5kwWQgmtqkSIx9PedLataxZAOgJViLsrej7tVq98YV-2dehpHWePVqBgvJu25gsFbu2g__&amp;Key-Pair-Id=APKAIE5G5CRDK6RD3PGA" class="bookmark-image"/></a></figure><p id="dbddaa90-2a63-472f-8546-6ca883855740" class="">
</p><hr id="57079b54-02ae-401c-b042-3a661ffb81f7"/><h1 id="07782a90-c632-45d6-9537-7d9fe2396ede" class=""><span style="border-bottom:0.05em solid">5 双重差分</span></h1><h2 id="3ed41671-6114-46e3-ac13-31ce0497a954" class="">初步分析</h2><h3 id="85f26f31-245c-40a4-8dd2-ef759c1c42f5" class="">展示面板数据的构造</h3><ul id="fd167032-8abd-4d5c-9e72-4bd29d248bdd" class="toggle"><li><details open=""><summary>折线图</summary><ul id="0db3e80b-e1c7-478a-88ff-0e30fb04f3cd" class="bulleted-list"><li style="list-style-type:disc">这里先生成一组虚构数据。这是一组多时点处理的数据</li></ul><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="7b67524d-ef21-40a1-bed4-5605bcb7af8b" class="code"><code class="language-Plain Text">// Create fake data 
clear
range i 1 4 4
expand 10
sort i
g id=_n
expand 10
bys id: g t=_n
g ttime=(i==1)*(-2)+(i==2)*3+(i==3)*5+(i==4)*15
g d=(t&gt;ttime)
g te=(10-i)*(t-ttime)*d
set seed 10101
drawnorm x e
g y=te+t+x+e</code></pre><ul id="23f33dc6-c480-4a8a-beec-724432da7f38" class="bulleted-list"><li style="list-style-type:disc">使用 <code>xtline</code> 绘制折线图</li></ul><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="9a6650cb-8bf0-4303-824b-5580f63607e3" class="code"><code class="language-Plain Text">// method 1: line graph combation
xtset id t
set scheme tufte
xtline y if i==1, overlay legend(off) title(&quot;always-treated&quot;) name(fig_1,replace)
xtline y if i==2, overlay legend(off) title(&quot;first-treated&quot;) name(fig_2,replace)
xtline y if i==3, overlay legend(off) title(&quot;second-treated&quot;) name(fig_3,replace)
xtline y if i==4, overlay legend(off) title(&quot;never-treated&quot;) name(fig_4,replace)
graph combine fig_1 fig_2 fig_3 fig_4, ycomm
graph drop fig_1 fig_2 fig_3 fig_4</code></pre><ul id="6f806a56-12c6-4dda-bd68-34b5220fe45e" class="bulleted-list"><li style="list-style-type:disc">绘制结果如下图所示</li></ul><figure id="5dd1c886-18a1-4735-bcf9-0ed0640a3286" class="image" style="text-align:center"><a href="Graph%201.svg"><img style="width:468px" src="Graph%201.svg"/></a></figure></details></li></ul><ul id="c4e28ed0-bbdd-4c22-908c-d345a8a020f6" class="toggle"><li><details open=""><summary>热力图 <code>panelview</code>  </summary><ul id="f5209052-996b-4e7e-baf0-eefe000de348" class="bulleted-list"><li style="list-style-type:disc"><code>panelview</code> 需要预先下载，同时还有其所依赖的<code>labutil</code> <code>sencode</code> <code>grc1leg</code> <code>gr0075</code> ，详细介绍见</li></ul><figure id="e94b08e0-5916-41eb-859b-36f20006001b"><a href="https://mp.weixin.qq.com/s/-xkrUPOymmxRlrS3rroJjA" class="bookmark source"><div class="bookmark-info"><div class="bookmark-text"><div class="bookmark-title">Stata绘图：面板数据可视化-panelview</div><div class="bookmark-description">连享会课程：空间计量专题  \x0d\x0a主讲老师：杨海生 (中山大学)；范巧 (兰州大学)\x0d\x0a课程时间：2022 年 9 月17-18 日 ；24-25 日\x0d\x0a课程主页：https://gitee.com/lianxh/SP</div></div><div class="bookmark-href"><img src="https://res.wx.qq.com/a/wx_fed/assets/res/MjliNWVm.svg" class="icon bookmark-icon"/>https://mp.weixin.qq.com/s/-xkrUPOymmxRlrS3rroJjA</div></div><img src="https://mmbiz.qpic.cn/mmbiz_jpg/cCEqAEoUCHyMlqjn5A1ORGWoiacotKNHyhnP1mWJFQJMB15YtXW9NyUibwicEuwhKPVz82ia8m0tyHbZYA2HDic7DRg/0?wx_fmt=jpeg" class="bookmark-image"/></a></figure><ul id="df28d211-ff71-4166-a2cf-334e69358460" class="bulleted-list"><li style="list-style-type:disc">使用 <code>panelview</code> 绘制热力图</li></ul><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="e8157ac7-f829-4d32-874f-1a737118c5f8" class="code"><code class="language-Plain Text">panelview y d x, i(id) t(t) type(treat)
* panelview y d x, i(id) t(t) type(outcome)</code></pre><ul id="68ee5f4e-e574-41e5-a745-e5b312d4d948" class="bulleted-list"><li style="list-style-type:disc">绘制结果如下图所示</li></ul><figure id="461b6cb1-c81e-4548-be18-1bc7dfac7f4e" class="image" style="text-align:center"><a href="panelview.svg"><img style="width:384px" src="panelview.svg"/></a></figure><p id="aa012393-3191-4fbd-bc0b-07815e3f8285" class="">
</p></details></li></ul><ul id="6b73bb96-ad9a-4f89-9990-aa3422c19a48" class="toggle"><li><details open=""><summary>热力图 <code>heatplot</code> </summary><ul id="a11916f5-1939-4673-a535-6bb3b4ccbc48" class="bulleted-list"><li style="list-style-type:disc"><mark class="highlight-yellow_background">代码需要更新</mark></li></ul><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="790b44f5-0408-46c8-b509-b0a2b255841d" class="code"><code class="language-Plain Text">use panelview48.dta,clear

replace hyear=2035 if missing(hyear)
forval year=2010/2018 {
	gen t_`year&#x27;=(hyear&lt;=`year&#x27;)
}
global time_list t_*
gsort -initial_county_finc
* gsort hyear $time_list
* replace hcode=_n
mkmat $time_list, mat(D) rownames(countyid) 
mat colnames D = 2010 2011 2012 2013 2014 2015 2016 2017 2018

// option parameters for heatplot
scalar iw_block=.97 // relative interval width of blocks
local co_block &quot;navy&quot; // major color of blocks
scalar ylab_height = 4 //`=_N&#x27;/12.5

heatplot D, levels(2) size srange(`=iw_block&#x27; `=iw_block&#x27;) /// cut(0(1)1)
	colors(`co_block&#x27;*.2 `co_block&#x27;) /// colors(economist,gs reverse)
	xtitle(&quot;Year&quot;,margin(small)size(3))xlabel(,labsize(2.5)) ///
	ytitle(&quot;County&quot;,margin(medium)size(3))ylabel(`=ylab_height&#x27; &quot;Richer&quot; `=_N-ylab_height&#x27; &quot;Poorer&quot;, angle(90) noticks labsize(2.5)) ///nolabel
	legend(order(1 &quot;Under Control&quot; 2 &quot;Under Treatment&quot;)subtitle(&quot;&quot;)rows(1)position(6)region(fc(none)lc(none))) ///
	xsize(17)ysize(20) scheme(s1mono) graphregion(fc(none)lc(none)ifc(none)ilc(none))plotregion(margin(small))</code></pre></details></li></ul><h2 id="326cd099-a14a-46b1-942d-e358dfcffd7d" class="">经典DiD</h2><h3 id="d06ca1f9-b418-4b49-a72d-bde30f3a9121" class="">处理组的定义与政策变量的生成</h3><ul id="8b91e87a-237e-45d8-8060-330de0bf97ae" class="toggle"><li><details open=""><summary>示例</summary><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="46a7605c-bf72-409e-8bc9-798c53277bf3" class="code"><code class="language-Plain Text">use &quot;http://dss.princeton.edu/training/Panel101.dta&quot;, clear</code></pre><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="237cde07-6a8c-4071-ad58-69081711336b" class="code"><code class="language-Plain Text">* Create a dummy variable to indicate the time when the treatment started
gen time = (year&gt;=1994) &amp; !missing(year) 

*Create a dummy variable to identify the group exposed to the treatment
gen treated = (country&gt;4) &amp; !missing(country)

* Create an interaction between time and treated
gen did = time*treated</code></pre></details></li></ul><h3 id="008e166f-325f-46f6-92cb-286a72f7accf" class="">平均处理效应</h3><ul id="7e8dc465-5277-45a1-9833-93a771ee0ec6" class="toggle"><li><details open=""><summary></summary></details></li></ul><h3 id="056930b8-e343-41c8-a183-45112d98e9b3" class="">平行趋势检验</h3><ul id="76bcdbf1-4d60-405b-b880-f955be2a1767" class="toggle"><li><details open=""><summary>生成年份虚拟变量与实验组虚拟变量的交互项</summary><p id="102b848a-bda4-47d4-b9eb-517d7b7ffea5" class="">此处选在政策前后各3年进行对比。</p><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="450aea72-8c50-4ba1-8669-ed8872f8462e" class="code"><code class="language-Plain Text">gen period = year - 1994
tab period, m
forvalues i = 16(-1)1{
	gen pre_`i&#x27; = (period == -`i&#x27; &amp; treati == 1)
	lab var pre_`i&#x27; &quot;-`i&#x27;&quot;
}
gen current = (period == 0 &amp; treati == 1)
forvalues i = 1(1)12{
	gen  pos_`i&#x27; = (period == `i&#x27; &amp; treati == 1)
	lab var pos_`i&#x27; &quot;`i&#x27;&quot;
}
// t=-1作为参照期
replace pre_1 = 0</code></pre></details></li></ul><ul id="a6a9414c-3075-4c20-9b2a-4cbd2dcef3fc" class="toggle"><li><details open=""><summary>将这些交互项作为解释变量进行回归，然后采用<code>coefplot</code>命令进行绘图</summary><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="e0cb9d54-e6a3-4a6b-bb11-34e555c3a64b" class="code"><code class="language-Plain Text">xtreg y time treated pre_* current pos_* i.year, fe 
coefplot, keep(pre_* current pos_*) vertical recast(connect) omit yline(0) xline(3, lp(dash))</code></pre></details></li></ul><h3 id="ccacf487-6381-4ee9-9ab1-6054a85cf5a3" class=""><strong>平行趋势的敏感性检验</strong></h3><ul id="23a3518f-3d1f-470d-9293-1c2f2597592a" class="toggle"><li><details open=""><summary>Pre-trend <a href="https://academic.oup.com/restud/article/90/5/2555/7039335">(Ramanchan &amp; Roth, 2023 RES)</a></summary><figure id="814308e7-6435-4ff3-b791-b1e33b7ab492"><a href="https://mp.weixin.qq.com/s/vY0Yl0xM8AGdTZU43BRC7A" class="bookmark source"><div class="bookmark-info"><div class="bookmark-text"><div class="bookmark-title">平行趋势的敏感性检验, 结果能容忍违反多大程度的平行趋势</div><div class="bookmark-description">Sensitivity analysis to parallel trend.</div></div><div class="bookmark-href"><img src="https://res.wx.qq.com/a/wx_fed/assets/res/MjliNWVm.svg" class="icon bookmark-icon"/>https://mp.weixin.qq.com/s/vY0Yl0xM8AGdTZU43BRC7A</div></div><img src="https://mmbiz.qpic.cn/mmbiz_jpg/gPuXCNBzgTfhFDgKlsBaXQhticEDZgMKC0c1DGtIEiamBo7Culv9L8nhcRezzFqxSr63GuAGVCKLq1DwDibfhUtMA/0?wx_fmt=jpeg" class="bookmark-image"/></a></figure><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="b7b4215b-8642-402c-b1e1-ad3e8215f97a" class="code"><code class="language-Plain Text">// 平行趋势的敏感性检验
global honesttestopts &quot;mvec(.0025(.0025).01) alpha(0.1) &quot;
*global honestplotopts &quot;xtitle(&quot;{fontface 宋体:平行趋势不成立的相对程度}&quot;) ytitle(&quot;90%{fontface 宋体:稳健置信区间}&quot;) ylab(-.05(.01)0) scheme(s1mono) colorspec(black gs8)&quot;
global honestplotopts &quot;xtitle(&quot;{fontface Times New Roman:{it: _{char 13}M}}&quot;, bmargin(0 0 0 -5)) ytitle(&quot;&quot;) ylab(-.05(.01)0) scheme(s1mono) colorspec(black gs8)&quot; //Mbar

// TWFE model
reghdfe y pre* current pos* x, abs(id t) cluster(id)

mat mat1_twfe = e(b)
mat mat2_twfe = e(V)

// relative magnitudes
honestdid, b(mat1_twfe) vcov(mat2_twfe) delta(rm) pre(1/3 5) post(6/17) mvec(.1(.1)1) alpha(0.05)
* rm (for relative magnitudes)
honestdid, cached coefplot $honestplotopts title(&quot;TWFE&quot;) 

// second differences
honestdid, b(mat1_twfe) vcov(mat2_twfe) delta(sd) pre(1/3 5) post(6/17) mvec(.01(.01).1) alpha(0.05)
* sd (second differences)
honestdid, cached coefplot $honestplotopts title(&quot;TWFE&quot;) 

// transfiguring and saving
gr_edit .xaxis1.title.DragBy 2.3 0 // adjust title position

graph export &quot;pretrend_twfe.png&quot;, replace as(png)</code></pre><ul id="2df104a5-d09f-44bf-b2cb-e82e022fd96e" class="bulleted-list"><li style="list-style-type:disc"><code>honestdid</code> 默认在检验的是事后第一期的敏感性，如果想要改变这一设置，需要定义权重矩阵并在 <code>l_vec</code> 选项中声明。我设计了下面这个程序便于权重矩阵的生成<ul id="2db0a3a3-13b3-4ebb-9485-116c167c5646" class="bulleted-list"><li style="list-style-type:circle"><code>pre()</code> 和 <code>post()</code> 两个选项与 <code>honestdid</code> 一致</li></ul><ul id="ef18a804-04a8-4a9b-be61-5f1984b046a8" class="bulleted-list"><li style="list-style-type:circle"><code>lweight</code> 有四种指定方式：AVG（事后所有期等权重）、NO0（事后非第一期等权重）、LAST（只检验最后一期）和LAST2（只检验最后两期）</li></ul><ul id="7514536a-d885-4426-a686-1a2be53973e5" class="bulleted-list"><li style="list-style-type:circle">权重矩阵名称为 l_vec </li></ul></li></ul><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="89e2bf40-6ff0-4794-ba11-6035870f7cd0" class="code"><code class="language-Plain Text">// way to generate weight matrix
cap program drop genwmat
program define genwmat
	syntax, PRE(numlist) POST(numlist) /// conherent to honestdid
			LWEIght(string) // = AVG or NO0 or LAST or LAST2

	// beginning point 
	cap mat drop BEGP
	foreach i of numlist `pre&#x27; {
		mat BEGP = (nullmat(BEGP), `i&#x27;)
	}
	scalar begp = `=BEGP[1,1]&#x27;
	// time span of post period
	cap mat drop TSPAN
	foreach i of numlist `post&#x27; {
		mat TSPAN = (nullmat(TSPAN), `i&#x27;)
	}
	scalar tspan_1 = colsof(TSPAN)
	scalar tspan_2 = `=TSPAN[1,`=tspan_1&#x27;]&#x27;-`=TSPAN[1,1]&#x27;+1
	if (tspan_1==tspan_2) scalar tspan=tspan_2
	else {
		di &quot;time span of post period is uncertain.&quot;
		exit
	}
	// determining l_vec
	if &quot;`lweight&#x27;&quot;==&quot;AVG&quot; {
		mat l_vec = J(`=tspan&#x27;,1,`=1/tspan&#x27;)
	}
	else if  &quot;`lweight&#x27;&quot;==&quot;NO0&quot; {
		mat l_vec = J(`=tspan-1&#x27;,1,`=1/(tspan-1)&#x27;)
		mat l_vec = (0 \ l_vec)
	}
	else if  &quot;`lweight&#x27;&quot;==&quot;LAST&quot; {
		mat l_vec = J(`=tspan-1&#x27;,1,0)
		mat l_vec = (l_vec \ 1)
	}
	else if  &quot;`lweight&#x27;&quot;==&quot;LAST2&quot; {
		mat l_vec = J(`=tspan-2&#x27;,1,0)
		mat l_vec = (l_vec \ .5 \ .5)
	}
	else {
		di &quot;lweight is wrong prescribed!&quot;
		cap mat drop TSPAN
		exit
	}
	cap mat drop TSPAN
end</code></pre><ul id="10c8af90-2577-8036-a96a-fe358e5b2c7f" class="bulleted-list"><li style="list-style-type:disc">关于如何选择<style>@import url('https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.9/katex.min.css')</style><span data-token-index="0" contenteditable="false" class="notion-text-equation-token" style="user-select:all;-webkit-user-select:all;-moz-user-select:all"><span></span><span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mover accent="true"><mi>M</mi><mo>ˉ</mo></mover></mrow><annotation encoding="application/x-tex">\bar{M}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8201em;"></span><span class="mord accent"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8201em;"><span style="top:-3em;"><span class="pstrut" style="height:3em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">M</span></span><span style="top:-3.2523em;"><span class="pstrut" style="height:3em;"></span><span class="accent-body" style="left:-0.1667em;"><span class="mord">ˉ</span></span></span></span></span></span></span></span></span></span></span><span>﻿</span></span>见 <a href="https://docs.google.com/document/d/1HTt-Fk8C5nFvfZgXazFhsGtKAByUJ7ie/edit?usp=drive_link&amp;ouid=105858222916034730813&amp;rtpof=true&amp;sd=true">[Google drive]</a></li></ul></details></li></ul><ul id="9f3ca997-a392-4e45-ab3c-beca88b3cbb8" class="toggle"><li><details open=""><summary>函数形式</summary><ul id="1b6528c5-713e-42f5-b8cb-0490c04bfc73" class="bulleted-list"><li style="list-style-type:disc">如果未处理潜在结果的分布随时间保持稳定，或者处理实际上是随机分配的，那么平行趋势假设就不太可能对函数形式敏感 <a href="https://onlinelibrary.wiley.com/doi/abs/10.3982/ECTA19402">(Roth &amp; Sant&#x27;Anna, 2023 ECTA)</a>。</li></ul><ul id="318648fa-a2f9-4ab9-8a70-43b8af1855ca" class="bulleted-list"><li style="list-style-type:disc">否则，应当对结果变量的函数形式（如有）进行敏感性分析。分析方式见 <a href="https://onlinelibrary.wiley.com/doi/abs/10.3982/ECTA19402">Roth &amp; Sant&#x27;Anna (2023 ECTA)</a> 的 Testable Implications。</li></ul></details></li></ul><h3 id="7a96267f-79e5-4722-ab43-80b375ad403d" class="">安慰剂检验</h3><ul id="a5b436e9-2eef-4ff1-b9d8-06327cf7631a" class="toggle"><li><details open=""><summary>代码示例</summary><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="05aeb04c-13fb-4b04-8b72-43e354b413d8" class="code"><code class="language-Plain Text">// 安慰剂检验
forvalues i=1(1)500 {
	use dodata,clear
	save ydyl_data,replace
	use ydyl_data,clear
	keep citycode _日期

	bysort citycode _日期: gen temp_code=_n
	keep if temp_code==1
	drop temp_code

	drop if _日期==2010
	save dummy_data,replace
	use dummy_data,clear
	** create the false dataset
	bysort _日期: keep if _n==1
	sample 1, count
	keep _日期
	save temp,replace
	use dummy_data,clear
	merge m:1 _日期 using temp
	keep if _merge==3
	drop _merge
	sample 36, count
	keep _日期 citycode
	rename _日期 ydyl_日期
	save ydyl_time,replace

	* Generate the false_ydyl_after variable
	use ydyl_time
	merge 1:m citycode using ydyl_data
	gen false_citycode=(_merge==3)
	drop _merge
	egen tt=mean(ydyl_日期)
	replace ydyl_日期=tt
	drop tt
	gen false_after=(_日期-ydyl_日期&gt;=0)
	gen false_ydyl_after=false_citycode*false_after
	save ydyl_data,replace

	* Regression

	reghdfe ln_quality false_ydyl_after Capital_City_t Yangtz_City_t ratio_fiscal_t ratio_gdp_t lnstudent_t ratio_city_t Capital_City_t2 Yangtz_City_t2 ratio_fiscal_t2 ratio_gdp_t2 lnstudent_t2 ratio_city_t2 Capital_City_t3 Yangtz_City_t3 ratio_fiscal_t3 ratio_gdp_t3 lnstudent_t3 ratio_city_t3 , absorb(i._日期 _企业编码) vce(cluster province)

	parmest,format (estimate min95 max95 %8.2f p %8.3f) saving(&quot;temp.dta&quot;, replace)
	use &quot;temp.dta&quot;, clear
	keep if parm==&quot;false_ydyl_after&quot;
	append using &quot;ydyl_simulations.dta&quot;
	save &quot;ydyl_simulations.dta&quot;, replace
}
erase &quot;temp.dta&quot;
use &quot;ydyl_simulations.dta&quot;, clear
drop if estimate==.
save &quot;ydyl_simulations.dta&quot;, replace

**Graphs

*Density Plot
dpplot estimate,xline(0.129) xtitle(&quot;虚假估计系数&quot;) ytitle(&quot;估计系数密度分布&quot;)  saving(&quot;PDF_ydyl_dpplot.gph&quot;, replace)</code></pre></details></li></ul><ul id="7224af56-c07b-4e83-9b8f-1adf1cfa6625" class="toggle"><li><details open=""><summary>安慰剂检验前沿文献</summary><p id="2e3dfb23-5783-4b9e-a10f-41733869be51" class="">
</p></details></li></ul><h2 id="9839e6a2-5cec-4bf5-9f8c-e09916f4ed29" class="">交叠/多时点DiD</h2><h3 id="c9917729-1918-4919-916f-70070c7fe4ab" class="">处理组的定义与政策变量的生成</h3><p id="15b353e9-f69f-4fd2-af9d-c4b692ce1a9b" class="">交叠/多时点DiD的处理组的识别和定义较为灵活，这里以案例的形式展开</p><ul id="f1983bff-ff20-4605-824b-13fb17088cf3" class="toggle"><li><details open=""><summary>案例1：处理时点少，处理组名单以文本形式存在</summary><div id="0d033091-464b-4d72-916e-4fd8829c130f" class="column-list"><div id="801cc037-c7f1-4d55-b966-1b8ce62df889" style="width:12.5%" class="column"><p id="b2b7bcab-f5f0-4c2d-84d2-ae61208cf825" class="">主要步骤：</p></div><div id="8171f0d8-ffe4-4c29-aa6c-d708e591a77a" style="width:112.5%" class="column"><ol type="1" id="8ee2edcd-9208-4f95-bfcf-1fddf514663c" class="numbered-list" start="1"><li>初始时，为所有城市创建一个名为<code>group</code>的变量，并赋值为0，表示这些城市属于控制组</li></ol><ol type="1" id="5848be6a-c594-412d-9ae9-79c2145dfab2" class="numbered-list" start="2"><li>为不同批次的处理组打标签<ol type="a" id="7c09370b-2ac8-4741-aadf-82a90ff7c927" class="numbered-list" start="1"><li>使用<code>regexm()</code>函数检查<code>city</code>变量中的城市名是否在名单中</li></ol><ol type="a" id="ad5af012-f9cb-4866-8ee6-fdd5e325fe34" class="numbered-list" start="2"><li>使用<code>levelsof</code>命令检查并显示每个批次中的城市数量，以确保数据正确</li></ol></li></ol><ol type="1" id="0c8e3287-a68e-4846-9f45-1e7877c241e4" class="numbered-list" start="3"><li>使用<code>lab var</code>和<code>lab define</code>命令为<code>group</code>变量添加标签</li></ol><ol type="1" id="07333117-cb86-4f80-8637-54105aa5f65f" class="numbered-list" start="4"><li>创建一个名为<code>tyear</code>的变量，表示处理的年份，对于控制组，该变量缺失（设置为<code>.</code>）</li></ol><ol type="1" id="3b141c3c-1c78-4691-a93f-42b9c6eb0454" class="numbered-list" start="5"><li>生成政策变量：如果<code>tyear</code>小于或等于当前年份<code>year</code>，则政策变量被设置为1；否则为0（但对于控制组，它始终为0）</li></ol></div></div><p id="d60f6edf-9b35-45be-b3e3-e06c41e2ca12" class="">本例以“宽带中国”示范城市这一具体的政策为示范</p><p id="640df050-a3c2-4293-8bdd-725baff91ff2" class="">关于“宽带中国”示范城市：[<a href="https://www.gov.cn/gzdt/2014-01/16/content_2568722.htm">通知</a>] [<a href="https://www.miit.gov.cn/ztzl/lszt/qltjkdzg/mtjj/art/2014/art_20c18114eeb542c1bc8987ab1c43a2d7.html">2014名单</a>] [<a href="https://www.gov.cn/xinwen/2015-10/19/content_2949787.htm">2015名单</a>] [<a href="https://www.miit.gov.cn/zwgk/zcwj/wjfb/gg/art/2020/art_3855b1fb82384bc69468bc54a2bdf56e.html">2016名单</a>]</p><p id="d777a123-0dd4-4594-af58-7ea4539e7e1e" class="">下面是以“宽带中国”示范城市为例，生成政策变量的代码：</p><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="6f920a25-d24e-4ac7-a1b5-792889ed9e4b" class="code"><code class="language-Plain Text">/*******************************************************************************
	“宽带中国”示范城市数据
*******************************************************************************/
* countrol group
gen group=0

**# 2014 
*https://www.miit.gov.cn/ztzl/lszt/qltjkdzg/mtjj/art/2014/art_20c18114eeb542c1bc8987ab1c43a2d7.html
replace group=1 if regexm(&quot;北京市、天津市、上海市、长株潭城市群（长沙市、株洲市、湘潭市）、石家庄市、大连市、本溪市、延边朝鲜族自治州、哈尔滨市、大庆市、南京市、苏州市、镇江市、昆山市、金华市、芜湖市、安庆市、福州市（含平潭）、厦门市、泉州市、南昌市、上饶市、青岛市、淄博市、威海市、临沂市、郑州市、洛阳市、武汉市、广州市、深圳市、中山市、成都市、攀枝花市、阿坝藏族羌族自治州、贵阳市、银川市、吴忠市、阿拉尔市&quot;, city)
levelsof city if group==1, clean local(citylist)
di wordcount(&quot;`citylist&#x27;&quot;)

**# 2015 
*https://www.gov.cn/xinwen/2015-10/19/content_2949787.htm
replace group=2 if regexm(&quot;太原市、呼和浩特市、鄂尔多斯市、鞍山市、盘锦市、白山市、扬州市、嘉兴市、合肥市、铜陵市、莆田市、新余市、赣州市、东营市、济宁市、德州市、新乡市、永城市、黄石市、襄阳市、宜昌市、十堰市、随州市、岳阳市、汕头市、梅州市、东莞市、重庆市江津区、重庆市荣昌区、绵阳市、内江市、宜宾市、达州市、玉溪市、兰州市、张掖市、固原市、中卫市、克拉玛依市&quot;, city)
levelsof city if group==2, clean local(citylist)
di wordcount(&quot;`citylist&#x27;&quot;)

**# 2016 
*https://www.miit.gov.cn/zwgk/zcwj/wjfb/gg/art/2020/art_3855b1fb82384bc69468bc54a2bdf56e.html
replace group=3 if regexm(&quot;阳泉市、晋中市、乌海市、包头市、通辽市、沈阳市、牡丹江市、无锡市、泰州市、南通市、杭州市、宿州市、黄山市、马鞍山市、吉安市、烟台市、枣庄市、商丘市、焦作市、南阳市、鄂州市、衡阳市、益阳市、玉林市、海口市、九龙坡区、北碚区、雅安市、泸州市、南充市、遵义市、文山壮族苗族自治州、拉萨市、林芝市、渭南市、武威市、酒泉市、天水市、西宁市&quot;, city)
levelsof city if group==3, clean local(citylist)
di wordcount(&quot;`citylist&#x27;&quot;)

**# attaching label tag
lab var group &quot;“宽带中国”示范城市批次: 0=控制组，1=第1批(2014)，2=第2批(2015)，3=第3批(2016)&quot;
lab define group 0 &quot;控制组&quot; 1 &quot;第1批[2014]&quot; 2 &quot;第2批[2015]&quot; 3 &quot;第3批[2016]&quot;, modify
lab val group group
tab group 

// treated point
gen tyear=.
lab var tyear &quot;成为“宽带中国”示范城市年份（控制组缺失）&quot;
replace tyear=(group==1)*2014+(group==2)*2015+(group==3)*2016+cond(group==0,.,0)
tab group tyear, m

// policy variable
gen broadband=(tyear&lt;=year)
replace broadband = 0 if tyear==. //control group

// double check
if 0 { 
tab broadband group, m
tab broadband year if group&gt;0, m
tab broadband year if group==1, m
tab broadband year if group==2, m
tab broadband year if group==3, m
* 20个县，但是14个城市
tab broadband year if group==0, m
}</code></pre></details></li></ul><ul id="05287d92-0fc5-4d62-a2ef-afcece0d93bc" class="toggle"><li><details open=""><summary>案例2：已知被处理时点，<del>或者当期是否受到政策处理</del></summary><p id="a3e71394-67ff-4d20-8c93-ba2b64f41f7f" class="">shock_dum shock_num </p><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="489b5758-ea07-4fdd-8ae8-db86dd3fa022" class="code"><code class="language-Plain Text">bys id year: assert _N == 1
by id: gen shock_num = sum(shock_dum)
* list id year shock_dum shock_num in 1/20
gen did = (shock_num &gt; 0)</code></pre></details></li></ul><ul id="51c784ec-ae33-4287-8773-633e8c895a2c" class="toggle"><li><details open=""><summary>案例3：已有政策变量，识别处理试点</summary></details></li></ul><h3 id="a56df706-908f-4529-abea-8b8fd5238e4b" class="">平均处理效应</h3><ul id="cf7bbd28-f21c-4972-8f02-5422ff187fe8" class="toggle"><li><details open=""><summary>生成本例数据</summary><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="23108815-a073-4756-97b3-b8d5e28b5479" class="code"><code class="language-Plain Text">clear all
set seed 10101

// Create fake data 
* 10 periods (t); 4 groups (i) with 50 individuals (id) each
* id = 1 -&gt; always-treated
* id = 2 -&gt; first-treated
* id = 3 -&gt; second-treated
* id = 4 -&gt; never-treated
range i 1 4 4
expand 50
sort i
g id=_n
expand 10
bys id: g t=_n
g ttime=(i==1)*(-2)+(i==2)*3+(i==3)*5+(i==4)*15 //
g d=(t&gt;ttime)
g te=(10-i)*(t-ttime)*d //
set seed 10101
drawnorm x e
g y=te+t+x+5*e</code></pre><ul id="611875ef-c1fc-4405-8350-6514c127ea29" class="bulleted-list"><li style="list-style-type:disc">数据展示<figure id="7c26c8d7-9d60-44cb-bb8d-17f669e0f43f" class="image" style="text-align:center"><a href="Graph%201.svg"><img style="width:468px" src="Graph%201.svg"/></a></figure></li></ul></details></li></ul><ul id="aeea880d-d554-4c96-bedb-673c6feb267c" class="toggle"><li><details open=""><summary>ATE</summary><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="b52f0ecc-2a4e-4353-899b-98ecef3fdc41" class="code"><code class="language-Plain Text">// canonical TWFE model
xtset id t
xtreg y d x i.t, i(id) fe cluster(id)
* highly underestimated</code></pre></details></li></ul><ul id="1fe6223f-1ae5-4387-863d-5bc324896d1c" class="toggle"><li><details open=""><summary>Dynamic effect</summary><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="539a665e-0abc-4e41-8589-0a3ccc275e2c" class="code"><code class="language-Plain Text">// event-study
gen period = t - ttime
tab period
* pre-event dummies
forvalues i = 4(-1)1{
	gen pre`i&#x27; = (period == -`i&#x27; &amp; i&lt;4)
	lab var pre`i&#x27; &quot;-`i&#x27;&quot;
}
* current dummy
gen current = (period == 0 &amp; i&lt;4)
* post-event dummies
forvalues i = 1(1)12{
	gen  pos`i&#x27; = (period == `i&#x27; &amp; i&lt;4)
	lab var pos`i&#x27; &quot;`i&#x27;&quot;
}
* set t=-1 as referring point
replace pre1 = 0

reghdfe y pre* current pos* x, abs(id t) cluster(id)</code></pre></details></li></ul><h3 id="9ab5d60d-3900-4408-80e0-e411c9b144fe" class="">交叠/多时点DiD的前沿识别策略</h3><ul id="5a9f0f9f-a332-4f8d-9bab-e390fc827dfe" class="toggle"><li><details open=""><summary>双向固定效应TWFE估计交叠/多时点DiD的陷阱</summary><ul id="cbf943f9-910a-45d6-8441-e8cad1ff8d19" class="bulleted-list"><li style="list-style-type:disc">danger cautions<ul id="15472f3c-0c9b-4fe0-b848-4da923926cac" class="bulleted-list"><li style="list-style-type:circle">negative weights <a href="https://www.aeaweb.org/articles?id=10.1257/aer.20181169">(de Chaisemartin &amp; D&#x27;Haultfœuille, 2020)</a></li></ul><ul id="ae67ceff-a97e-4138-ab9c-7b3b806e59e0" class="bulleted-list"><li style="list-style-type:circle">contaminated event-study coefficients <a href="https://www.sciencedirect.com/science/article/abs/pii/S030440762030378X">(Sun &amp; Abraham, 2021) </a></li></ul></li></ul><ul id="5e7a2e1b-08d4-4634-aab1-90e25dcb1eff" class="bulleted-list"><li style="list-style-type:disc">Monte Carlo evidence <a href="https://pedrohcgs.github.io/posts/twfe">[Pedro H. C. Sant&#x27;Anna&#x27;s post]</a> <a href="https://linkinghub.elsevier.com/retrieve/pii/S0304405X22000204">[Baker et al. (2022)]</a></li></ul><ul id="6b8ff2c9-34d0-4d7a-8bc8-dec088d01a92" class="bulleted-list"><li style="list-style-type:disc">An illustration by <a href="https://pwya.github.io/">Panwang Yuang</a> <a href="https://pwya.github.io/post/%E8%AE%A1%E9%87%8F%E4%BA%A4%E5%8F%A0did%E5%AE%9E%E7%94%A8%E6%95%99%E7%A8%8B/">[website]</a></li></ul></details></li></ul><ul id="3f0367bb-6a5e-4cba-9328-cd4a321208c2" class="toggle"><li><details open=""><summary>生成本例数据</summary><ul id="56cf4a0c-1860-44f5-b5fd-67b500935906" class="bulleted-list"><li style="list-style-type:disc">与前节相同</li></ul></details></li></ul><ul id="1fc6e141-0d5e-43d2-a4da-bd2f6595b683" class="toggle"><li><details open=""><summary>负权重诊断(diagnosis)</summary><figure id="c547446a-4668-4db1-88bc-4d42d4550306"><a href="https://www.bilibili.com/video/BV1AL411Q7Au/?share_source=copy_web&amp;vd_source=bc9c539ccb1d2b7c076a42030004d4d4" class="bookmark source"><div class="bookmark-info"><div class="bookmark-text"><div class="bookmark-title">培根分解的Stata操作_哔哩哔哩_bilibili</div><div class="bookmark-description">培根分解的Stata操作, 视频播放量 6026、弹幕量 1、点赞数 135、投硬币枚数 57、收藏人数 190、转发人数 51, 视频作者 山东大学陈强教授, 作者简介 网站：www.econometrics-stata.com，相关视频：含协变量的培根分解，培根分解的案例：单边离婚改革与女性自杀率，交叠DID的陷阱：从Bacon分解说起（1），Roth and Sant&#x27;Anna (2023, ECM): 平行趋势假定对于函数形式的依赖性，Roth and Sant&#x27;Anna (2023, ECM): 推论、检验与实证建议，陈强-计量经济学及Stata应用，陈强-中介效应及Stata应用，交叠DID的陷阱：从Bacon分解说起（2），陈强-Stata, R与Python：我该选哪个语言，陈强-Stata中的标准误(2)：普通与异方差稳健标准误</div></div><div class="bookmark-href"><img src="https://i1.hdslb.com/bfs/archive/e53d807bb33b35e04508c4819504e3300c528ec8.jpg@100w_100h_1c.png@57w_57h_1c.png" class="icon bookmark-icon"/>https://www.bilibili.com/video/BV1AL411Q7Au/?share_source=copy_web&amp;vd_source=bc9c539ccb1d2b7c076a42030004d4d4</div></div><img src="https://i1.hdslb.com/bfs/archive/e53d807bb33b35e04508c4819504e3300c528ec8.jpg@100w_100h_1c.png" class="bookmark-image"/></a></figure><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="fd5efa81-9a60-4ecd-b180-114ed6a0047f" class="code"><code class="language-Plain Text">// Bacon-Decomposition
ddtiming y d, i(id) t(t)</code></pre><p id="eeb9bdf9-0f9a-44b2-9109-9d8b58067022" class=""><code>ddtiming</code>安装： <code>net install ddtiming, from(</code><code><a href="https://tgoldring.com/code/">https://tgoldring.com/code/</a></code><code>)</code></p></details></li></ul><ul id="67233183-89bf-4eef-a266-b7ae8cf76929" class="toggle"><li><details open=""><summary>Remedy for TWFE model in Event Study</summary><ul id="4427b2d1-eed7-4bd3-a074-0b8ef0064815" class="toggle"><li><details open=""><summary>Sun &amp; Abraham (2021) <a href="https://linkinghub.elsevier.com/retrieve/pii/S030440762030378X">[paper]</a></summary><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="e367cb75-0842-4d1d-af29-ac611315dad5" class="code"><code class="language-Plain Text">// Sun &amp; Abraham(2021)
preserve
gen never_treat = (ttime==15)
gen ttime_new = ttime
replace ttime_new = . if ttime==15 // missing for never treated units.
replace ttime_new = 0 if ttime &lt; 0

eventstudyinteract y pre* current* pos*, absorb(id t) cohort(ttime_new) control_cohort(never_treat) covariates(x)

restore</code></pre></details></li></ul><ul id="b7836264-c619-419e-8200-331ec4f58770" class="toggle"><li><details open=""><summary>Callaway and Sant&#x27;Anna (2020) <a href="https://www.sciencedirect.com/science/article/pii/S0304407620303948">[paper]</a></summary><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="51c1a440-40e4-4862-bf3d-67f52719a340" class="code"><code class="language-Plain Text">// Callaway and Sant&#x27;Anna (2020)
preserve
gen ttime_new = cond(ttime==15, 0, ttime) // in csdid, 0 represents nevertreated.
* always-treated group are not allowed in Callaway and Sant&#x27;Anna (2020).

csdid y x, ivar(id) time(t) gvar(ttime_new) rseed(1) agg(event)

restore</code></pre></details></li></ul><ul id="3a33d723-6248-4b3e-8cbb-ac7423175e4e" class="toggle"><li><details open=""><summary>de Chaisemartin &amp; D&#x27;Haultfoeuille(2020) <a href="https://academic.oup.com/ectj/advance-article/doi/10.1093/ectj/utac017/6604378">[paper]</a></summary><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="ac47175b-de43-4e1f-a965-b0c9473bf889" class="code"><code class="language-Plain Text">// de Chaisemartin &amp; D&#x27;Haultfoeuille(2020)
did_multiplegt y id t d, robust_dynamic dynamic(6) placebo(3) seed(10101) firstdiff_placebo covariances controls(x) cluster(id) 
* Effect_0 denotes t=1</code></pre></details></li></ul><ul id="1f5c76a2-df3b-4793-914d-00da603dbd2e" class="toggle"><li><details open=""><summary>Borusyak et al. (2024) <a href="https://academic.oup.com/restud/advance-article/doi/10.1093/restud/rdae007/7601390">[paper]</a> </summary><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="46ee2851-7c59-446a-abd6-dd9dfda749d9" class="code"><code class="language-Plain Text">// Borusyak et al.(forthcoming)
preserve
gen ttime_new = ttime
replace ttime_new = . if ttime==15 // missing for never treated units.

did_imputation y id t ttime_new, fe(id t) controls(x) pretrends(3) horizons(0/6) cluster(id) autosample

restore</code></pre></details></li></ul><ul id="59ab5c87-cfc7-4087-a60e-0af562e4c9c5" class="toggle"><li><details open=""><summary>Gardner (2021) <a href="https://arxiv.org/abs/2207.05943">[paper]</a></summary><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="35e4cf71-12c9-4dc3-9705-3d72e0bfa046" class="code"><code class="language-Plain Text">// Gardner (2021)
did2s y, first_stage(i.t i.id x) second_stage(pre* current* pos*) treatment(d) cluster(id)</code></pre></details></li></ul><ul id="9af60b9b-4b62-413e-b19f-984ccda25b3e" class="toggle"><li><details open=""><summary>Cengiz et al. (2019) <a href="https://academic.oup.com/qje/article/134/3/1405/5484905">[paper]</a></summary><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="a114b2b1-41f4-49de-8fc3-9c1c749a9605" class="code"><code class="language-Plain Text">preserve
gen never_treat=(ttime==15)
gen ttime_new = ttime
replace ttime_new = . if ttime==15 // missing for never treated units.
replace ttime_new = 0 if ttime &lt; 0

stackedev y pre* current* pos*, cohort(ttime_new) time(t) clust_unit(id) unit_fe(id) never_treat(never_treat) covariates(x) 

restore</code></pre></details></li></ul><ul id="8a7757d9-7b59-44c4-9e65-0f64ddd30b7a" class="toggle"><li><details open=""><summary>Others</summary><ul id="c8274172-64e9-4b0d-95a7-5f62d5b54d39" class="bulleted-list"><li style="list-style-type:disc">see <a href="https://asjadnaqvi.github.io/">Asjad Naqvi</a>’s repository <a href="https://asjadnaqvi.github.io/DiD/">[website]</a></li></ul></details></li></ul><ul id="4f188ea1-4414-4870-abc7-498595c736d0" class="toggle"><li><details open=""><summary>Pros and cons</summary><table id="f3914c69-163c-43f7-8bc3-b7395acefd13" class="simple-table"><tbody><tr id="d8d501d2-61a8-4e0b-ba6a-754cfca5e9f7"><td id="fwkd" class="" style="width:217px">Method</td><td id="jou;" class="" style="width:222px">Advocators</td><td id="MAku" class="" style="width:353px">Pros</td><td id="z`jS" class="" style="width:353px">Cons</td></tr><tr id="691a616e-7ff3-4074-bd65-5d122e5bc638"><td id="fwkd" class="" style="width:217px">A stacked regression</td><td id="jou;" class="" style="width:222px">Cengiz et al. (2019)</td><td id="MAku" class="" style="width:353px"><span style="border-bottom:0.05em solid">&lt;1&gt; </span>“This approach is likely<strong> the most easily implementable solution</strong> for researchers interested in producing aggregated treatment effect estimates via OLS while circumventing the problems introduced by staggered treatment timing and treatment effect heterogeneity.” (Baker et al, 2022 )</td><td id="z`jS" class="" style="width:353px"><span style="border-bottom:0.05em solid">&lt;1&gt;</span> “However, relative to the CS or SA approaches, the stacked regression estimator provides<strong> less flexibility</strong> for aggregation and <strong>may be inconsistent</strong> for the sample-average ATT.” (Baker et al, 2022 )</td></tr><tr id="2dcd368f-b0d5-42fd-afe4-8efb21c32b24"><td id="fwkd" class="" style="width:217px">DID extensions</td><td id="jou;" class="" style="width:222px">Callaway and Sant’Anna (2021)</td><td id="MAku" class="" style="width:353px"><span style="border-bottom:0.05em solid">&lt;1&gt;</span> “The first is that<strong> it provides sensible estimands</strong> even under arbitrary heterogeneity of treatment effects...The second advantage is that it makes <strong>transparent </strong>exactly which units are being used as a<br/>control group to infer the unobserved potential outcomes.” (Roth et al., 2023)<br/>&lt;2&gt; “CS only relies on <br/><strong>parallel trends </strong>between periods 2 and 3)” (i.e., one period before and after treatment timing) (Roth et al., 2023)</td><td id="z`jS" class="" style="width:353px"></td></tr><tr id="1618643c-19dd-487e-9224-c71d895884c4"><td id="fwkd" class="" style="width:217px"></td><td id="jou;" class="" style="width:222px">Sun and Abraham (2021)</td><td id="MAku" class="" style="width:353px"><span style="border-bottom:0.05em solid">&lt;1&gt; </span> “… are more amenable to the estimation approach under <strong>stationary differential trends </strong>in Rambachan and Roth (2023).” (de Chaisemartin &amp; d’Haultfoeuille, 2022)<br/><br/><span style="border-bottom:0.05em solid">&lt;2&gt;</span>“Harmon (2022) shows that the estimator of ATT1 proposed by Callaway and Sant’Anna (2021) and Sun and Abraham (2021) is the <strong>BLUE</strong> under (24) (i.e.,<br/><br/><style>@import url('https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.9/katex.min.css')</style><span data-token-index="0" contenteditable="false" class="notion-text-equation-token" style="user-select:all;-webkit-user-select:all;-moz-user-select:all"><span></span><span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>Y</mi><mrow><mi>g</mi><mo separator="true">,</mo><mi>t</mi></mrow></msub><mrow><mo fence="true">(</mo><msub><mn mathvariant="bold">0</mn><mi>t</mi></msub><mo fence="true">)</mo></mrow><mo>=</mo><msub><mi>α</mi><mi>g</mi></msub><mo>+</mo><msub><mi>γ</mi><mi>t</mi></msub><mo>+</mo><msub><mi>ε</mi><mrow><mi>g</mi><mo separator="true">,</mo><mi>t</mi></mrow></msub></mrow><annotation encoding="application/x-tex">Y_{g, t}\left(\mathbf{0}_t\right)=\alpha_g+\gamma_t+\varepsilon_{g, t}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.0361em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.22222em;">Y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.2222em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">g</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;">(</span><span class="mord"><span class="mord mathbf">0</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mclose delimcenter" style="top:0em;">)</span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.8694em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.0037em;">α</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0037em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">g</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.7778em;vertical-align:-0.1944em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05556em;">γ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:-0.0556em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.7167em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal">ε</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">g</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span></span></span><span>﻿</span></span> ), if errors follow a random walk.”(de Chaisemartin &amp; d’Haultfoeuille, 2022)</td><td id="z`jS" class="" style="width:353px"><strong><span style="border-bottom:0.05em solid">&lt;1&gt;</span></strong>“An important implication of the results derived by Sun and Abraham (2021) is that if treatment effects are heterogeneous, <strong>the ‘treatment lead’ coefficients</strong><br/>from (7) ( i.e., <br/><style>@import url('https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.9/katex.min.css')</style><span data-token-index="0" contenteditable="false" class="notion-text-equation-token" style="user-select:all;-webkit-user-select:all;-moz-user-select:all"><span></span><span><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>Y</mi><mrow><mi>i</mi><mo separator="true">,</mo><mi>t</mi></mrow></msub><mo>=</mo><msub><mi>α</mi><mi>i</mi></msub><mo>+</mo><msub><mi>ϕ</mi><mi>t</mi></msub><mo>+</mo><msub><mo>∑</mo><mrow><mi>r</mi><mo mathvariant="normal">≠</mo><mn>0</mn></mrow></msub><mn>1</mn><mrow><mo fence="true">[</mo><msub><mi>R</mi><mrow><mi>i</mi><mo separator="true">,</mo><mi>t</mi></mrow></msub><mo>=</mo><mi>r</mi><mo fence="true">]</mo></mrow><msub><mi>β</mi><mi>r</mi></msub><mo>+</mo><msub><mi>ϵ</mi><mrow><mi>i</mi><mo separator="true">,</mo><mi>t</mi></mrow></msub></mrow><annotation encoding="application/x-tex">Y_{i, t}=\alpha_i+\phi_t+\sum_{r \neq 0} 1\left[R_{i, t}=r\right] \beta_r+\epsilon_{i, t}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.9694em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.22222em;">Y</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.2222em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.7333em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.0037em;">α</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0037em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">i</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="mord"><span class="mord mathnormal">ϕ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.2806em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1.1858em;vertical-align:-0.4358em;"></span><span class="mop"><span class="mop op-symbol small-op" style="position:relative;top:0em;">∑</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1864em;"><span style="top:-2.4003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span><span class="mrel mtight"><span class="mrel mtight"><span class="mord vbox mtight"><span class="thinbox mtight"><span class="rlap mtight"><span class="strut" style="height:0.8889em;vertical-align:-0.1944em;"></span><span class="inner"><span class="mord mtight"><span class="mrel mtight"></span></span></span><span class="fix"></span></span></span></span></span><span class="mrel mtight">=</span></span><span class="mord mtight">0</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.4358em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord">1</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="minner"><span class="mopen delimcenter" style="top:0em;">[</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:-0.0077em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mclose delimcenter" style="top:0em;">]</span></span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.05278em;">β</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.0528em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">r</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.7167em;vertical-align:-0.2861em;"></span><span class="mord"><span class="mord mathnormal">ϵ</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3117em;"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mathnormal mtight">i</span><span class="mpunct mtight">,</span><span class="mord mathnormal mtight">t</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em;"><span></span></span></span></span></span></span></span></span></span></span><span>﻿</span></span> ) <strong>are not guaranteed to be zero</strong> even if parallel trends is satisfied in all periods (and vice versa), and thus evaluation of pre-trends based on these coefficients can be very misleading.” (Roth et al., 2023)</td></tr><tr id="6ed0a9c5-a957-4b40-9966-ac6da9fccf01"><td id="fwkd" class="" style="width:217px">Imputation estimators</td><td id="jou;" class="" style="width:222px">Borusyak et al. (2021)</td><td id="MAku" class="" style="width:353px"><span style="border-bottom:0.05em solid">&lt;1&gt;</span>“..., imputation estimators <strong>do not directly assume the PTA</strong> (parallel trends assumption). Instead, they restrict the expectation of the error terms from a parametric TWFE model.”(Chiu et al., 2023)<br/><br/><span style="border-bottom:0.05em solid">&lt;2&gt;</span>“Indeed, BJS prove that when Assumption 4 (i.e., Parallel Trends for Staggered Setting) holds, their estimator is efficient under<strong> homoskedasticity and serially uncorrelated errors</strong>” (Roth et al., 2023)</td><td id="z`jS" class="" style="width:353px"><span style="border-bottom:0.05em solid">&lt;1&gt;</span>“The estimators of Borusyak et al. (2021) may be more biased than those of Callaway and Sant’Anna (2021) and Sun and Abraham (2021) <strong>under differential trends that widen over time</strong>.”(de Chaisemartin and d’Haultfoeuille, 2022)</td></tr><tr id="ff077549-28ce-42e8-9276-05854d527060"><td id="fwkd" class="" style="width:217px"></td><td id="jou;" class="" style="width:222px">Gardner (2022)</td><td id="MAku" class="" style="width:353px">—</td><td id="z`jS" class="" style="width:353px">—</td></tr></tbody></table></details></li></ul></details></li></ul><h3 id="66bd7f30-0a53-4084-88aa-6debe4062323" class="">交叠/多时点DiD的平行趋势检验</h3><ul id="c762942a-92e6-4e66-8fc9-10377aa7b546" class="toggle"><li><details open=""><summary>定义</summary><div><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="5131f172-8d14-4b56-885d-2bcfa35edd15" class="code"><code class="language-Plain Text">// confidence interval level
scalar level=0.05 

// preparation
* name estimator matrix
cap program drop mat_name_list
program define mat_name_list,rclass
	version 16
	syntax, Period(numlist)
	local name_list &quot;&quot;
	foreach i of numlist `period&#x27; {
		if (int(`i&#x27;)-`i&#x27;!=0) { // period must be int.
			local name_list &quot;`name_list&#x27; null&quot;
		}
		else if (`i&#x27;&lt; 0) {
			local name_list &quot;`name_list&#x27; T`i&#x27;&quot;
		}
		else if (`i&#x27;&gt;=0) {
			local name_list &quot;`name_list&#x27; T+`i&#x27;&quot;
		}
	}
	* di &quot;`name_list&#x27;&quot;
	return local name_list &quot;`name_list&#x27;&quot;
end

* plot event study and reorganize matrix
cap program drop program_eventstudy
program define program_eventstudy
	version 16
	args matsname
	syntax anything [, SAVE(string) Level(string)]
	// confidence level
	if &quot;`level&#x27;&quot;==&quot;&quot; {
		local level=0.05
	}
	else {
		local level=`level&#x27;
	}
	di &quot;`matsname&#x27; `save&#x27; `level&#x27;&quot; 
	// set graph_opt, following Luca et al.(2022)
	local graph_opt stub_lag(T+#) stub_lead(T-#)ciplottype(rcap) plottype(scatter) ///
		graph_opt(bgcolor(white) plotregion(color(white)) graphregion(color(white))) ///
		lag_opt(msymbol(D) mcolor(black) msize(small)) lead_opt(msymbol(D) mcolor(black) msize(small)) ///
		lag_ci_opt(lcolor(black) lwidth(medthin)) lead_ci_opt(lcolor(black) lwidth(medthin))
	// main part
	if &quot;`save&#x27;&quot;==&quot;&quot; {
		event_plot `matsname&#x27; , `graph_opt&#x27;
	}
	else {
		preserve
		event_plot `matsname&#x27; , `graph_opt&#x27; savecoef alpha(`level&#x27;)
		keep __event_* // __event_H1 __event_coef1 __event_hi1 __event_lo1 __event_pos1
		ren (__event_H1 __event_coef1 __event_hi1 __event_lo1) (period coef_`save&#x27; ub_`save&#x27; lb_`save&#x27;)
		drop __event_*
		drop if missing(period)
		compress
		save &quot;eventcoef_`save&#x27;.dta&quot;,replace
		restore
	}
end</code></pre></div></details></li></ul><h3 id="bab6048c-9b61-4fa0-a563-8709bd2d4ab5" class=""><strong>平行趋势的敏感性检验</strong></h3><ul id="de613a2c-1257-441a-b60b-39716b24ab3d" class="toggle"><li><details open=""><summary>Rambachan and Roth (2023)</summary><ul id="56e13944-e6eb-466f-aaaa-9061563b65e6" class="bulleted-list"><li style="list-style-type:disc">与非交叠的情形一致</li></ul></details></li></ul><h3 id="5a77ab58-5077-4c8b-822a-c7f54f924e5c" class="">安慰剂检验</h3><ul id="01530a33-ae40-40b7-bf43-d0326c2261a8" class="toggle"><li><details open=""><summary>代码示例</summary><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="e45a5a78-ea01-4fb8-a6d4-287234ce1b2f" class="code"><code class="language-Plain Text">// 安慰剂检验
forvalues i=1(1)500 {
	use dodata,clear
	save ydyl_data,replace
	use ydyl_data,clear
	keep citycode _日期

	bysort citycode _日期: gen temp_code=_n
	keep if temp_code==1
	drop temp_code

	drop if _日期==2010
	save dummy_data,replace
	use dummy_data,clear
	** create the false dataset
	bysort _日期: keep if _n==1
	sample 1, count
	keep _日期
	save temp,replace
	use dummy_data,clear
	merge m:1 _日期 using temp
	keep if _merge==3
	drop _merge
	sample 36, count
	keep _日期 citycode
	rename _日期 ydyl_日期
	save ydyl_time,replace

	* Generate the false_ydyl_after variable
	use ydyl_time
	merge 1:m citycode using ydyl_data
	gen false_citycode=(_merge==3)
	drop _merge
	egen tt=mean(ydyl_日期)
	replace ydyl_日期=tt
	drop tt
	gen false_after=(_日期-ydyl_日期&gt;=0)
	gen false_ydyl_after=false_citycode*false_after
	save ydyl_data,replace

	* Regression

	reghdfe ln_quality false_ydyl_after Capital_City_t Yangtz_City_t ratio_fiscal_t ratio_gdp_t lnstudent_t ratio_city_t Capital_City_t2 Yangtz_City_t2 ratio_fiscal_t2 ratio_gdp_t2 lnstudent_t2 ratio_city_t2 Capital_City_t3 Yangtz_City_t3 ratio_fiscal_t3 ratio_gdp_t3 lnstudent_t3 ratio_city_t3 , absorb(i._日期 _企业编码) vce(cluster province)

	parmest,format (estimate min95 max95 %8.2f p %8.3f) saving(&quot;temp.dta&quot;, replace)
	use &quot;temp.dta&quot;, clear
	keep if parm==&quot;false_ydyl_after&quot;
	append using &quot;ydyl_simulations.dta&quot;
	save &quot;ydyl_simulations.dta&quot;, replace
}
erase &quot;temp.dta&quot;
use &quot;ydyl_simulations.dta&quot;, clear
drop if estimate==.
save &quot;ydyl_simulations.dta&quot;, replace

**Graphs

*Density Plot
dpplot estimate,xline(0.129) xtitle(&quot;虚假估计系数&quot;) ytitle(&quot;估计系数密度分布&quot;)  saving(&quot;PDF_ydyl_dpplot.gph&quot;, replace)</code></pre></details></li></ul><h2 id="fab6f6f1-b940-41d2-a752-2312ba8f3747" class="">倾向得分匹配PSM</h2><ul id="9315116e-1ca8-4e90-bc9e-cc10669926f2" class="toggle"><li><details open=""><summary>1:1匹配</summary><p id="b3310851-3859-4361-82f9-1e3bbe91a041" class="">下例是在截面数据中</p><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="cf487516-53fb-4cd8-b2c0-6f596636cc27" class="code"><code class="language-Plain Text">// psm匹配
set seed 1
gen tmp = rnormal()
sort tmp
drop tmp
psmatch2 treatment covariates, out(y) neighbor(1) common caliper(0.05) logit noreplacement odds

// 用group纪录组别，同一组为编号
gen group = _n1
levelsof _n1, local(id_matched)
qui foreach idid in `id_matched&#x27; {
	replace group = _id if _id==`idid&#x27;
}
keep if group!=.
* 只保留匹配上的sample
bys group: assert _N==2

drop _nn _support _n1 _id _pscore _treated _pdif _changeratio_psmy _weight</code></pre><p id="26e79d40-f3a2-46c6-a21c-ea11bcaabe85" class="">也见 <a href="https://medium.com/@thestataguide/propensity-score-matching-in-stata-ba77178e4611">Propensity score matching in Stata</a></p><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="7f17757f-a149-4bab-944a-745a1371fbe9" class="code"><code class="language-Plain Text">teffects psmatch (changeratio_psmy) (quantitive establishdate inceptiontna gender edu_span businessduration), nneighbor(1) caliper(0.03)
* https://medium.com/@thestataguide/propensity-score-matching-in-stata-ba77178e4611</code></pre></details></li></ul><hr id="3d82c93f-01d6-4eec-96f0-bd300c2c35a3"/><h1 id="61e6ad1f-1328-4724-9c41-2fb22272aa75" class=""><span style="border-bottom:0.05em solid">6 Stata绘图</span></h1><ul id="f3e04f3f-ee31-4083-9b45-668bfd8dea90" class="toggle"><li><details open=""><summary>绘图预设</summary><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="e77a7812-caa6-4229-8f4e-1bee14c5264a" class="code"><code class="language-Plain Text">graph set window fontface &quot;Times New Roman&quot; // 宋体 Times New Roman
set scheme s1mono // s1mono white tufte</code></pre></details></li></ul><ul id="0b7cae94-7610-43e6-9317-e45465c9af6e" class="toggle"><li><details open=""><summary>图片导出</summary><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="c87f28f2-b890-46a6-82e6-d6998ab5817e" class="code"><code class="language-Plain Text">graph export &quot;graphname&quot;, replace as(png)</code></pre></details></li></ul><h2 id="b50fccf8-ebc7-40b7-926d-30974a8f9ab1" class="">个性化设置</h2><ul id="fabede32-cd54-4083-8bcd-1465140a1510" class="toggle"><li><details open=""><summary>常见配色</summary><figure id="1cf931aa-ba0b-406b-945c-8683bcc81acc" class="image" style="text-align:center"><a href="Stata_Color_Style.png"><img style="width:624px" src="Stata_Color_Style.png"/></a></figure></details></li></ul><ul id="cdf3abc1-3500-4338-b648-9d5ec4e005ad" class="toggle"><li><details open=""><summary>点标记样式</summary><figure id="7b4fc584-0a54-4137-9cba-d201fa7315ec" class="image" style="text-align:center"><a href="Untitled.png"><img style="width:576px" src="Untitled.png"/></a></figure></details></li></ul><ul id="ce061d91-8d50-4b2c-bb29-ee3e860a8085" class="toggle"><li><details open=""><summary>点标记大小</summary><figure id="420c6117-b653-49c9-9ecf-ed301e9f8f55" class="image" style="text-align:center"><a href="Untitled%201.png"><img style="width:672px" src="Untitled%201.png"/></a></figure></details></li></ul><ul id="3703167b-d225-437b-bbce-41154745f083" class="toggle"><li><details open=""><summary>线条样式</summary><figure id="ab17bbe7-9205-47cf-a84d-3b4e03bbdd8c" class="image" style="text-align:center"><a href="Untitled%202.png"><img style="width:624px" src="Untitled%202.png"/></a></figure></details></li></ul><h2 id="15c377ab-0c77-4335-8949-980f31d60d99" class="">案例</h2><h3 id="74f87bde-6ec1-429d-962d-da65d9ef1bf6" class="">核密度图与折线图合并</h3><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="4f390019-489c-4723-840c-f04c95727a82" class="code"><code class="language-Plain Text">// kurnal density
bys 年份: egen lnodis_mean = mean(lnodis)
bys 年份: egen lnodis_median = median(lnodis)

forval y=2003/2021 {
	kdensity lnodis if 年份==`y&#x27;, n(50) generate(kd_y_`y&#x27; kd_x_`y&#x27;) 
	replace kd_x_`y&#x27; = 5*kd_x_`y&#x27; + `y&#x27;
	*replace 
}

local connect_opt &quot;msymbol(none)lp(long)lc(gs8)&quot;
tw ///
	(connect kd_y_2003 kd_x_2003, `connect_opt&#x27;) ///
	(connect kd_y_2004 kd_x_2004, `connect_opt&#x27;) ///
	(connect kd_y_2005 kd_x_2005, `connect_opt&#x27;) ///
	(connect kd_y_2006 kd_x_2006, `connect_opt&#x27;) ///
	(connect kd_y_2007 kd_x_2007, `connect_opt&#x27;) ///
	(connect kd_y_2008 kd_x_2008, `connect_opt&#x27;) ///
	(connect kd_y_2009 kd_x_2009, `connect_opt&#x27;) ///
	(connect kd_y_2010 kd_x_2010, `connect_opt&#x27;) ///
	(connect kd_y_2011 kd_x_2011, `connect_opt&#x27;) ///
	(connect kd_y_2012 kd_x_2012, `connect_opt&#x27;) ///
	(connect kd_y_2013 kd_x_2013, `connect_opt&#x27;) ///
	(connect kd_y_2014 kd_x_2014, `connect_opt&#x27;) ///
	(connect kd_y_2015 kd_x_2015, `connect_opt&#x27;) ///
	(connect kd_y_2016 kd_x_2016, `connect_opt&#x27;) ///
	(connect kd_y_2017 kd_x_2017, `connect_opt&#x27;) ///
	(connect kd_y_2018 kd_x_2018, `connect_opt&#x27;) ///
	(connect kd_y_2019 kd_x_2019, `connect_opt&#x27;) ///
	(connect kd_y_2020 kd_x_2020, `connect_opt&#x27;) ///
	(connect kd_y_2021 kd_x_2021, `connect_opt&#x27;) ///
	(connect lnodis_median 年份, msymbol(th)lp(long)mc(gs4)lc(gs6)) ///
	(connect lnodis_mean 年份, msymbol(x)lp(long)mc(gs2)lc(gs0)) ///
	, legend(order(21 &quot;平均值&quot; 20 &quot;中位数&quot; 19 &quot;核密度分布&quot;)rows(1)) xline(2003/2021,lp(longdash)lc(gs14) noextend) ///
	xlab(2003(2)2021) xscale(range(2002 2022)) ytitle(&quot;lnodis&quot;) ///
	scale(.75) scheme(s1mono)</code></pre><h3 id="11d8af90-2577-80dc-93cf-e5caf087d095" class="">折线图—添加文字</h3><figure id="11d8af90-2577-808f-a35d-d8e52dcd0528" class="image" style="text-align:center"><a href="image.png"><img style="width:531px" src="image.png"/></a><figcaption><strong>Bilateral trade data between China</strong><br/><br/><em>Notes</em>. Bilateral trade data is collected from the IMF. Before taking the logarithm, the unit is in billions of dollars.</figcaption></figure><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="11d8af90-2577-8056-8370-db788b2aa11c" class="code"><code class="language-Plain Text">tw (tsline ln_usimport,lp(dash)) (tsline ln_usexport,lp(long)) /// `if year&gt;=1930&#x27;
	, xlab(1994(5)2024) xscale(range(1993 2024)) xtitle(&quot;&quot;) ///
	ylab(2(1)7) ytitle(&quot;China-US bilateral trade in logarithm&quot;) ///
	legend(order(2 &quot;Export&quot; 1 &quot;Import&quot;)size(small)position(10)ring(0)region(fc(none))) ///
	ttext(6.7 2008.2 &quot;Financial ciriss&quot;,j(left)place(3)size(small)) xline(2008, noextend) ///
	ttext(6.7 2018.2 &quot;Sino-US&quot; &quot;trade friction&quot;,j(left)place(3)size(small)) xline(2018, noextend) ///
	xsize(20)ysize(16)graphregion(fcolor(none)lcolor(none)ifcolor(none)ilcolor(none))plotregion(margin(zero)) 
*</code></pre><h3 id="11d8af90-2577-805a-ae7b-ef6a25f52e09" class="">散点图—添加点标签</h3><figure id="11d8af90-2577-80d8-b4d6-d2ef8c2184cc" class="image" style="text-align:center"><a href="image%201.png"><img style="width:531px" src="image%201.png"/></a><figcaption><strong>Cross-country GDP rank</strong><br/><br/><em>Notes</em>. GDP data is collected from the World Bank. The ranking is determined based on the GDP denominated in USD within sample data. CHN, USA, PRK, IRN, VNM, and SGP represent China, the United States, North Korea, Iran, Vietnam, and Singapore, respectively.</figcaption></figure><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="11d8af90-2577-8072-9964-ea62525dbcd5" class="code"><code class="language-Plain Text">keep if year==1978 | year==2022
reshape wide gdp exchange, i(countryid country) j(year)
drop if gdp1978 ==. | gdp2022 ==.
egen gdp1978rank = rank(gdp1978)
egen gdp2022rank = rank(gdp2022)
if 1 {
gen county_en = &quot;&quot;
replace county_en = &quot;CHN&quot; if country == &quot;中国&quot;
replace county_en = &quot;USA&quot; if country == &quot;美国&quot;
* replace county_en = &quot;GBR&quot; if country == &quot;英国&quot;  
* replace county_en = &quot;FRA&quot; if country == &quot;法国&quot;  
* replace county_en = &quot;DEU&quot; if country == &quot;德国&quot;  
* replace county_en = &quot;ITA&quot; if country == &quot;意大利&quot;  
* replace county_en = &quot;KOR&quot; if country == &quot;韩国&quot;  
* replace county_en = &quot;JPN&quot; if country == &quot;日本&quot;  
* replace county_en = &quot;IND&quot; if country == &quot;印度&quot;
replace county_en = &quot;PRK&quot; if country == &quot;朝鲜&quot;  
replace county_en = &quot;IRN&quot; if country == &quot;伊朗&quot;
replace county_en = &quot;VNM&quot; if country == &quot;越南&quot;  
replace county_en = &quot;SGP&quot; if country == &quot;新加坡&quot;
}
if 1 {
gen continent = &quot;&quot;
* 亚洲国家
replace continent = &quot;Asia&quot; if regexm(&quot;阿富汗, 阿尔巴尼亚, 孟加拉, 不丹, 中国, 卡塔尔, 中国香港, 中国澳门, 越南, 柬埔寨, 印度, 印度尼西亚, 伊朗, 伊拉克, 以色列, 日本, 约旦, 朝鲜, 韩国, 科威特, 老挝, 黎巴嫩, 马来西亚, 马尔代夫, 马里, 蒙古, 缅甸, 尼泊尔, 阿曼, 巴基斯坦, 菲律宾, 沙特阿拉伯, 新加坡, 斯里兰卡, 叙利亚, 泰国, 土耳其, 阿联酋, 也门&quot;, country)
* 非洲国家
replace continent = &quot;Africa&quot; if regexm(&quot;阿尔及利亚, 安哥拉, 贝宁, 博茨瓦纳, 布隆迪, 喀麦隆, 乍得, 中非共和国, 刚果(布), 刚果(金), 科特迪瓦, 埃及, 赤道几内亚, 厄立特里亚, 埃塞俄比亚, 加蓬, 冈比亚, 加纳, 几内亚, 几内亚比绍, 肯尼亚, 利比里亚, 利比亚, 马达加斯加, 马拉维, 毛里塔尼亚, 毛里求斯, 摩洛哥, 莫桑比克, 纳米比亚, 尼日尔, 尼日利亚, 卢旺达, 塞内加尔, 塞舌尔, 塞拉利昂, 索马里, 南非, 苏丹, 斯威士兰, 坦噶尼喀, 多哥, 突尼斯, 乌干达, 赞比亚&quot;, country)
* 欧洲国家
replace continent = &quot;Europe&quot; if regexm(&quot;安道尔, 奥地利, 比利时, 保加利亚, 塞浦路斯, 丹麦, 芬兰, 法国, 德国, 希腊, 匈牙利, 冰岛, 爱尔兰, 意大利, 卢森堡, 马耳他, 摩纳哥, 荷兰, 挪威, 波兰, 葡萄牙, 罗马尼亚, 西班牙, 瑞典, 瑞士, 英国&quot;, country)
* 北美洲国家
replace continent = &quot;North America&quot; if regexm(&quot;巴哈马, 巴巴多斯, 百慕大, 加拿大, 哥斯达黎加, 古巴, 多米尼克, 多米尼加共和国, 萨尔瓦多, 格林纳达, 危地马拉, 海地, 洪都拉斯, 墨西哥, 美国, 巴拿马, 圣基茨和尼维斯, 安圭拉, 圣卢西亚, 圣文森特和格林纳丁斯, 特立尼达和多巴哥&quot;, country)
* 南美洲国家
replace continent = &quot;South America&quot; if regexm(&quot;阿根廷, 玻利维亚, 巴西, 智利, 哥伦比亚, 厄瓜多尔, 圭亚那, 巴拉圭, 秘鲁, 苏里南, 乌拉圭, 委内瑞拉&quot;, country)
* 大洋洲国家
replace continent = &quot;Oceania&quot; if regexm(&quot;澳大利亚, 所罗门群岛, 英属维尔京群岛, 文莱, 库克群岛, 斐济, 法属波利尼西亚, 吉布提, 基里巴斯, 马绍尔群岛, 密克罗尼西亚联邦, 瑙鲁, 新西兰, 尼加拉瓜, 帕劳, 巴布亚新几内亚, 萨摩亚, 图瓦卢, 瓦努阿图&quot;, country)  
* list country if continent == &quot;&quot;
}


// plot data
tw	(function y=x, range(-5 195) lp(long)lc(gs12)lw(0.1)) ///
	(sc gdp1978rank gdp2022rank if continent==&quot;Asia&quot;		 , m(oh) mcol(gs8)) /// 
	(sc gdp1978rank gdp2022rank if continent==&quot;Africa&quot;		 , m(dh) mcol(gs8)) /// 
	(sc gdp1978rank gdp2022rank if continent==&quot;Europe&quot;		 , m(th) mcol(gs8)) /// 
	(sc gdp1978rank gdp2022rank if continent==&quot;North America&quot;, m(dh) mcol(gs8)) /// 
	(sc gdp1978rank gdp2022rank if continent==&quot;South America&quot;, m(smplus) mcol(gs8)) /// 
	(sc gdp1978rank gdp2022rank if continent==&quot;Oceania&quot;		 , m(x ) mcol(gs8)) /// 
	(sc gdp1978rank gdp2022rank, m(i) mlab(county_en)) /// 
	, xlab() xscale(range(-10 200)) xtitle(&quot;GDP rank in 2022&quot;) ///
	ylab() yscale(range(-10 200)) ytitle(&quot;GDP rank in 1978&quot;) ///
	legend(order(2 &quot;Asia&quot; 3 &quot;Africa&quot; 4 &quot;Europe&quot; 5 &quot;North America&quot; 6 &quot;South America&quot; 7 &quot;Oceania&quot;)size(small)position(10)ring(0)region(fc(none))) ///
	xsize(20)ysize(16)graphregion(fcolor(none)lcolor(none)ifcolor(none)ilcolor(none))plotregion(margin(zero)) 
*</code></pre><h3 id="11d8af90-2577-807c-a306-fa60cfeef8c8" class="">散点图—添加拟合线</h3><figure id="11d8af90-2577-8088-8ad2-ec1d5f9013c5" class="image" style="text-align:center"><a href="image%202.png"><img style="width:531px" src="image%202.png"/></a><figcaption><strong>Cross-country inflation and interest rate</strong><br/><br/><em>Notes</em>. The inflation and interest rate data are collected from CSMAR and IMF respectively. The CPI reflects changes in consumer prices relative to the base period (=100 in 2000). The interest rate is calculated as the median of monthly interest rates for each year.</figcaption></figure><script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js" integrity="sha512-7Z9J3l1+EYfeaPKcGXu3MS/7T+w19WtKQY/n+xzmw4hZhJ9tyYmcUS+4QqAlzhicE5LAfMQSF3iFTK9bQdTxXg==" crossorigin="anonymous" referrerPolicy="no-referrer"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" integrity="sha512-tN7Ec6zAFaVSG3TpNAKtk4DOHNpSwKHxxrsiw4GHKESGPs5njn/0sMCUMl2svV4wo4BK/rCP7juYz+zx+l6oeQ==" crossorigin="anonymous" referrerPolicy="no-referrer"/><pre id="11d8af90-2577-80bd-a327-ea265893abf3" class="code"><code class="language-Plain Text">tw	(qfit interest cpi1 if year==2002, lp(shortdash_dot) lc(gs8) lw(0.1)) ///
	(qfit interest cpi1 if year==2009, lp(dash) lc(gs8) lw(0.1)) ///
	(qfit interest cpi1 if year==2022, lp(long) lc(gs8) lw(0.1)) ///
	(sc interest cpi1 if year==2002, m(x) mcol(gs8)) ///
	(sc interest cpi1 if year==2009, m(oh) mcol(gs8)) ///
	(sc interest cpi1 if year==2022, m(o ) mcol(gs8%50)) ///
	, xscale(range(90 550)) xtitle(&quot;CPI&quot;) /// xlab()
	yscale(range(-1 51)) ytitle(&quot;Interest rate&quot;) ///ylab()
	legend(col(2)order(4 &quot;2002&quot; 1 &quot;Quadratic prediction&quot; 5 &quot;2009&quot; 2 &quot;Quadratic prediction&quot; 6 &quot;2022&quot; 3 &quot;Quadratic prediction&quot;)size(small)position(2)ring(0)region(fc(none))) ///
	xsize(20)ysize(16)graphregion(fcolor(none)lcolor(none)ifcolor(none)ilcolor(none))plotregion(margin(zero)) 
*</code></pre><p id="11d8af90-2577-80ce-bbbb-e16b6fdfbebc" class="">
</p><p id="11d8af90-2577-80ff-9be6-ef12c5e037da" class="">
</p><p id="11d8af90-2577-8039-952f-f44f74937c39" class="">
</p><figure id="2752d11e-9e5f-4e35-8852-20ef7fc0e638" class="image" style="text-align:center"><a href="Graph%202.svg"><img src="Graph%202.svg"/></a></figure><h1 id="266ceb25-3fbe-4c14-a008-3302c2e09d27" class="">Inference in network model</h1><p id="611f5c20-9b94-4fc4-a11b-12853f68724c" class="">
</p><p id="dce7e922-cdaf-4956-96a5-65e1beea19a8" class="">
</p><p id="a45ddfe6-8e58-4013-bb24-7ea9449b833d" class="">
</p></div></article><span class="sans" style="font-size:14px;padding-top:2em"></span></body></html>